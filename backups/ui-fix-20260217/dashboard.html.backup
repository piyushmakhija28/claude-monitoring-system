{% extends "base.html" %}

{% block title %}Dashboard - Claude Insight{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header mb-4">
    <h1 class="page-title">
        <i class="fas fa-tachometer-alt me-3"></i>
        System Dashboard
    </h1>
    <div class="page-subtitle">Real-time monitoring and analytics</div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div class="d-flex gap-2 flex-wrap">
                <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#widgetCustomizeModal">
                    <i class="fas fa-cog me-2"></i>Customize
                </button>
                <button class="btn btn-outline-info" onclick="resetWidgetOrder()" title="Reset widget order to default">
                    <i class="fas fa-undo me-2"></i>Reset Order
                </button>
                <a href="{{ url_for('export_metrics') }}" class="btn btn-success">
                    <i class="fas fa-download me-2"></i>Export Metrics
                </a>
                <button class="btn btn-outline-primary" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt me-2"></i>Refresh
                </button>
                <span class="badge bg-success fs-6" id="autoRefreshBadge">
                    <i class="fas fa-circle-notch fa-spin me-1"></i>Auto-refresh: 30s
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Sortable Widgets Container -->
<div id="sortableWidgets">

<!-- System Health Metrics -->
{% if widget_preferences.get('system_health', True) %}
<div class="row mb-4" id="systemHealthWidget">
    <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-heartbeat stat-icon text-success"></i>
                <div class="stat-value text-success" id="healthScore">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <div class="stat-label">Health Score</div>
                <div class="progress mt-3" style="height: 6px; border-radius: 10px; background: rgba(16, 185, 129, 0.1);">
                    <div class="progress-bar bg-success" id="healthScoreBar" role="progressbar" style="width: 0%; border-radius: 10px;"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-server stat-icon text-primary"></i>
                <div class="stat-value text-primary" id="daemonsRunning">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <div class="stat-label">Daemons Running</div>
                <small class="text-muted mt-2 d-block" id="daemonStatus">Checking...</small>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-shield-alt stat-icon text-info"></i>
                <div class="stat-value text-info" id="activePolicies">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <div class="stat-label">Active Policies</div>
                <small class="text-muted mt-2 d-block">Out of 6 total</small>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-chart-line stat-icon text-warning"></i>
                <div class="stat-value text-warning" id="policyHits">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <div class="stat-label">Policy Hits Today</div>
                <small class="text-muted mt-2 d-block">Last 24 hours</small>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Live Metrics and Activity Feed -->
<div class="row mb-4">
    <div class="col-lg-8 mb-4 mb-lg-0">
        <div class="card h-100">
            <div class="card-header">
                <h5>
                    <i class="fas fa-chart-line"></i>
                    Live Metrics
                </h5>
            </div>
            <div class="card-body">
                <canvas id="metricsChart" height="100"></canvas>
            </div>
        </div>
    </div>
    {% if widget_preferences.get('recent_activity', True) %}
    <div class="col-lg-4" id="recentActivityWidget">
        <div class="card h-100">
            <div class="card-header">
                <h5>
                    <i class="fas fa-clock"></i>
                    Recent Activity
                </h5>
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                <div id="activityFeed">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                        <p>Loading activity...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Historical Trends -->
{% if widget_preferences.get('historical_charts', True) %}
<div class="row mb-4" id="historicalChartsWidget">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                    <h5>
                        <i class="fas fa-chart-area"></i>
                        Historical Trends
                    </h5>

                    <!-- Time Range Filter -->
                    <div class="btn-group" role="group" aria-label="Time range filter">
                        <a href="?days=7" class="btn btn-sm btn-outline-primary {{ 'active' if selected_days == 7 else '' }}">
                            7 Days
                        </a>
                        <a href="?days=30" class="btn btn-sm btn-outline-primary {{ 'active' if selected_days == 30 else '' }}">
                            30 Days
                        </a>
                        <a href="?days=60" class="btn btn-sm btn-outline-primary {{ 'active' if selected_days == 60 else '' }}">
                            60 Days
                        </a>
                        <a href="?days=90" class="btn btn-sm btn-outline-primary {{ 'active' if selected_days == 90 else '' }}">
                            90 Days
                        </a>
                    </div>

                    <span class="badge bg-info">
                        <i class="fas fa-calendar-alt me-1"></i>Last {{ selected_days }} Days
                    </span>
                </div>
            </div>
            <div class="card-body">
                <!-- Summary Stats -->
                <div class="row mb-4 text-center">
                    <div class="col-md-3">
                        <div class="p-3 bg-light rounded">
                            <h4 class="text-primary mb-1">{{ summary_stats.avg_health_score }}%</h4>
                            <small class="text-muted">Avg Health Score</small>
                            {% if summary_stats.trend == 'up' %}
                            <i class="fas fa-arrow-up text-success ms-2" title="Improving"></i>
                            {% elif summary_stats.trend == 'down' %}
                            <i class="fas fa-arrow-down text-danger ms-2" title="Declining"></i>
                            {% else %}
                            <i class="fas fa-minus text-muted ms-2" title="Stable"></i>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3 bg-light rounded">
                            <h4 class="text-danger mb-1">{{ summary_stats.total_errors }}</h4>
                            <small class="text-muted">Total Errors</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3 bg-light rounded">
                            <h4 class="text-success mb-1">{{ summary_stats.total_policy_hits }}</h4>
                            <small class="text-muted">Policy Hits</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3 bg-light rounded">
                            <h4 class="text-info mb-1">{{ summary_stats.avg_context_usage }}%</h4>
                            <small class="text-muted">Avg Context Usage</small>
                        </div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <h6 class="text-muted mb-3"><i class="fas fa-heartbeat me-2"></i>Health Score Trend</h6>
                        <canvas id="healthScoreChart" height="200"></canvas>
                    </div>
                    <div class="col-md-6 mb-3">
                        <h6 class="text-muted mb-3"><i class="fas fa-exclamation-circle me-2"></i>Daily Errors</h6>
                        <canvas id="errorsChart" height="200"></canvas>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted mb-3"><i class="fas fa-shield-alt me-2"></i>Policy Hits</h6>
                        <canvas id="policyHitsChart" height="200"></canvas>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted mb-3"><i class="fas fa-percentage me-2"></i>Context Usage</h6>
                        <canvas id="contextUsageChart" height="200"></canvas>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted mb-3"><i class="fas fa-robot me-2"></i>Model Usage Distribution</h6>
                        <canvas id="modelUsageChart" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Policy Execution Tracking -->
<div class="row mb-4">
    <div class="col-lg-8 mb-4 mb-lg-0">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <h5>
                        <i class="fas fa-chart-line"></i>
                        Policy Execution Timeline
                    </h5>
                    <span class="badge bg-success" id="policyHealthBadge">Loading...</span>
                </div>
            </div>
            <div class="card-body">
                <canvas id="policyExecutionTimelineChart" height="80"></canvas>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Shows when automation policies are actually executed (not just running daemons)
                    </small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5>
                    <i class="fas fa-tasks"></i>
                    Enforcement Steps
                </h5>
            </div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                <div id="enforcementSteps">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                        <p>Loading enforcement status...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Policy Executions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>
                    <i class="fas fa-history"></i>
                    Recent Policy Executions
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Policy</th>
                                <th>Category</th>
                                <th>Status</th>
                                <th>Message</th>
                            </tr>
                        </thead>
                        <tbody id="recentExecutionsTable">
                            <tr>
                                <td colspan="5" class="text-center text-muted">
                                    <i class="fas fa-spinner fa-spin"></i> Loading...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Policy Status Cards -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>
                    <i class="fas fa-shield-alt"></i>
                    Policy Status Overview
                </h5>
            </div>
            <div class="card-body">
                <div class="row" id="policyCards">
                    <div class="col-12 text-center text-muted py-4">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                        <p>Loading policies...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Information -->
<div class="row">
    <div class="col-lg-6 mb-4 mb-lg-0">
        <div class="card">
            <div class="card-header">
                <h5>
                    <i class="fas fa-info-circle"></i>
                    System Information
                </h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tbody id="systemInfo">
                        <tr>
                            <td class="text-muted">Status:</td>
                            <td><i class="fas fa-spinner fa-spin"></i> Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5>
                    <i class="fas fa-exclamation-triangle"></i>
                    Recent Errors
                </h5>
            </div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                <div id="recentErrors">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                        <p>Loading errors...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

</div>
<!-- End Sortable Widgets Container -->

<!-- Widget Customization Modal -->
<div class="modal fade" id="widgetCustomizeModal" tabindex="-1" aria-labelledby="widgetCustomizeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="widgetCustomizeModalLabel">
                    <i class="fas fa-cog me-2"></i>Customize Dashboard Widgets
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small mb-3">
                    <i class="fas fa-info-circle me-1"></i>
                    Select which widgets you want to display on your dashboard
                </p>

                <div class="list-group">
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-heartbeat text-success me-2"></i>
                            <strong>System Health</strong>
                            <br><small class="text-muted">Health score, daemons, context usage</small>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="widget_system_health" checked>
                        </div>
                    </div>

                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-server text-primary me-2"></i>
                            <strong>Daemon Status</strong>
                            <br><small class="text-muted">Status of all running daemons</small>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="widget_daemon_status" checked>
                        </div>
                    </div>

                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-shield-alt text-info me-2"></i>
                            <strong>Policy Status</strong>
                            <br><small class="text-muted">Active policies and their status</small>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="widget_policy_status" checked>
                        </div>
                    </div>

                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-chart-area text-warning me-2"></i>
                            <strong>Historical Charts</strong>
                            <br><small class="text-muted">7/30/60/90 day trend charts</small>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="widget_historical_charts" checked>
                        </div>
                    </div>

                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-list text-secondary me-2"></i>
                            <strong>Recent Activity</strong>
                            <br><small class="text-muted">Recent system activities and logs</small>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="widget_recent_activity" checked>
                        </div>
                    </div>

                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                            <strong>Recent Errors</strong>
                            <br><small class="text-muted">Latest system errors</small>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="widget_recent_errors" checked>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveWidgetPreferences()">
                    <i class="fas fa-save me-2"></i>Save Preferences
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
let metricsChart;
let autoRefreshInterval;
let socket;
let isWebSocketConnected = false;

document.addEventListener('DOMContentLoaded', function() {
    initializeDashboard();
    initializeWebSocket();
    initializeSortableWidgets();
    // Only start auto-refresh as fallback if WebSocket fails
});

function initializeDashboard() {
    loadMetrics();
    loadActivityFeed();
    loadPolicyStatus();
    loadSystemInfo();
    loadRecentErrors();
    initializeChart();
}

function loadMetrics() {
    fetch('/api/metrics')
        .then(response => response.json())
        .then(data => {
            // Update health score
            const healthScore = data.health_score || 0;
            document.getElementById('healthScore').innerHTML = `
                <span class="text-${getHealthColor(healthScore)}">${healthScore}%</span>
            `;
            document.getElementById('healthScoreBar').style.width = healthScore + '%';
            document.getElementById('healthScoreBar').className = `progress-bar bg-${getHealthColor(healthScore)} bg-gradient`;

            // Update daemons
            const daemonsRunning = data.daemons_running || 0;
            const totalDaemons = data.total_daemons || 0;
            document.getElementById('daemonsRunning').innerHTML = `
                <span class="text-${daemonsRunning === totalDaemons ? 'success' : 'warning'}">${daemonsRunning}/${totalDaemons}</span>
            `;
            document.getElementById('daemonStatus').textContent = daemonsRunning === totalDaemons ? 'All systems operational' : 'Some daemons offline';

            // Update active policies
            const activePolicies = data.active_policies || 0;
            document.getElementById('activePolicies').innerHTML = `
                <span class="text-primary">${activePolicies}/6</span>
            `;

            // Update policy hits
            const policyHits = data.policy_hits_today || 0;
            document.getElementById('policyHits').innerHTML = `
                <span class="text-info">${policyHits}</span>
            `;

            // Update chart
            if (metricsChart && data.metrics_history) {
                updateChart(data.metrics_history);
            }
        })
        .catch(error => {
            console.error('Error loading metrics:', error);
            showError('Failed to load metrics');
        });
}

function loadActivityFeed() {
    fetch('/api/activity')
        .then(response => response.json())
        .then(data => {
            const feedContainer = document.getElementById('activityFeed');
            if (!data.activities || data.activities.length === 0) {
                feedContainer.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-2x mb-3"></i>
                        <p>No recent activity</p>
                    </div>
                `;
                return;
            }

            feedContainer.innerHTML = data.activities.map(activity => `
                <div class="activity-item mb-3 pb-3 border-bottom">
                    <div class="d-flex align-items-start">
                        <div class="flex-shrink-0">
                            <span class="badge bg-${getActivityColor(activity.type)} rounded-circle p-2">
                                <i class="fas ${getActivityIcon(activity.type)}"></i>
                            </span>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <p class="mb-1 small">${activity.message}</p>
                            <small class="text-muted">
                                <i class="far fa-clock me-1"></i>${activity.timestamp}
                            </small>
                        </div>
                    </div>
                </div>
            `).join('');
        })
        .catch(error => {
            console.error('Error loading activity:', error);
            document.getElementById('activityFeed').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Failed to load activity feed
                </div>
            `;
        });
}

function loadPolicyStatus() {
    fetch('/api/policies')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('policyCards');
            if (!data.policies || data.policies.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center text-muted py-4">
                        <i class="fas fa-exclamation-circle fa-2x mb-3"></i>
                        <p>No policies found</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = data.policies.map(policy => `
                <div class="col-md-4 mb-3">
                    <div class="card border-0 bg-light h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="mb-0">${policy.name}</h6>
                                <span class="badge bg-${policy.status === 'active' ? 'success' : 'secondary'}">
                                    ${policy.status}
                                </span>
                            </div>
                            <p class="small text-muted mb-2">${policy.description || 'No description'}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    <i class="fas fa-check-circle me-1"></i>
                                    ${policy.hits || 0} hits
                                </small>
                                <small class="text-muted">
                                    Phase ${policy.phase || 'N/A'}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        })
        .catch(error => {
            console.error('Error loading policies:', error);
            document.getElementById('policyCards').innerHTML = `
                <div class="col-12">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Failed to load policy status
                    </div>
                </div>
            `;
        });
}

function loadSystemInfo() {
    fetch('/api/system-info')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('systemInfo');
            container.innerHTML = `
                <tr>
                    <td class="text-muted">Status:</td>
                    <td><span class="badge bg-success">Operational</span></td>
                </tr>
                <tr>
                    <td class="text-muted">Memory Path:</td>
                    <td><code>${data.memory_path || 'N/A'}</code></td>
                </tr>
                <tr>
                    <td class="text-muted">Last Update:</td>
                    <td>${data.last_update || 'Unknown'}</td>
                </tr>
                <tr>
                    <td class="text-muted">Uptime:</td>
                    <td>${data.uptime || 'N/A'}</td>
                </tr>
            `;
        })
        .catch(error => {
            console.error('Error loading system info:', error);
            document.getElementById('systemInfo').innerHTML = `
                <tr>
                    <td colspan="2">
                        <div class="alert alert-danger mb-0">
                            Failed to load system information
                        </div>
                    </td>
                </tr>
            `;
        });
}

function loadRecentErrors() {
    fetch('/api/recent-errors')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('recentErrors');
            if (!data.errors || data.errors.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-check-circle fa-2x mb-3 text-success"></i>
                        <p>No recent errors</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = data.errors.map(error => `
                <div class="alert alert-danger py-2 px-3 mb-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>${error.message}</strong>
                            <br>
                            <small class="text-muted">${error.timestamp}</small>
                        </div>
                        <span class="badge bg-danger">${error.level}</span>
                    </div>
                </div>
            `).join('');
        })
        .catch(error => {
            console.error('Error loading recent errors:', error);
            document.getElementById('recentErrors').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Failed to load recent errors
                </div>
            `;
        });
}

function initializeChart() {
    const ctx = document.getElementById('metricsChart').getContext('2d');
    metricsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Health Score',
                data: [],
                borderColor: 'rgb(102, 126, 234)',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Policy Hits',
                data: [],
                borderColor: 'rgb(118, 75, 162)',
                backgroundColor: 'rgba(118, 75, 162, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
}

function updateChart(data) {
    if (!metricsChart || !data) return;

    metricsChart.data.labels = data.labels || [];
    metricsChart.data.datasets[0].data = data.health_scores || [];
    metricsChart.data.datasets[1].data = data.policy_hits || [];
    metricsChart.update();
}

function refreshDashboard() {
    const btn = event.target.closest('button');
    const icon = btn.querySelector('i');
    icon.classList.add('fa-spin');

    initializeDashboard();

    setTimeout(() => {
        icon.classList.remove('fa-spin');
    }, 1000);
}

function startAutoRefresh() {
    autoRefreshInterval = setInterval(() => {
        loadMetrics();
        loadActivityFeed();
        loadRecentErrors();
    }, 30000); // Refresh every 30 seconds
}

function getHealthColor(score) {
    if (score >= 80) return 'success';
    if (score >= 60) return 'warning';
    return 'danger';
}

function getActivityColor(type) {
    const colors = {
        'policy': 'primary',
        'error': 'danger',
        'warning': 'warning',
        'success': 'success',
        'info': 'info'
    };
    return colors[type] || 'secondary';
}

function getActivityIcon(type) {
    const icons = {
        'policy': 'fa-shield-alt',
        'error': 'fa-exclamation-circle',
        'warning': 'fa-exclamation-triangle',
        'success': 'fa-check-circle',
        'info': 'fa-info-circle'
    };
    return icons[type] || 'fa-circle';
}

function showError(message) {
    console.error(message);
}

// Initialize Historical Charts
function initializeHistoricalCharts() {
    try {
        const chartData = {{ chart_data | tojson | safe }};

        if (!chartData || !chartData.dates || chartData.dates.length === 0) {
            console.warn('No historical data available');
            // Hide chart containers or show placeholder
            const chartContainers = document.querySelectorAll('.col-md-6 canvas');
            chartContainers.forEach(canvas => {
                const parent = canvas.parentElement;
                if (parent) {
                    parent.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-chart-line fa-2x mb-2"></i>
                            <p class="small">No historical data available yet</p>
                        </div>
                    `;
                }
            });
            return;
        }

        const labels = chartData.dates.map(date => {
            const d = new Date(date);
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });

    // Common chart options
    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                min: 0,
                ticks: {
                    stepSize: 10,
                    callback: function(value) {
                        return Math.max(0, value);
                    }
                },
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                }
            },
            x: {
                grid: {
                    display: false
                }
            }
        }
    };

    // Health Score Chart
    try {
        const healthCanvas = document.getElementById('healthScoreChart');
        if (healthCanvas) {
            new Chart(healthCanvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Health Score',
                        data: chartData.health_scores || [],
                        borderColor: 'rgb(16, 185, 129)',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y: {
                            ...commonOptions.scales.y,
                            min: 0,
                            max: 100,
                            ticks: {
                                stepSize: 20,
                                callback: function(value) {
                                    return Math.max(0, Math.min(100, value));
                                }
                            }
                        }
                    }
                }
            });
        }
    } catch (error) {
        console.error('Error creating health score chart:', error);
    }

    // Errors Chart
    try {
        const errorsCanvas = document.getElementById('errorsChart');
        if (errorsCanvas) {
            new Chart(errorsCanvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Errors',
                        data: chartData.errors || [],
                        backgroundColor: 'rgba(239, 68, 68, 0.7)',
                        borderColor: 'rgb(239, 68, 68)',
                        borderWidth: 1
                    }]
                },
                options: commonOptions
            });
        }
    } catch (error) {
        console.error('Error creating errors chart:', error);
    }

    // Policy Hits Chart
    try {
        const policyCanvas = document.getElementById('policyHitsChart');
        if (policyCanvas) {
            new Chart(policyCanvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Policy Hits',
                        data: chartData.policy_hits || [],
                        borderColor: 'rgb(99, 102, 241)',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: commonOptions
            });
        }
    } catch (error) {
        console.error('Error creating policy hits chart:', error);
    }

    // Context Usage Chart
    try {
        const contextCanvas = document.getElementById('contextUsageChart');
        if (contextCanvas) {
            new Chart(contextCanvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Context Usage %',
                        data: chartData.context_usage || [],
                        borderColor: 'rgb(245, 158, 11)',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y: {
                            ...commonOptions.scales.y,
                            min: 0,
                            max: 100,
                            ticks: {
                                stepSize: 20,
                                callback: function(value) {
                                    return Math.max(0, Math.min(100, value)) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
    } catch (error) {
        console.error('Error creating context usage chart:', error);
    }
    } catch (error) {
        console.error('Error initializing historical charts:', error);
    }
}

// Initialize Model Usage Chart
function initializeModelUsageChart() {
    fetch('/api/model-usage')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const canvas = document.getElementById('modelUsageChart');
                if (canvas) {
                    new Chart(canvas.getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: ['Haiku', 'Sonnet', 'Opus'],
                            datasets: [{
                                data: data.usage || [0, 0, 0],
                                backgroundColor: [
                                    'rgba(99, 102, 241, 0.8)',  // Haiku - Blue
                                    'rgba(139, 92, 246, 0.8)',  // Sonnet - Purple
                                    'rgba(236, 72, 153, 0.8)'   // Opus - Pink
                                ],
                                borderWidth: 2,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        padding: 15,
                                        usePointStyle: true,
                                        font: {
                                            size: 12
                                        }
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.parsed || 0;
                                            const percentage = data.percentage_data[context.dataIndex] || 0;
                                            return `${label}: ${value} requests (${percentage.toFixed(1)}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }
        })
        .catch(error => {
            console.error('Error loading model usage data:', error);
        });
}

// Initialize Policy Execution Tracking
function initializePolicyExecutionTracking() {
    // Fetch enforcement status
    fetch('/api/enforcement-status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateEnforcementSteps(data.enforcement);
                updatePolicyHealth(data.health);
            }
        })
        .catch(error => {
            console.error('Error loading enforcement status:', error);
        });

    // Fetch policy timeline
    fetch('/api/policy-timeline?hours=24')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                createPolicyTimelineChart(data.timeline);
                updateRecentExecutions(data.recent_executions);
            }
        })
        .catch(error => {
            console.error('Error loading policy timeline:', error);
        });
}

function updateEnforcementSteps(enforcement) {
    const container = document.getElementById('enforcementSteps');
    if (!container || !enforcement || !enforcement.steps) return;

    let html = '';
    enforcement.steps.forEach(step => {
        const icon = step.completed ?
            '<i class="fas fa-check-circle text-success me-2"></i>' :
            '<i class="fas fa-circle text-secondary me-2"></i>';

        const layerColors = {
            'SYNC': 'primary',
            'STANDARDS': 'success',
            'EXECUTION': 'danger'
        };

        const layerColor = layerColors[step.layer] || 'secondary';

        html += `
            <div class="mb-3 p-2 border-start border-${layerColor} border-3">
                <div class="d-flex align-items-center">
                    ${icon}
                    <div class="flex-grow-1">
                        <strong>${step.name}</strong>
                        <small class="text-muted ms-2">
                            <span class="badge bg-${layerColor}">${step.layer}</span>
                        </small>
                    </div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

function updatePolicyHealth(health) {
    const badge = document.getElementById('policyHealthBadge');
    if (!badge || !health) return;

    const statusClasses = {
        'EXCELLENT': 'bg-success',
        'GOOD': 'bg-info',
        'FAIR': 'bg-warning',
        'POOR': 'bg-danger'
    };

    badge.className = `badge ms-2 ${statusClasses[health.status] || 'bg-secondary'}`;
    badge.textContent = `${health.status} (${health.health_score}/100)`;
}

function createPolicyTimelineChart(timeline) {
    try {
        const canvas = document.getElementById('policyExecutionTimelineChart');
        if (!canvas || !timeline) return;

        new Chart(canvas.getContext('2d'), {
            type: 'line',
            data: {
                labels: timeline.labels || [],
                datasets: [{
                    label: 'Policy Executions',
                    data: timeline.data || [],
                    borderColor: 'rgb(99, 102, 241)',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        min: 0,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error creating policy timeline chart:', error);
    }
}

function updateRecentExecutions(executions) {
    const tbody = document.getElementById('recentExecutionsTable');
    if (!tbody || !executions) return;

    if (executions.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted">No recent policy executions</td>
            </tr>
        `;
        return;
    }

    let html = '';
    executions.forEach(exec => {
        const timestamp = new Date(exec.timestamp);
        const timeStr = timestamp.toLocaleTimeString();

        const statusBadges = {
            'OK': 'success',
            'CHECK': 'success',
            'SKIP': 'warning',
            'ERROR': 'danger',
            'SLEEP': 'secondary'
        };

        const badgeClass = statusBadges[exec.status] || 'secondary';

        html += `
            <tr>
                <td><small>${timeStr}</small></td>
                <td><code>${exec.policy_name}</code></td>
                <td><span class="badge bg-info">${exec.policy_category}</span></td>
                <td><span class="badge bg-${badgeClass}">${exec.status}</span></td>
                <td><small class="text-muted">${exec.message}</small></td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
}

// Call this after page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeHistoricalCharts();
    initializeModelUsageChart();
    initializePolicyExecutionTracking();
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
});

// Widget Customization Functions
function loadWidgetPreferences() {
    fetch('/api/widget-preferences')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const prefs = data.preferences;

                // Update checkboxes in modal
                document.getElementById('widget_system_health').checked = prefs.system_health !== false;
                document.getElementById('widget_daemon_status').checked = prefs.daemon_status !== false;
                document.getElementById('widget_policy_status').checked = prefs.policy_status !== false;
                document.getElementById('widget_historical_charts').checked = prefs.historical_charts !== false;
                document.getElementById('widget_recent_activity').checked = prefs.recent_activity !== false;
                document.getElementById('widget_recent_errors').checked = prefs.recent_errors !== false;
            }
        })
        .catch(error => {
            console.error('Error loading widget preferences:', error);
        });
}

function saveWidgetPreferences() {
    const preferences = {
        system_health: document.getElementById('widget_system_health').checked,
        daemon_status: document.getElementById('widget_daemon_status').checked,
        policy_status: document.getElementById('widget_policy_status').checked,
        historical_charts: document.getElementById('widget_historical_charts').checked,
        recent_activity: document.getElementById('widget_recent_activity').checked,
        recent_errors: document.getElementById('widget_recent_errors').checked
    };

    fetch('/api/widget-preferences', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ preferences: preferences })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('widgetCustomizeModal'));
            modal.hide();

            // Show success message
            showToast('Success', 'Widget preferences saved successfully!', 'success');

            // Reload page to apply changes
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showToast('Error', 'Failed to save preferences: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error saving widget preferences:', error);
        showToast('Error', 'Failed to save preferences', 'danger');
    });
}

function showToast(title, message, type) {
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        toastContainer.style.zIndex = '11';
        document.body.appendChild(toastContainer);
    }

    const toastId = 'toast_' + Date.now();
    const bgClass = type === 'success' ? 'bg-success' : (type === 'danger' ? 'bg-danger' : 'bg-info');

    const toastHtml = `
        <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <strong>${title}</strong><br>${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;

    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
    toast.show();

    // Remove toast after it's hidden
    toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
    });
}

// Load widget preferences when modal is opened
document.getElementById('widgetCustomizeModal')?.addEventListener('show.bs.modal', function() {
    loadWidgetPreferences();
});

// ============================================================
// WebSocket Real-time Updates
// ============================================================

function initializeWebSocket() {
    console.log('Initializing WebSocket connection...');

    // Connect to WebSocket server
    socket = io();

    // Connection established
    socket.on('connect', function() {
        console.log(' WebSocket connected!');
        isWebSocketConnected = true;
        updateConnectionStatus(true);

        // Stop polling if it's running
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
    });

    // Connection error
    socket.on('connect_error', function(error) {
        console.error(' WebSocket connection error:', error);
        isWebSocketConnected = false;
        updateConnectionStatus(false);

        // Fallback to polling
        if (!autoRefreshInterval) {
            console.log('Falling back to HTTP polling...');
            startAutoRefresh();
        }
    });

    // Disconnected
    socket.on('disconnect', function() {
        console.log(' WebSocket disconnected');
        isWebSocketConnected = false;
        updateConnectionStatus(false);

        // Fallback to polling
        if (!autoRefreshInterval) {
            console.log('Falling back to HTTP polling...');
            startAutoRefresh();
        }
    });

    // Receive metrics updates
    socket.on('metrics_update', function(data) {
        console.log(' Received real-time metrics:', data);
        updateDashboardWithWebSocketData(data);
    });

    // Connection response
    socket.on('connection_response', function(data) {
        console.log('Connection response:', data);
    });

    // Error handling
    socket.on('error', function(error) {
        console.error('WebSocket error:', error);
    });
}

function updateConnectionStatus(connected) {
    const badge = document.getElementById('autoRefreshBadge');
    if (badge) {
        if (connected) {
            badge.innerHTML = '<i class="fas fa-bolt me-1"></i>Real-time: WebSocket';
            badge.className = 'badge bg-success fs-6';
        } else {
            badge.innerHTML = '<i class="fas fa-sync-alt fa-spin me-1"></i>Auto-refresh: 30s';
            badge.className = 'badge bg-warning fs-6';
        }
    }
}

function updateDashboardWithWebSocketData(data) {
    try {
        // Update health score
        const healthScoreEl = document.getElementById('healthScore');
        if (healthScoreEl) {
            healthScoreEl.innerHTML = `
                <div class="text-${getHealthColor(data.health_score)}">${data.health_score}%</div>
            `;
        }

        // Update health score bar
        const healthScoreBar = document.getElementById('healthScoreBar');
        if (healthScoreBar) {
            healthScoreBar.style.width = data.health_score + '%';
            healthScoreBar.className = `progress-bar bg-gradient bg-${getHealthColor(data.health_score)}`;
        }

        // Update daemons
        const daemonsEl = document.getElementById('daemonsRunning');
        if (daemonsEl) {
            daemonsEl.innerHTML = `
                <div class="text-${data.daemons_running === data.daemons_total ? 'success' : 'warning'}">
                    ${data.daemons_running}/${data.daemons_total}
                </div>
            `;
        }

        const daemonStatusEl = document.getElementById('daemonStatus');
        if (daemonStatusEl) {
            daemonStatusEl.textContent = data.daemons_running === data.daemons_total ? 'All Running' : 'Some Stopped';
        }

        // Update active policies
        const policiesEl = document.getElementById('activePolicies');
        if (policiesEl) {
            policiesEl.innerHTML = `<div class="text-info">${data.active_policies}</div>`;
        }

        console.log(' Dashboard updated with real-time data');
    } catch (error) {
        console.error('Error updating dashboard with WebSocket data:', error);
    }
}

function getHealthColor(score) {
    if (score >= 90) return 'success';
    if (score >= 70) return 'warning';
    return 'danger';
}

// ============================================================
// Drag-and-Drop Widget Reordering
// ============================================================

function initializeSortableWidgets() {
    const sortableContainer = document.getElementById('sortableWidgets');
    if (!sortableContainer) return;

    // Load saved widget order
    const savedOrder = localStorage.getItem('widgetOrder');
    if (savedOrder) {
        applyWidgetOrder(JSON.parse(savedOrder));
    }

    // Initialize Sortable.js
    Sortable.create(sortableContainer, {
        animation: 150,
        handle: '.widget-drag-handle',
        ghostClass: 'widget-ghost',
        chosenClass: 'widget-chosen',
        dragClass: 'widget-drag',
        onEnd: function(evt) {
            console.log('Widget moved from', evt.oldIndex, 'to', evt.newIndex);
            saveWidgetOrder();
        }
    });

    // Add drag handles to all widgets
    addDragHandlesToWidgets();
}

function addDragHandlesToWidgets() {
    const widgets = document.querySelectorAll('#sortableWidgets > .row');
    widgets.forEach((widget, index) => {
        if (!widget.querySelector('.widget-drag-handle')) {
            // Add widget ID for tracking
            if (!widget.id) {
                widget.id = `widget-${index}`;
            }

            // Add drag handle
            const dragHandle = document.createElement('div');
            dragHandle.className = 'widget-drag-handle';
            dragHandle.innerHTML = '<i class="fas fa-grip-vertical"></i>';
            dragHandle.title = 'Drag to reorder';

            // Insert at the beginning of the widget
            widget.style.position = 'relative';
            widget.insertBefore(dragHandle, widget.firstChild);
        }
    });
}

function saveWidgetOrder() {
    const widgets = document.querySelectorAll('#sortableWidgets > .row');
    const order = Array.from(widgets).map(widget => widget.id);

    localStorage.setItem('widgetOrder', JSON.stringify(order));
    console.log('Widget order saved:', order);

    showToast('Success', 'Widget order saved!', 'success');
}

function applyWidgetOrder(order) {
    const container = document.getElementById('sortableWidgets');
    if (!container) return;

    const widgets = {};
    Array.from(container.children).forEach(widget => {
        if (widget.id) {
            widgets[widget.id] = widget;
        }
    });

    // Reorder widgets based on saved order
    order.forEach(widgetId => {
        if (widgets[widgetId]) {
            container.appendChild(widgets[widgetId]);
        }
    });

    console.log('Widget order applied:', order);
}

function resetWidgetOrder() {
    if (confirm('Reset all widgets to default order?')) {
        localStorage.removeItem('widgetOrder');
        location.reload();
    }
}
</script>

<style>
.activity-item:last-child {
    border-bottom: none !important;
    padding-bottom: 0 !important;
    margin-bottom: 0 !important;
}

.card {
    transition: transform 0.2s, box-shadow 0.2s;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}

#autoRefreshBadge {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.7;
    }
}

/* Drag-and-Drop Widget Styling */
.widget-drag-handle {
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 30px;
    height: 60px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 0 8px 8px 0;
    cursor: grab;
    opacity: 0;
    transition: opacity 0.3s, left 0.3s;
    z-index: 10;
    box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
}

.widget-drag-handle:hover {
    opacity: 1;
    left: 0;
}

.widget-drag-handle:active {
    cursor: grabbing;
}

.row:hover .widget-drag-handle {
    opacity: 0.7;
}

.widget-ghost {
    opacity: 0.4;
    background: #f0f0f0;
}

.widget-chosen {
    opacity: 0.8;
}

.widget-drag {
    opacity: 0.5;
    transform: rotate(2deg);
}

#sortableWidgets > .row {
    transition: transform 0.2s;
    cursor: move;
}

#sortableWidgets > .row:hover {
    transform: translateX(10px);
}
</style>
{% endblock %}
