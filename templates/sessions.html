{% extends "base.html" %}

{% block title %}Sessions - Claude Insight{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="mb-0"><i class="fas fa-history"></i> Session Tracking</h2>
        <p class="text-muted">Track and compare your Claude sessions</p>
    </div>
</div>

<!-- Current Session -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-circle text-success pulse"></i> Current Session</span>
                <span class="badge bg-success">Active</span>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <h6 class="text-muted mb-2">Session ID</h6>
                        <h4><span class="badge" style="background: linear-gradient(135deg, #667eea, #764ba2); font-size: 1rem;">
                            {{ current_session.session_id }}
                        </span></h4>
                    </div>
                    <div class="col-md-3">
                        <h6 class="text-muted mb-2">Duration</h6>
                        <h4><i class="fas fa-clock text-primary"></i> {{ current_session.duration_minutes }} min</h4>
                    </div>
                    <div class="col-md-3">
                        <h6 class="text-muted mb-2">Started At</h6>
                        <h5>{{ current_session.start_time | format_datetime }}</h5>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-danger" onclick="endSession()">
                            <i class="fas fa-stop"></i> End Session
                        </button>
                    </div>
                </div>

                <hr>

                <div class="row text-center">
                    <div class="col-md-2">
                        <div class="metric-box">
                            <i class="fas fa-check-circle text-success fa-2x mb-2"></i>
                            <h3>{{ current_session.metrics.policies_hit }}</h3>
                            <small class="text-muted">Policies Hit</small>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="metric-box">
                            <i class="fas fa-compress text-primary fa-2x mb-2"></i>
                            <h3>{{ current_session.metrics.context_optimizations }}</h3>
                            <small class="text-muted">Context Opts</small>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="metric-box">
                            <i class="fas fa-shield-alt text-success fa-2x mb-2"></i>
                            <h3>{{ current_session.metrics.failures_prevented }}</h3>
                            <small class="text-muted">Failures Prevented</small>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="metric-box">
                            <i class="fas fa-exchange-alt text-info fa-2x mb-2"></i>
                            <h3>{{ current_session.metrics.model_switches }}</h3>
                            <small class="text-muted">Model Switches</small>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="metric-box">
                            <i class="fas fa-coins text-warning fa-2x mb-2"></i>
                            <h3>{{ current_session.metrics.tokens_used | format_number }}</h3>
                            <small class="text-muted">Tokens Used</small>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="metric-box">
                            <i class="fas fa-exclamation-triangle text-danger fa-2x mb-2"></i>
                            <h3>{{ current_session.metrics.errors }}</h3>
                            <small class="text-muted">Errors</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Current vs Last Session Comparison -->
{% if comparison %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-balance-scale"></i> Current vs Last Session Comparison
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5 class="text-center mb-3">
                            <span class="badge bg-info">Last Session</span>
                            <code>{{ comparison.session1.id }}</code>
                        </h5>
                        <div class="text-center">
                            <div class="mb-3">
                                <strong>Duration:</strong> {{ comparison.session1.duration }} min
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <div class="p-3 bg-light rounded">
                                        <strong>{{ comparison.session1.metrics.policies_hit }}</strong><br>
                                        <small>Policies Hit</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="p-3 bg-light rounded">
                                        <strong>{{ comparison.session1.metrics.context_optimizations }}</strong><br>
                                        <small>Context Opts</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <h5 class="text-center mb-3">
                            <span class="badge bg-success">Current Session</span>
                            <code>{{ comparison.session2.id }}</code>
                        </h5>
                        <div class="text-center">
                            <div class="mb-3">
                                <strong>Duration:</strong> {{ comparison.session2.duration }} min
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <div class="p-3 bg-light rounded">
                                        <strong>{{ comparison.session2.metrics.policies_hit }}</strong><br>
                                        <small>Policies Hit</small>
                                        {% set diff = comparison.differences.policies_hit %}
                                        {% if diff.direction == 'up' %}
                                            <span class="badge bg-success">+{{ diff.value }}</span>
                                        {% elif diff.direction == 'down' %}
                                            <span class="badge bg-danger">{{ diff.value }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="p-3 bg-light rounded">
                                        <strong>{{ comparison.session2.metrics.context_optimizations }}</strong><br>
                                        <small>Context Opts</small>
                                        {% set diff = comparison.differences.context_optimizations %}
                                        {% if diff.direction == 'up' %}
                                            <span class="badge bg-success">+{{ diff.value }}</span>
                                        {% elif diff.direction == 'down' %}
                                            <span class="badge bg-danger">{{ diff.value }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <hr>

                <h6 class="text-center">Performance Comparison</h6>
                <div class="row">
                    {% for metric, diff in comparison.differences.items() %}
                    <div class="col-md-4 mb-3">
                        <div class="text-center p-3 bg-light rounded">
                            <strong>{{ metric.replace('_', ' ').title() }}</strong><br>
                            {% if diff.direction == 'up' %}
                                <i class="fas fa-arrow-up text-success"></i>
                                <span class="text-success">+{{ diff.value }} (+{{ diff.percent }}%)</span>
                            {% elif diff.direction == 'down' %}
                                <i class="fas fa-arrow-down text-danger"></i>
                                <span class="text-danger">{{ diff.value }} ({{ diff.percent }}%)</span>
                            {% else %}
                                <i class="fas fa-equals text-muted"></i>
                                <span class="text-muted">No Change</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Sessions History -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-list"></i> Recent Sessions (Last 10)</span>
                <a href="{{ url_for('export_sessions') }}" class="btn btn-sm btn-success">
                    <i class="fas fa-download"></i> Export to CSV
                </a>
            </div>
            <div class="card-body">
                <!-- Search Box -->
                <div class="row mb-3">
                    <div class="col-md-8">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" id="sessionSearch"
                                   placeholder="Search by Session ID, Duration, or Status..."
                                   onkeyup="filterSessions()">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="statusFilter" onchange="filterSessions()">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="completed">Completed</option>
                            <option value="ended">Ended</option>
                        </select>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover" id="sessionsTable">
                        <thead>
                            <tr>
                                <th>Session ID</th>
                                <th>Start Time</th>
                                <th>Duration</th>
                                <th>Policies Hit</th>
                                <th>Context Opts</th>
                                <th>Failures Prevented</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="sessionsTableBody">
                            {% for session in sessions_history | reverse %}
                            <tr class="session-row" data-session-id="{{ session.session_id }}"
                                data-status="{{ session.status }}"
                                data-duration="{{ session.duration_minutes }}">
                                <td><code>{{ session.session_id }}</code></td>
                                <td>{{ session.start_time | format_datetime }}</td>
                                <td>{{ session.duration_minutes }} min</td>
                                <td>{{ session.metrics.policies_hit }}</td>
                                <td>{{ session.metrics.context_optimizations }}</td>
                                <td>{{ session.metrics.failures_prevented }}</td>
                                <td>
                                    <span class="status-badge status-active">
                                        {{ session.status }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Result count -->
                <div class="mt-2 text-muted">
                    <span id="resultCount">{{ sessions_history | length }}</span> sessions found
                </div>

                {% if not sessions_history %}
                <div class="text-center text-muted py-4">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <p>No previous sessions yet. Keep using the system to build history!</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Summary Statistics -->
<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <i class="fas fa-calendar-check fa-3x text-primary mb-3"></i>
                <h3>{{ summary.total_sessions }}</h3>
                <p class="text-muted mb-0">Total Sessions</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <i class="fas fa-clock fa-3x text-success mb-3"></i>
                <h3>{{ summary.averages.duration }} min</h3>
                <p class="text-muted mb-0">Avg Duration</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <i class="fas fa-chart-line fa-3x text-warning mb-3"></i>
                <h3>{{ summary.averages.policies_hit | round }}</h3>
                <p class="text-muted mb-0">Avg Policies/Session</p>
            </div>
        </div>
    </div>
</div>

<style>
    .metric-box {
        padding: 1rem;
        border-radius: 10px;
        background: #f8f9fa;
        transition: all 0.3s ease;
    }

    .metric-box:hover {
        background: #e9ecef;
        transform: translateY(-2px);
    }

    .metric-box h3 {
        margin: 0.5rem 0;
        color: #1e293b;
    }

    code {
        background: #e9ecef;
        padding: 0.25rem 0.5rem;
        border-radius: 5px;
        font-size: 0.9rem;
    }
</style>

<script>
    function endSession() {
        if (confirm('Are you sure you want to end the current session?')) {
            fetch('/api/session/end', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Session ended successfully!');
                    location.reload();
                } else {
                    alert('Error ending session: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error ending session');
            });
        }
    }

    // Auto-refresh metrics every 30 seconds
    setInterval(() => {
        location.reload();
    }, 30000);

    // Search/Filter functionality
    function filterSessions() {
        const searchText = document.getElementById('sessionSearch').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value.toLowerCase();
        const rows = document.querySelectorAll('.session-row');
        let visibleCount = 0;

        rows.forEach(row => {
            const sessionId = row.getAttribute('data-session-id').toLowerCase();
            const status = row.getAttribute('data-status').toLowerCase();
            const duration = row.getAttribute('data-duration');
            const rowText = row.textContent.toLowerCase();

            // Check search text
            const matchesSearch = searchText === '' ||
                                sessionId.includes(searchText) ||
                                duration.includes(searchText) ||
                                status.includes(searchText) ||
                                rowText.includes(searchText);

            // Check status filter
            const matchesStatus = statusFilter === '' || status.includes(statusFilter);

            // Show/hide row
            if (matchesSearch && matchesStatus) {
                row.style.display = '';
                visibleCount++;

                // Highlight matching text
                if (searchText !== '') {
                    highlightText(row, searchText);
                }
            } else {
                row.style.display = 'none';
            }
        });

        // Update result count
        document.getElementById('resultCount').textContent = visibleCount;
    }

    function highlightText(row, searchText) {
        // Simple highlight - could be improved
        const cells = row.querySelectorAll('td');
        cells.forEach(cell => {
            if (cell.querySelector('code')) {
                // Skip code elements
                return;
            }
            const text = cell.textContent;
            if (text.toLowerCase().includes(searchText)) {
                cell.style.backgroundColor = 'rgba(255, 235, 59, 0.3)';
            } else {
                cell.style.backgroundColor = '';
            }
        });
    }
</script>
{% endblock %}
