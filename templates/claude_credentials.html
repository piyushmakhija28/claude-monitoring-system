{% extends "base.html" %}

{% block title %}Claude Credentials - Claude Insight{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">
        <i class="fas fa-key"></i> Claude / Anthropic Credentials
    </h1>

    <!-- Status Cards -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card {% if has_credentials %}border-success{% else %}border-warning{% endif %}">
                <div class="card-header {% if has_credentials %}bg-success{% else %}bg-warning{% endif %} text-white">
                    <i class="fas fa-shield-alt"></i> API Key Status
                </div>
                <div class="card-body">
                    {% if has_credentials %}
                        <h5 class="text-success"><i class="fas fa-check-circle"></i> API Key Configured</h5>
                        <p class="mb-2"><strong>Email:</strong> {{ credentials.user_email or 'Not provided' }}</p>
                        <p class="mb-2"><strong>Saved:</strong> {{ credentials.saved_at[:19] }}</p>
                        <div class="mt-3">
                            <button class="btn btn-primary" onclick="testConnection()">
                                <i class="fas fa-plug"></i> Test Connection
                            </button>
                            <button class="btn btn-danger" onclick="deleteCredentials()">
                                <i class="fas fa-trash"></i> Delete Key
                            </button>
                        </div>
                    {% else %}
                        <h5 class="text-warning"><i class="fas fa-exclamation-triangle"></i> No API Key Configured</h5>
                        <p>Add your Anthropic API key to enable auto-session tracking and Claude integration.</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addKeyModal">
                            <i class="fas fa-plus"></i> Add API Key
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card {% if tracking_status.enabled %}border-success{% else %}border-secondary{% endif %}">
                <div class="card-header {% if tracking_status.enabled %}bg-success{% else %}bg-secondary{% endif %} text-white">
                    <i class="fas fa-sync-alt"></i> Auto-Tracking Status
                </div>
                <div class="card-body">
                    {% if tracking_status.enabled %}
                        <h5 class="text-success"><i class="fas fa-check-circle"></i> Auto-Tracking Enabled</h5>
                        <p class="mb-2"><strong>Interval:</strong> {{ tracking_status.interval_minutes }} minutes</p>
                        {% if tracking_status.last_sync %}
                        <p class="mb-2"><strong>Last Sync:</strong> {{ tracking_status.last_sync[:19] }}</p>
                        {% endif %}
                        <div class="mt-3">
                            <button class="btn btn-primary" onclick="syncNow()">
                                <i class="fas fa-sync"></i> Sync Now
                            </button>
                            <button class="btn btn-secondary" onclick="disableAutoTracking()">
                                <i class="fas fa-pause"></i> Disable
                            </button>
                        </div>
                    {% else %}
                        <h5 class="text-secondary"><i class="fas fa-pause-circle"></i> Auto-Tracking Disabled</h5>
                        <p>Enable automatic session tracking to never miss a session!</p>
                        {% if has_credentials %}
                        <button class="btn btn-success" onclick="enableAutoTracking()">
                            <i class="fas fa-play"></i> Enable Auto-Tracking
                        </button>
                        {% else %}
                        <p class="text-muted"><em>Add API key first to enable auto-tracking</em></p>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Setup Instructions -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <i class="fas fa-book"></i> Setup Instructions
        </div>
        <div class="card-body">
            <h5>How to Get Your Anthropic API Key:</h5>
            <ol class="setup-steps">
                {% for step in setup_instructions.steps %}
                <li {% if step.important %}class="important-step"{% endif %}>
                    <strong>{{ step.title }}</strong>
                    <p>{{ step.description }}</p>
                    {% if step.url %}
                    <a href="{{ step.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-external-link-alt"></i> Open {{ step.title }}
                    </a>
                    {% endif %}
                </li>
                {% endfor %}
            </ol>

            <div class="alert alert-warning mt-3">
                <h6><i class="fas fa-info-circle"></i> Important Notes:</h6>
                <ul class="mb-0">
                    {% for note in setup_instructions.notes %}
                    <li>{{ note }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <!-- Features Info -->
    <div class="card">
        <div class="card-header bg-primary text-white">
            <i class="fas fa-star"></i> Features with Claude Integration
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="fas fa-check text-success"></i> Auto-Session Tracking</h6>
                    <p class="text-muted">Automatically track all your Claude sessions - never miss one!</p>

                    <h6><i class="fas fa-check text-success"></i> Real-time Sync</h6>
                    <p class="text-muted">Sessions sync every 5 minutes automatically</p>

                    <h6><i class="fas fa-check text-success"></i> Secure Storage</h6>
                    <p class="text-muted">API key encrypted and stored locally on your machine</p>
                </div>
                <div class="col-md-6">
                    <h6><i class="fas fa-check text-success"></i> Usage Analytics</h6>
                    <p class="text-muted">Track your Claude usage and costs (coming soon)</p>

                    <h6><i class="fas fa-check text-success"></i> Model Distribution</h6>
                    <p class="text-muted">See which models you use most (coming soon)</p>

                    <h6><i class="fas fa-check text-success"></i> Session History</h6>
                    <p class="text-muted">Complete history of all your Claude interactions</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add API Key Modal -->
<div class="modal fade" id="addKeyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-key"></i> Add Anthropic API Key</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="apiKeyForm">
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-key"></i> Anthropic API Key *
                        </label>
                        <input type="text" class="form-control" id="apiKeyInput"
                               placeholder="sk-ant-api03-xxxxx..." required>
                        <small class="form-text text-muted">
                            Starts with "sk-ant-". Get it from
                            <a href="https://console.anthropic.com/settings/keys" target="_blank">
                                Anthropic Console <i class="fas fa-external-link-alt"></i>
                            </a>
                        </small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-envelope"></i> Email (Optional)
                        </label>
                        <input type="email" class="form-control" id="emailInput"
                               placeholder="your@email.com">
                        <small class="form-text text-muted">For your reference only</small>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-lock"></i> Your API key will be encrypted and stored securely on your local machine only.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveApiKey()">
                    <i class="fas fa-save"></i> Save & Test Connection
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Test Results Modal -->
<div class="modal fade" id="testResultsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" id="testResultsHeader">
                <h5 class="modal-title"><i class="fas fa-flask"></i> Connection Test Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="testResultsBody">
                <!-- Results loaded here -->
            </div>
        </div>
    </div>
</div>

<script>
function saveApiKey() {
    const apiKey = document.getElementById('apiKeyInput').value.trim();
    const email = document.getElementById('emailInput').value.trim();

    if (!apiKey) {
        alert('Please enter your API key');
        return;
    }

    if (!apiKey.startsWith('sk-ant-')) {
        alert('Invalid API key format. Anthropic keys start with "sk-ant-"');
        return;
    }

    // Show loading
    const btn = event.target;
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Testing...';
    btn.disabled = true;

    fetch('/api/claude/credentials/save', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({api_key: apiKey, user_email: email})
    })
    .then(response => response.json())
    .then(data => {
        btn.innerHTML = originalHtml;
        btn.disabled = false;

        if (data.success) {
            // Close add key modal
            bootstrap.Modal.getInstance(document.getElementById('addKeyModal')).hide();

            // Show success message
            showTestResults(true, data.message, data.test_result);

            // Reload page after 2 seconds
            setTimeout(() => location.reload(), 2000);
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
        alert('Error: ' + error.message);
    });
}

function testConnection() {
    const btn = event.target;
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Testing...';
    btn.disabled = true;

    fetch('/api/claude/credentials/test', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
        showTestResults(data.success, data.message, data);
    })
    .catch(error => {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
        alert('Test failed: ' + error.message);
    });
}

function showTestResults(success, message, data) {
    const header = document.getElementById('testResultsHeader');
    const body = document.getElementById('testResultsBody');

    if (success) {
        header.className = 'modal-header bg-success text-white';
        body.innerHTML = `
            <div class="alert alert-success">
                <h5><i class="fas fa-check-circle"></i> ${message}</h5>
                <p class="mb-0">Your API key is working correctly!</p>
            </div>
        `;
    } else {
        header.className = 'modal-header bg-danger text-white';
        body.innerHTML = `
            <div class="alert alert-danger">
                <h5><i class="fas fa-times-circle"></i> ${message}</h5>
                ${data.error ? `<p class="mb-0">Error: ${data.error}</p>` : ''}
            </div>
        `;
    }

    new bootstrap.Modal(document.getElementById('testResultsModal')).show();
}

function deleteCredentials() {
    if (!confirm('Are you sure you want to delete your API key?')) return;

    fetch('/api/claude/credentials/delete', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Credentials deleted successfully');
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    });
}

function enableAutoTracking() {
    fetch('/api/claude/auto-tracking/enable', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({interval_minutes: 5})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Auto-tracking enabled! Sessions will sync every 5 minutes.');
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    });
}

function disableAutoTracking() {
    if (!confirm('Disable automatic session tracking?')) return;

    fetch('/api/claude/auto-tracking/disable', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Auto-tracking disabled');
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    });
}

function syncNow() {
    const btn = event.target;
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Syncing...';
    btn.disabled = true;

    fetch('/api/claude/sessions/sync', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        btn.innerHTML = originalHtml;
        btn.disabled = false;

        if (data.success) {
            alert('Sessions synced successfully!');
            location.reload();
        } else {
            alert('Sync failed: ' + data.message);
        }
    })
    .catch(error => {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
        alert('Error: ' + error.message);
    });
}
</script>

<style>
.setup-steps {
    counter-reset: step-counter;
}

.setup-steps li {
    margin-bottom: 20px;
    padding-left: 10px;
}

.important-step {
    background-color: #fff3cd;
    padding: 15px;
    border-radius: 5px;
    border-left: 4px solid #ffc107;
}
</style>
{% endblock %}
