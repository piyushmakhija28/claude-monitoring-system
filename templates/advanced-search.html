{% extends "base.html" %}

{% block title %}Advanced Search - Claude Insight{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="mb-0">
            <i class="fas fa-search me-2"></i>Advanced Search & Filtering
        </h2>
        <p class="text-muted mt-2">Search across all data with powerful filters and saved searches</p>
    </div>
</div>

<!-- Global Search Bar -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
                <div class="input-group input-group-lg">
                    <span class="input-group-text bg-white border-end-0">
                        <i class="fas fa-search text-primary"></i>
                    </span>
                    <input type="text"
                           class="form-control border-start-0 ps-0"
                           id="globalSearchInput"
                           placeholder="Search logs, sessions, policies, hooks, performance data..."
                           autocomplete="off"
                           onkeyup="performGlobalSearch()">
                    <button class="btn btn-primary" onclick="performGlobalSearch()">
                        <i class="fas fa-search me-2"></i>Search
                    </button>
                    <button class="btn btn-outline-secondary" onclick="clearSearch()">
                        <i class="fas fa-times me-2"></i>Clear
                    </button>
                </div>

                <!-- Search Suggestions (Autocomplete) -->
                <div id="searchSuggestions" class="list-group mt-2" style="display: none; max-height: 300px; overflow-y: auto;">
                    <!-- Dynamic suggestions will appear here -->
                </div>

                <!-- Search Stats -->
                <div class="mt-3 d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        <span id="searchStats">Ready to search across all data sources</span>
                    </small>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="regexMode">
                        <label class="form-check-label" for="regexMode">
                            <small><i class="fas fa-code me-1"></i>Regex Mode</small>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Advanced Filters -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-filter me-2"></i>Advanced Filters
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="toggleFilters()">
                        <i class="fas fa-sliders-h me-1"></i>Toggle Filters
                    </button>
                </div>
            </div>
            <div class="card-body p-4" id="advancedFilters" style="display: none;">
                <div class="row g-3">
                    <!-- Data Source Filter -->
                    <div class="col-md-3">
                        <label for="dataSource" class="form-label fw-bold">
                            <i class="fas fa-database me-1 text-primary"></i>Data Source
                        </label>
                        <select class="form-select" id="dataSource" multiple size="6">
                            <option value="all" selected>All Sources</option>
                            <option value="logs">Logs</option>
                            <option value="sessions">Sessions</option>
                            <option value="policies">Policies</option>
                            <option value="performance">Performance Data</option>
                            <option value="alerts">Alerts</option>
                            <option value="widgets">Widgets</option>
                        </select>
                    </div>

                    <!-- Date Range Filter -->
                    <div class="col-md-3">
                        <label for="dateRange" class="form-label fw-bold">
                            <i class="fas fa-calendar me-1 text-success"></i>Date Range
                        </label>
                        <select class="form-select mb-2" id="dateRange" onchange="handleDateRangeChange()">
                            <option value="all">All Time</option>
                            <option value="today">Today</option>
                            <option value="yesterday">Yesterday</option>
                            <option value="last7days" selected>Last 7 Days</option>
                            <option value="last30days">Last 30 Days</option>
                            <option value="last90days">Last 90 Days</option>
                            <option value="custom">Custom Range</option>
                        </select>
                        <div id="customDateRange" style="display: none;">
                            <input type="date" class="form-control form-control-sm mb-1" id="startDate">
                            <input type="date" class="form-control form-control-sm" id="endDate">
                        </div>
                    </div>

                    <!-- Status/Severity Filter -->
                    <div class="col-md-3">
                        <label for="severity" class="form-label fw-bold">
                            <i class="fas fa-exclamation-triangle me-1 text-warning"></i>Severity/Status
                        </label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="critical" id="severityCritical" checked>
                            <label class="form-check-label" for="severityCritical">
                                <span class="badge bg-danger">Critical</span>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="high" id="severityHigh" checked>
                            <label class="form-check-label" for="severityHigh">
                                <span class="badge bg-warning">High</span>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="medium" id="severityMedium" checked>
                            <label class="form-check-label" for="severityMedium">
                                <span class="badge bg-info">Medium</span>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="low" id="severityLow">
                            <label class="form-check-label" for="severityLow">
                                <span class="badge bg-secondary">Low</span>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="success" id="severitySuccess">
                            <label class="form-check-label" for="severitySuccess">
                                <span class="badge bg-success">Success</span>
                            </label>
                        </div>
                    </div>

                    <!-- Tags Filter -->
                    <div class="col-md-3">
                        <label for="tags" class="form-label fw-bold">
                            <i class="fas fa-tags me-1 text-info"></i>Tags
                        </label>
                        <input type="text"
                               class="form-control mb-2"
                               id="tagsInput"
                               placeholder="Enter tags (comma-separated)"
                               onkeypress="handleTagsInput(event)">
                        <div id="selectedTags" class="d-flex flex-wrap gap-1">
                            <!-- Selected tags will appear here -->
                        </div>
                    </div>

                    <!-- Sort & Limit Options -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">
                            <i class="fas fa-sort me-1 text-secondary"></i>Sort & Limit
                        </label>
                        <div class="row g-2">
                            <div class="col-6">
                                <select class="form-select form-select-sm" id="sortBy">
                                    <option value="relevance">Sort by: Relevance</option>
                                    <option value="date_desc">Date (Newest First)</option>
                                    <option value="date_asc">Date (Oldest First)</option>
                                    <option value="severity">Severity (High to Low)</option>
                                    <option value="source">Data Source</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <select class="form-select form-select-sm" id="resultLimit">
                                    <option value="50">Show: 50 results</option>
                                    <option value="100" selected>100 results</option>
                                    <option value="200">200 results</option>
                                    <option value="500">500 results</option>
                                    <option value="all">All results</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="col-md-6 d-flex align-items-end">
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-primary" onclick="applyFilters()">
                                <i class="fas fa-check me-1"></i>Apply Filters
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="resetFilters()">
                                <i class="fas fa-undo me-1"></i>Reset
                            </button>
                            <button type="button" class="btn btn-outline-success" onclick="saveSearch()">
                                <i class="fas fa-bookmark me-1"></i>Save Search
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Saved Searches -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0">
                    <i class="fas fa-bookmark me-2"></i>Saved Searches & History
                </h5>
            </div>
            <div class="card-body p-4">
                <!-- Tabs -->
                <ul class="nav nav-tabs mb-3" id="savedSearchTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="saved-tab" data-bs-toggle="tab" data-bs-target="#savedSearches" type="button">
                            <i class="fas fa-bookmark me-1"></i>Saved (0)
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#searchHistory" type="button">
                            <i class="fas fa-history me-1"></i>History (0)
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="savedSearchTabsContent">
                    <!-- Saved Searches -->
                    <div class="tab-pane fade show active" id="savedSearches" role="tabpanel">
                        <div id="savedSearchList" class="list-group">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-bookmark fa-3x mb-3 opacity-25"></i>
                                <p>No saved searches yet. Save your current search using the "Save Search" button above.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Search History -->
                    <div class="tab-pane fade" id="searchHistory" role="tabpanel">
                        <div id="searchHistoryList" class="list-group">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-history fa-3x mb-3 opacity-25"></i>
                                <p>No search history yet. Start searching to build your history.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search Results -->
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>Search Results
                        <span class="badge bg-primary ms-2" id="resultCount">0</span>
                    </h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="exportResults('csv')">
                            <i class="fas fa-file-csv me-1"></i>Export CSV
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-success" onclick="exportResults('json')">
                            <i class="fas fa-file-code me-1"></i>Export JSON
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-info" onclick="exportResults('excel')">
                            <i class="fas fa-file-excel me-1"></i>Export Excel
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <!-- Loading State -->
                <div id="searchLoading" class="text-center py-5" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Searching...</span>
                    </div>
                    <p class="text-muted mt-3">Searching across all data sources...</p>
                </div>

                <!-- Results Table -->
                <div class="table-responsive" id="searchResultsContainer">
                    <table class="table table-hover mb-0" id="searchResultsTable">
                        <thead class="bg-light">
                            <tr>
                                <th width="5%">
                                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                </th>
                                <th width="10%">Source</th>
                                <th width="15%">Timestamp</th>
                                <th width="10%">Severity</th>
                                <th width="40%">Content</th>
                                <th width="15%">Tags</th>
                                <th width="5%">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="searchResults">
                            <tr>
                                <td colspan="7" class="text-center text-muted py-5">
                                    <i class="fas fa-search fa-3x mb-3 opacity-25"></i>
                                    <p>Enter a search query and click Search to see results</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="card-footer bg-white border-top-0" id="searchPagination" style="display: none;">
                    <nav aria-label="Search results pagination">
                        <ul class="pagination mb-0 justify-content-center" id="paginationList">
                            <!-- Pagination will be generated here -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Save Search Modal -->
<div class="modal fade" id="saveSearchModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-bookmark me-2"></i>Save Search
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="saveSearchForm">
                    <div class="mb-3">
                        <label for="searchName" class="form-label">Search Name</label>
                        <input type="text" class="form-control" id="searchName" required placeholder="e.g., Critical Errors Last Week">
                    </div>
                    <div class="mb-3">
                        <label for="searchDescription" class="form-label">Description (Optional)</label>
                        <textarea class="form-control" id="searchDescription" rows="2" placeholder="Brief description of this search"></textarea>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="saveFilters" checked>
                        <label class="form-check-label" for="saveFilters">
                            Save current filters
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmSaveSearch()">
                    <i class="fas fa-save me-1"></i>Save Search
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Advanced Search & Filtering System JavaScript

let searchResults = [];
let currentPage = 1;
let resultsPerPage = 100;
let searchHistory = [];
let savedSearches = [];

// Load saved data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadSearchHistory();
    loadSavedSearches();
});

// Perform global search
function performGlobalSearch() {
    const query = document.getElementById('globalSearchInput').value.trim();

    if (!query) {
        alert('Please enter a search query');
        return;
    }

    // Show loading
    document.getElementById('searchLoading').style.display = 'block';
    document.getElementById('searchResultsContainer').style.display = 'none';

    // Collect filters
    const filters = collectFilters();

    // Add to search history
    addToSearchHistory(query, filters);

    // Perform search API call
    fetch('/api/search', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            query: query,
            regex_mode: document.getElementById('regexMode').checked,
            filters: filters
        })
    })
    .then(response => response.json())
    .then(data => {
        searchResults = data.results || [];
        displaySearchResults(searchResults);
        updateSearchStats(data.stats);

        // Hide loading
        document.getElementById('searchLoading').style.display = 'none';
        document.getElementById('searchResultsContainer').style.display = 'block';
    })
    .catch(error => {
        console.error('Search error:', error);
        document.getElementById('searchLoading').style.display = 'none';
        document.getElementById('searchResultsContainer').style.display = 'block';
        alert('Search failed. Please try again.');
    });
}

// Collect current filters
function collectFilters() {
    const dataSources = Array.from(document.getElementById('dataSource').selectedOptions).map(opt => opt.value);
    const severities = [];

    ['critical', 'high', 'medium', 'low', 'success'].forEach(sev => {
        if (document.getElementById('severity' + sev.charAt(0).toUpperCase() + sev.slice(1)).checked) {
            severities.push(sev);
        }
    });

    return {
        data_sources: dataSources,
        date_range: document.getElementById('dateRange').value,
        start_date: document.getElementById('startDate').value,
        end_date: document.getElementById('endDate').value,
        severities: severities,
        tags: collectTags(),
        sort_by: document.getElementById('sortBy').value,
        limit: document.getElementById('resultLimit').value
    };
}

// Display search results
function displaySearchResults(results) {
    const tbody = document.getElementById('searchResults');
    tbody.innerHTML = '';

    if (results.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted py-5">
                    <i class="fas fa-inbox fa-3x mb-3 opacity-25"></i>
                    <p>No results found. Try adjusting your search query or filters.</p>
                </td>
            </tr>
        `;
        document.getElementById('resultCount').textContent = '0';
        return;
    }

    // Pagination
    const start = (currentPage - 1) * resultsPerPage;
    const end = start + resultsPerPage;
    const paginatedResults = results.slice(start, end);

    paginatedResults.forEach((result, index) => {
        const row = `
            <tr>
                <td><input type="checkbox" class="result-checkbox" data-id="${result.id}"></td>
                <td><span class="badge bg-secondary">${result.source}</span></td>
                <td><small>${new Date(result.timestamp).toLocaleString()}</small></td>
                <td><span class="badge bg-${getSeverityColor(result.severity)}">${result.severity}</span></td>
                <td><small>${highlightMatch(result.content, document.getElementById('globalSearchInput').value)}</small></td>
                <td>${result.tags.map(tag => `<span class="badge bg-info">${tag}</span>`).join(' ')}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="viewDetail(${result.id})">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });

    // Update result count
    document.getElementById('resultCount').textContent = results.length;

    // Update pagination
    updatePagination(results.length);
}

// Helper functions
function getSeverityColor(severity) {
    const colors = {
        'critical': 'danger',
        'high': 'warning',
        'medium': 'info',
        'low': 'secondary',
        'success': 'success'
    };
    return colors[severity] || 'secondary';
}

function highlightMatch(text, query) {
    if (!query) return text;
    const regex = new RegExp(`(${query})`, 'gi');
    return text.replace(regex, '<mark>$1</mark>');
}

function updateSearchStats(stats) {
    const statsEl = document.getElementById('searchStats');
    statsEl.textContent = `Found ${stats.total_results} results in ${stats.search_time}ms across ${stats.sources_searched} sources`;
}

function updatePagination(totalResults) {
    const totalPages = Math.ceil(totalResults / resultsPerPage);
    const paginationList = document.getElementById('paginationList');
    paginationList.innerHTML = '';

    if (totalPages <= 1) {
        document.getElementById('searchPagination').style.display = 'none';
        return;
    }

    document.getElementById('searchPagination').style.display = 'block';

    // Previous button
    paginationList.innerHTML += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>
        </li>
    `;

    // Page numbers
    for (let i = 1; i <= Math.min(totalPages, 10); i++) {
        paginationList.innerHTML += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
            </li>
        `;
    }

    // Next button
    paginationList.innerHTML += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>
        </li>
    `;
}

function changePage(page) {
    currentPage = page;
    displaySearchResults(searchResults);
}

// Search history management
function addToSearchHistory(query, filters) {
    const historyItem = {
        query: query,
        filters: filters,
        timestamp: new Date().toISOString()
    };

    searchHistory.unshift(historyItem);
    if (searchHistory.length > 50) {
        searchHistory = searchHistory.slice(0, 50);
    }

    localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
    loadSearchHistory();
}

function loadSearchHistory() {
    const saved = localStorage.getItem('searchHistory');
    if (saved) {
        searchHistory = JSON.parse(saved);
        displaySearchHistory();
    }
}

function displaySearchHistory() {
    const list = document.getElementById('searchHistoryList');
    list.innerHTML = '';

    if (searchHistory.length === 0) {
        list.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-history fa-3x mb-3 opacity-25"></i>
                <p>No search history yet.</p>
            </div>
        `;
        return;
    }

    searchHistory.forEach((item, index) => {
        const itemHTML = `
            <div class="list-group-item">
                <div class="d-flex justify-content-between">
                    <div>
                        <strong>${item.query}</strong>
                        <small class="text-muted d-block">${new Date(item.timestamp).toLocaleString()}</small>
                    </div>
                    <button class="btn btn-sm btn-primary" onclick="replaySearch(${index})">
                        <i class="fas fa-redo"></i> Replay
                    </button>
                </div>
            </div>
        `;
        list.innerHTML += itemHTML;
    });

    // Update count
    document.getElementById('history-tab').innerHTML = `<i class="fas fa-history me-1"></i>History (${searchHistory.length})`;
}

// Saved searches management
function saveSearch() {
    const modal = new bootstrap.Modal(document.getElementById('saveSearchModal'));
    modal.show();
}

function confirmSaveSearch() {
    const name = document.getElementById('searchName').value.trim();
    if (!name) {
        alert('Please enter a name for this search');
        return;
    }

    const savedSearch = {
        name: name,
        description: document.getElementById('searchDescription').value.trim(),
        query: document.getElementById('globalSearchInput').value,
        filters: document.getElementById('saveFilters').checked ? collectFilters() : null,
        created_at: new Date().toISOString()
    };

    savedSearches.unshift(savedSearch);
    localStorage.setItem('savedSearches', JSON.stringify(savedSearches));
    loadSavedSearches();

    // Close modal
    bootstrap.Modal.getInstance(document.getElementById('saveSearchModal')).hide();

    // Reset form
    document.getElementById('saveSearchForm').reset();
}

function loadSavedSearches() {
    const saved = localStorage.getItem('savedSearches');
    if (saved) {
        savedSearches = JSON.parse(saved);
        displaySavedSearches();
    }
}

function displaySavedSearches() {
    const list = document.getElementById('savedSearchList');
    list.innerHTML = '';

    if (savedSearches.length === 0) {
        list.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-bookmark fa-3x mb-3 opacity-25"></i>
                <p>No saved searches yet.</p>
            </div>
        `;
        return;
    }

    savedSearches.forEach((item, index) => {
        const itemHTML = `
            <div class="list-group-item">
                <div class="d-flex justify-content-between">
                    <div>
                        <strong><i class="fas fa-bookmark me-1 text-primary"></i>${item.name}</strong>
                        ${item.description ? `<p class="mb-1 text-muted small">${item.description}</p>` : ''}
                        <small class="text-muted">Query: "${item.query}" | Created: ${new Date(item.created_at).toLocaleDateString()}</small>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-primary" onclick="loadSavedSearch(${index})">
                            <i class="fas fa-play"></i> Load
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteSavedSearch(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        list.innerHTML += itemHTML;
    });

    // Update count
    document.getElementById('saved-tab').innerHTML = `<i class="fas fa-bookmark me-1"></i>Saved (${savedSearches.length})`;
}

function loadSavedSearch(index) {
    const search = savedSearches[index];
    document.getElementById('globalSearchInput').value = search.query;

    if (search.filters) {
        applyFiltersFromSaved(search.filters);
    }

    performGlobalSearch();
}

function deleteSavedSearch(index) {
    if (confirm('Are you sure you want to delete this saved search?')) {
        savedSearches.splice(index, 1);
        localStorage.setItem('savedSearches', JSON.stringify(savedSearches));
        displaySavedSearches();
    }
}

// Other utility functions
function toggleFilters() {
    const filters = document.getElementById('advancedFilters');
    filters.style.display = filters.style.display === 'none' ? 'block' : 'none';
}

function handleDateRangeChange() {
    const dateRange = document.getElementById('dateRange').value;
    const customRange = document.getElementById('customDateRange');
    customRange.style.display = dateRange === 'custom' ? 'block' : 'none';
}

function handleTagsInput(event) {
    if (event.key === 'Enter' || event.key === ',') {
        event.preventDefault();
        const input = document.getElementById('tagsInput');
        const tag = input.value.trim().replace(',', '');

        if (tag) {
            addTag(tag);
            input.value = '';
        }
    }
}

function addTag(tag) {
    const container = document.getElementById('selectedTags');
    const tagElement = `
        <span class="badge bg-info">
            ${tag}
            <i class="fas fa-times ms-1" onclick="removeTag(this)" style="cursor: pointer;"></i>
        </span>
    `;
    container.innerHTML += tagElement;
}

function removeTag(element) {
    element.parentElement.remove();
}

function collectTags() {
    const badges = document.querySelectorAll('#selectedTags .badge');
    return Array.from(badges).map(badge => badge.textContent.trim().replace('Ã—', ''));
}

function applyFilters() {
    performGlobalSearch();
}

function resetFilters() {
    document.getElementById('dataSource').selectedIndex = 0;
    document.getElementById('dateRange').value = 'last7days';
    document.getElementById('sortBy').value = 'relevance';
    document.getElementById('resultLimit').value = '100';
    document.querySelectorAll('[id^="severity"]').forEach(cb => cb.checked = true);
    document.getElementById('selectedTags').innerHTML = '';
    document.getElementById('regexMode').checked = false;
    handleDateRangeChange();
}

function clearSearch() {
    document.getElementById('globalSearchInput').value = '';
    document.getElementById('searchResults').innerHTML = `
        <tr>
            <td colspan="7" class="text-center text-muted py-5">
                <i class="fas fa-search fa-3x mb-3 opacity-25"></i>
                <p>Enter a search query and click Search to see results</p>
            </td>
        </tr>
    `;
    document.getElementById('resultCount').textContent = '0';
    document.getElementById('searchStats').textContent = 'Ready to search across all data sources';
}

function toggleSelectAll() {
    const checkboxes = document.querySelectorAll('.result-checkbox');
    const selectAll = document.getElementById('selectAll');
    checkboxes.forEach(cb => cb.checked = selectAll.checked);
}

function exportResults(format) {
    const selected = Array.from(document.querySelectorAll('.result-checkbox:checked')).map(cb => cb.dataset.id);
    const resultsToExport = selected.length > 0 ? searchResults.filter(r => selected.includes(r.id.toString())) : searchResults;

    if (resultsToExport.length === 0) {
        alert('No results to export');
        return;
    }

    // Send export request
    fetch('/api/search/export', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            format: format,
            results: resultsToExport
        })
    })
    .then(response => response.blob())
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `search-results-${Date.now()}.${format}`;
        document.body.appendChild(a);
        a.click();
        a.remove();
    });
}

function viewDetail(id) {
    alert('Detail view for result ID: ' + id);
    // Implement detail view modal
}

function replaySearch(index) {
    const item = searchHistory[index];
    document.getElementById('globalSearchInput').value = item.query;
    applyFiltersFromSaved(item.filters);
    performGlobalSearch();
}

function applyFiltersFromSaved(filters) {
    // Apply saved filters
    if (filters.data_sources) {
        Array.from(document.getElementById('dataSource').options).forEach(opt => {
            opt.selected = filters.data_sources.includes(opt.value);
        });
    }

    if (filters.date_range) {
        document.getElementById('dateRange').value = filters.date_range;
        handleDateRangeChange();
    }

    if (filters.severities) {
        ['critical', 'high', 'medium', 'low', 'success'].forEach(sev => {
            const checkbox = document.getElementById('severity' + sev.charAt(0).toUpperCase() + sev.slice(1));
            if (checkbox) {
                checkbox.checked = filters.severities.includes(sev);
            }
        });
    }

    if (filters.sort_by) {
        document.getElementById('sortBy').value = filters.sort_by;
    }

    if (filters.limit) {
        document.getElementById('resultLimit').value = filters.limit;
    }
}
</script>

<style>
#searchSuggestions {
    position: absolute;
    z-index: 1000;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

#searchSuggestions .list-group-item {
    cursor: pointer;
    border-left: none;
    border-right: none;
}

#searchSuggestions .list-group-item:hover {
    background-color: #f8f9fa;
}

#searchSuggestions .list-group-item:first-child {
    border-top: none;
}

#searchSuggestions .list-group-item:last-child {
    border-bottom: none;
}

.form-select[multiple] {
    height: auto !important;
}

mark {
    background-color: #ffc107;
    padding: 0.1rem 0.3rem;
    border-radius: 0.2rem;
}

.result-checkbox {
    cursor: pointer;
}

#searchResultsTable th {
    position: sticky;
    top: 0;
    background-color: #f8f9fa;
    z-index: 10;
}
</style>

{% endblock %}
