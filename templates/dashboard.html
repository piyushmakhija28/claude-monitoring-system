{% extends "base.html" %}

{% block title %}Dashboard - Claude Insight{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header mb-4">
    <h1 class="page-title">
        <i class="fas fa-tachometer-alt me-3"></i>
        System Dashboard
    </h1>
    <div class="page-subtitle">Real-time monitoring and analytics</div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div class="d-flex gap-2 flex-wrap">
                <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#widgetCustomizeModal">
                    <i class="fas fa-cog me-2"></i>Customize
                </button>
                <button class="btn btn-outline-info" onclick="resetWidgetOrder()" title="Reset widget order to default">
                    <i class="fas fa-undo me-2"></i>Reset Order
                </button>
                <a href="{{ url_for('export_metrics') }}" class="btn btn-success">
                    <i class="fas fa-download me-2"></i>Export Metrics
                </a>
                <button class="btn btn-outline-primary" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt me-2"></i>Refresh
                </button>
                <span class="badge bg-success fs-6" id="autoRefreshBadge">
                    <i class="fas fa-circle-notch fa-spin me-1"></i>Auto-refresh: 30s
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Sortable Widgets Container -->
<div id="sortableWidgets">

<!-- System Health Metrics -->
{% if widget_preferences.get('system_health', True) %}
<div class="row mb-4" id="systemHealthWidget">
    <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-heartbeat stat-icon text-success"></i>
                <div class="stat-value text-success" id="healthScore">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <div class="stat-label">Health Score</div>
                <div class="progress mt-3" style="height: 6px; border-radius: 10px; background: rgba(16, 185, 129, 0.1);">
                    <div class="progress-bar bg-success" id="healthScoreBar" role="progressbar" style="width: 0%; border-radius: 10px;"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-server stat-icon text-primary"></i>
                <div class="stat-value text-primary" id="daemonsRunning">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <div class="stat-label">Daemons Running</div>
                <small class="text-muted mt-2 d-block" id="daemonStatus">Checking...</small>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-shield-alt stat-icon text-info"></i>
                <div class="stat-value text-info" id="activePolicies">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <div class="stat-label">Active Policies</div>
                <small class="text-muted mt-2 d-block" id="totalPoliciesText">Out of ... total</small>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-chart-line stat-icon text-warning"></i>
                <div class="stat-value text-warning" id="policyHits">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <div class="stat-label">Policy Hits Today</div>
                <small class="text-muted mt-2 d-block">Last 24 hours</small>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Live Metrics and Activity Feed -->
<div class="row mb-4">
    <div class="col-lg-8 mb-4 mb-lg-0">
        <div class="card h-100">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line text-success"></i>
                            Live Metrics
                        </h5>
                        <small class="text-muted">Real-time policy executions as they happen</small>
                    </div>
                    <span class="badge bg-success">
                        <i class="fas fa-bolt"></i> LIVE
                    </span>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container" style="position: relative; height: 400px; max-height: 400px;">
                    <canvas id="metricsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% if widget_preferences.get('recent_activity', True) %}
    <div class="col-lg-4" id="recentActivityWidget">
        <div class="card h-100">
            <div class="card-header">
                <h5>
                    <i class="fas fa-clock"></i>
                    Recent Activity
                </h5>
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                <div id="activityFeed">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                        <p>Loading activity...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Historical Trends -->
{% if widget_preferences.get('historical_charts', True) %}
<div class="row mb-4" id="historicalChartsWidget">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                    <h5>
                        <i class="fas fa-chart-area"></i>
                        Historical Trends
                    </h5>

                    <!-- Time Range Filter -->
                    <div class="btn-group" role="group" aria-label="Time range filter">
                        <a href="?days=1" class="btn btn-sm btn-outline-primary {{ 'active' if selected_days == 1 else '' }}">
                            Today
                        </a>
                        <a href="?days=7" class="btn btn-sm btn-outline-primary {{ 'active' if selected_days == 7 else '' }}">
                            7 Days
                        </a>
                        <a href="?days=30" class="btn btn-sm btn-outline-primary {{ 'active' if selected_days == 30 else '' }}">
                            30 Days
                        </a>
                        <a href="?days=60" class="btn btn-sm btn-outline-primary {{ 'active' if selected_days == 60 else '' }}">
                            60 Days
                        </a>
                        <a href="?days=90" class="btn btn-sm btn-outline-primary {{ 'active' if selected_days == 90 else '' }}">
                            90 Days
                        </a>
                    </div>

                    <span class="badge bg-info">
                        <i class="fas fa-calendar-alt me-1"></i>Last {{ selected_days }} Days
                    </span>
                </div>
            </div>
            <div class="card-body">
                <!-- Summary Stats -->
                <div class="row mb-4 text-center">
                    <div class="col-md-3">
                        <div class="p-3 bg-light rounded">
                            <h4 class="text-primary mb-1">{{ summary_stats.avg_health_score }}%</h4>
                            <small class="text-muted">Avg Health Score</small>
                            {% if summary_stats.trend == 'up' %}
                            <i class="fas fa-arrow-up text-success ms-2" title="Improving"></i>
                            {% elif summary_stats.trend == 'down' %}
                            <i class="fas fa-arrow-down text-danger ms-2" title="Declining"></i>
                            {% else %}
                            <i class="fas fa-minus text-muted ms-2" title="Stable"></i>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3 bg-light rounded">
                            <h4 class="text-danger mb-1">{{ summary_stats.total_errors }}</h4>
                            <small class="text-muted">Total Errors</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3 bg-light rounded">
                            <h4 class="text-success mb-1">{{ summary_stats.total_policy_hits }}</h4>
                            <small class="text-muted">Policy Hits</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3 bg-light rounded">
                            <h4 class="text-info mb-1">{{ summary_stats.avg_context_usage }}%</h4>
                            <small class="text-muted">Avg Context Usage</small>
                        </div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="row">
                    <!-- Health Score Chart -->
                    <div class="col-md-6 mb-4">
                        <div class="card border h-100">
                            <div class="card-body">
                                <div class="text-center mb-3">
                                    <h6 class="mb-1">
                                        <i class="fas fa-heartbeat text-success me-2"></i>
                                        Health Score Trend
                                    </h6>
                                    <small class="text-muted">
                                        Overall system health over time (0-100%)
                                    </small>
                                </div>
                                <canvas id="healthScoreChart" height="200"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Daily Errors Chart -->
                    <div class="col-md-6 mb-4">
                        <div class="card border h-100">
                            <div class="card-body">
                                <div class="text-center mb-3">
                                    <h6 class="mb-1">
                                        <i class="fas fa-exclamation-circle text-danger me-2"></i>
                                        Daily Errors
                                    </h6>
                                    <small class="text-muted">
                                        Number of errors logged per day
                                    </small>
                                </div>
                                <canvas id="errorsChart" height="200"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Policy Hits Chart -->
                    <div class="col-md-6 mb-4">
                        <div class="card border h-100">
                            <div class="card-body">
                                <div class="text-center mb-3">
                                    <h6 class="mb-1">
                                        <i class="fas fa-shield-alt text-primary me-2"></i>
                                        Policy Hits
                                    </h6>
                                    <small class="text-muted">
                                        Automation policy executions per day
                                    </small>
                                </div>
                                <canvas id="policyHitsChart" height="200"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Context Usage Chart -->
                    <div class="col-md-6 mb-4">
                        <div class="card border h-100">
                            <div class="card-body">
                                <div class="text-center mb-3">
                                    <h6 class="mb-1">
                                        <i class="fas fa-percentage text-info me-2"></i>
                                        Context Usage
                                    </h6>
                                    <small class="text-muted">
                                        Context window utilization percentage
                                    </small>
                                </div>
                                <canvas id="contextUsageChart" height="200"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Model Usage Analysis -->
                    <div class="col-md-12">
                        <div class="card border">
                            <div class="card-body">
                                <div class="text-center mb-4">
                                    <h6 class="mb-1">
                                        <i class="fas fa-robot text-warning me-2"></i>
                                        Model Usage Analysis
                                    </h6>
                                    <small class="text-muted">
                                        AI model selection distribution and trends (Haiku/Sonnet/Opus)
                                    </small>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="text-center mb-2">
                                            <h6 class="small text-muted mb-2">
                                                <i class="fas fa-pie-chart me-1"></i>
                                                Distribution
                                            </h6>
                                            <small class="text-muted d-block mb-2">Model usage breakdown</small>
                                        </div>
                                        <canvas id="modelUsageChart" height="200"></canvas>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="text-center mb-2">
                                            <h6 class="small text-muted mb-2">
                                                <i class="fas fa-chart-line me-1"></i>
                                                Trend (Last 7 Days)
                                            </h6>
                                            <small class="text-muted d-block mb-2">Model usage over time</small>
                                        </div>
                                        <canvas id="modelUsageTrendChart" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Policy Execution Tracking -->
<div class="row mb-4">
    <div class="col-lg-8 mb-4 mb-lg-0">
        <div class="card h-100">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <h5>
                        <i class="fas fa-chart-line"></i>
                        Policy Execution Timeline
                    </h5>
                    <span class="badge bg-success" id="policyHealthBadge">Loading...</span>
                </div>
            </div>
            <div class="card-body">
                <div style="height: 400px;">
                    <canvas id="policyExecutionTimelineChart" height="350"></canvas>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Shows when automation policies are actually executed (not just running daemons)
                    </small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header">
                <h5>
                    <i class="fas fa-tasks"></i>
                    Enforcement Steps
                </h5>
            </div>
            <div class="card-body" style="overflow-y: auto;">
                <div id="enforcementSteps">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                        <p>Loading enforcement status...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Policy Executions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>
                    <i class="fas fa-history"></i>
                    Recent Policy Executions
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Policy</th>
                                <th>Category</th>
                                <th>Status</th>
                                <th>Message</th>
                            </tr>
                        </thead>
                        <tbody id="recentExecutionsTable">
                            <tr>
                                <td colspan="5" class="text-center text-muted">
                                    <i class="fas fa-spinner fa-spin"></i> Loading...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Policy Status Cards -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>
                    <i class="fas fa-shield-alt"></i>
                    Policy Status Overview
                </h5>
            </div>
            <div class="card-body">
                <div class="row" id="policyCards">
                    <div class="col-12 text-center text-muted py-4">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                        <p>Loading policies...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 3-Level Architecture Flow Status -->
<div class="row mb-4" id="threeLevelFlowWidget">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-layer-group text-primary me-2"></i>
                        3-Level Architecture Flow
                    </h5>
                    <div class="d-flex gap-2 align-items-center">
                        <span class="badge bg-info">Latest Execution</span>
                        <button class="btn btn-sm btn-outline-primary" onclick="refresh3LevelFlow()">
                            <i class="fas fa-sync-alt me-1"></i>Refresh
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body" id="threeLevelFlowBody">
                {% if flow_latest and flow_latest.overall_status %}
                <!-- Server-side rendered for initial load -->
                <div class="row g-3">
                    <!-- Level -1 -->
                    <div class="col-md-3">
                        <div class="card border-{{ 'success' if flow_latest.level_minus_1.status == 'PASS' else 'danger' }} h-100">
                            <div class="card-body text-center p-3">
                                <div class="fs-4 mb-1">
                                    <i class="fas fa-{{ 'check-circle text-success' if flow_latest.level_minus_1.status == 'PASS' else 'times-circle text-danger' }}"></i>
                                </div>
                                <div class="fw-bold small">LEVEL -1</div>
                                <div class="text-muted small">Auto-Fix Enforcement</div>
                                <div class="badge bg-{{ 'success' if flow_latest.level_minus_1.status == 'PASS' else 'danger' }} mt-1">
                                    {{ flow_latest.level_minus_1.status }}
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Level 1 -->
                    <div class="col-md-3">
                        <div class="card border-primary h-100">
                            <div class="card-body text-center p-3">
                                <div class="fs-4 mb-1">
                                    <i class="fas fa-sync-alt text-primary"></i>
                                </div>
                                <div class="fw-bold small">LEVEL 1</div>
                                <div class="text-muted small">Sync System</div>
                                {% if flow_latest.level_1.context_pct is not none %}
                                <div class="badge bg-{{ 'success' if flow_latest.level_1.context_pct < 70 else ('warning' if flow_latest.level_1.context_pct < 85 else 'danger') }} mt-1">
                                    Context: {{ flow_latest.level_1.context_pct }}%
                                </div>
                                {% else %}
                                <div class="badge bg-secondary mt-1">OK</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <!-- Level 2 -->
                    <div class="col-md-3">
                        <div class="card border-warning h-100">
                            <div class="card-body text-center p-3">
                                <div class="fs-4 mb-1">
                                    <i class="fas fa-book text-warning"></i>
                                </div>
                                <div class="fw-bold small">LEVEL 2</div>
                                <div class="text-muted small">Standards System</div>
                                {% if flow_latest.level_2.standards %}
                                <div class="badge bg-warning text-dark mt-1">
                                    {{ flow_latest.level_2.standards }} standards, {{ flow_latest.level_2.rules }} rules
                                </div>
                                {% else %}
                                <div class="badge bg-secondary mt-1">Loaded</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <!-- Level 3 -->
                    <div class="col-md-3">
                        <div class="card border-{{ 'success' if flow_latest.level_3.status in ('OK', 'ok') else 'secondary' }} h-100">
                            <div class="card-body text-center p-3">
                                <div class="fs-4 mb-1">
                                    <i class="fas fa-cogs text-{{ 'success' if flow_latest.level_3.status in ('OK', 'ok') else 'secondary' }}"></i>
                                </div>
                                <div class="fw-bold small">LEVEL 3</div>
                                <div class="text-muted small">Execution (12 steps)</div>
                                <div class="badge bg-{{ 'success' if flow_latest.level_3.status in ('OK', 'ok') else 'secondary' }} mt-1">
                                    {{ flow_latest.level_3.model or 'N/A' }}
                                    {% if flow_latest.level_3.complexity %} | C={{ flow_latest.level_3.complexity }}{% endif %}
                                </div>
                                {% if flow_latest.execution_mode %}
                                <div class="badge bg-{{ 'info' if flow_latest.execution_mode == 'parallel' else 'light text-dark' }} mt-1">
                                    <i class="fas fa-{{ 'project-diagram' if flow_latest.execution_mode == 'parallel' else 'stream' }}"></i>
                                    {{ flow_latest.execution_mode | capitalize }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Execution Details Row -->
                <div class="row mt-3">
                    <div class="col-md-8">
                        <div class="bg-light rounded p-3">
                            <div class="row g-2 text-center">
                                <div class="col-3">
                                    <div class="text-muted small">Session</div>
                                    <div class="fw-bold small text-truncate" title="{{ flow_latest.session_id }}">
                                        {{ flow_latest.session_id[-12:] if flow_latest.session_id else 'N/A' }}
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="text-muted small">Task Type</div>
                                    <div class="fw-bold small">{{ flow_latest.level_3.task_type or 'N/A' }}</div>
                                </div>
                                <div class="col-3">
                                    <div class="text-muted small">Tasks</div>
                                    <div class="fw-bold small">{{ flow_latest.level_3.tasks or 'N/A' }}</div>
                                </div>
                                <div class="col-3">
                                    <div class="text-muted small">Duration</div>
                                    <div class="fw-bold small">
                                        {{ '%.1fs' % flow_latest.duration if flow_latest.duration else 'N/A' }}
                                    </div>
                                </div>
                            </div>
                            {% if flow_latest.tech_stack or flow_latest.agent_type %}
                            <div class="row g-2 text-center mt-1 pt-1 border-top">
                                <div class="col-4">
                                    <div class="text-muted small">Tech Stack</div>
                                    <div class="small">
                                        {% if flow_latest.tech_stack %}
                                            {% for tech in flow_latest.tech_stack[:3] %}
                                            <span class="badge bg-secondary">{{ tech }}</span>
                                            {% endfor %}
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="text-muted small">Agent/Skill</div>
                                    <div class="fw-bold small">
                                        {% if flow_latest.agent_type %}
                                        <span class="badge bg-{{ 'primary' if flow_latest.agent_type == 'agent' else 'secondary' }}">{{ flow_latest.agent_type }}</span>
                                        {% endif %}
                                        <span class="small text-truncate d-block" title="{{ flow_latest.level_3.skill_agent }}">
                                            {{ (flow_latest.level_3.skill_agent or 'N/A')[:20] }}
                                        </span>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="text-muted small">Extras</div>
                                    <div class="small">
                                        {% if flow_latest.supplementary_skills %}
                                            {% for sk in flow_latest.supplementary_skills[:2] %}
                                            <span class="badge bg-light text-dark">{{ sk }}</span>
                                            {% endfor %}
                                        {% else %}
                                            <span class="text-muted">None</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="bg-light rounded p-3 text-center">
                            <div class="text-muted small mb-1">Last Prompt</div>
                            <div class="small text-truncate" title="{{ flow_latest.user_prompt }}">
                                {{ flow_latest.user_prompt[:60] + '...' if flow_latest.user_prompt and flow_latest.user_prompt|length > 60 else (flow_latest.user_prompt or 'N/A') }}
                            </div>
                            <div class="text-muted x-small mt-1">{{ flow_latest.started or 'N/A' }}</div>
                            {% if flow_latest.model_reason %}
                            <div class="text-muted x-small mt-1" title="{{ flow_latest.model_reason }}">
                                <i class="fas fa-info-circle"></i> {{ flow_latest.model_reason[:50] }}{% if flow_latest.model_reason|length > 50 %}...{% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% else %}
                <!-- Loading state -->
                <div class="text-center text-muted py-4" id="flowLoadingState">
                    <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                    <p>Loading 3-level flow data...</p>
                </div>
                {% endif %}
            </div>

            <!-- Stats footer -->
            {% if flow_stats %}
            <div class="card-footer bg-transparent">
                <div class="row text-center g-2">
                    <div class="col">
                        <div class="text-muted small">Total Sessions</div>
                        <div class="fw-bold">{{ flow_stats.total_sessions }}</div>
                    </div>
                    <div class="col">
                        <div class="text-muted small">Success Rate</div>
                        <div class="fw-bold text-success">{{ flow_stats.success_rate }}%</div>
                    </div>
                    <div class="col">
                        <div class="text-muted small">Avg Complexity</div>
                        <div class="fw-bold">{{ flow_stats.avg_complexity }}</div>
                    </div>
                    <div class="col">
                        <div class="text-muted small">Plan Mode Rate</div>
                        <div class="fw-bold">{{ flow_stats.plan_mode_rate }}%</div>
                    </div>
                    <div class="col">
                        <div class="text-muted small">Avg Context</div>
                        <div class="fw-bold">{{ flow_stats.avg_context_usage }}%</div>
                    </div>
                    {% if flow_stats.model_distribution %}
                    <div class="col">
                        <div class="text-muted small">Top Model</div>
                        <div class="fw-bold">
                            {% set top_model = flow_stats.model_distribution | dictsort(by='value', reverse=True) | first %}
                            {{ top_model[0] if top_model else 'N/A' }}
                        </div>
                    </div>
                    {% endif %}
                    {% if flow_stats.tech_stack_distribution %}
                    <div class="col">
                        <div class="text-muted small">Top Stack</div>
                        <div class="fw-bold">
                            {% set top_tech = flow_stats.tech_stack_distribution | dictsort(by='value', reverse=True) | first %}
                            {{ top_tech[0] if top_tech else 'N/A' }}
                        </div>
                    </div>
                    {% endif %}
                    {% if flow_stats.execution_mode_distribution %}
                    <div class="col">
                        <div class="text-muted small">Exec Mode</div>
                        <div class="fw-bold">
                            {% set parallel_count = flow_stats.execution_mode_distribution.get('parallel', 0) %}
                            {% set seq_count = flow_stats.execution_mode_distribution.get('sequential', 0) %}
                            {% if parallel_count > seq_count %}
                            <span class="text-info">Parallel</span>
                            {% else %}
                            <span class="text-secondary">Sequential</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- System Information -->
<div class="row">
    <div class="col-lg-6 mb-4 mb-lg-0">
        <div class="card h-100">
            <div class="card-header">
                <h5>
                    <i class="fas fa-info-circle"></i>
                    System Information
                </h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tbody id="systemInfo">
                        <tr>
                            <td class="text-muted">Status:</td>
                            <td><i class="fas fa-spinner fa-spin"></i> Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">
                <h5>
                    <i class="fas fa-exclamation-triangle"></i>
                    Recent Errors
                </h5>
            </div>
            <div class="card-body" style="overflow-y: auto;">
                <div id="recentErrors">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                        <p>Loading errors...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

</div>
<!-- End Sortable Widgets Container -->

<!-- Widget Customization Modal -->
<div class="modal fade" id="widgetCustomizeModal" tabindex="-1" aria-labelledby="widgetCustomizeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="widgetCustomizeModalLabel">
                    <i class="fas fa-cog me-2"></i>Customize Dashboard Widgets
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small mb-3">
                    <i class="fas fa-info-circle me-1"></i>
                    Select which widgets you want to display on your dashboard
                </p>

                <div class="list-group">
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-heartbeat text-success me-2"></i>
                            <strong>System Health</strong>
                            <br><small class="text-muted">Health score, daemons, context usage</small>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="widget_system_health" checked>
                        </div>
                    </div>

                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-server text-primary me-2"></i>
                            <strong>Daemon Status</strong>
                            <br><small class="text-muted">Status of all running daemons</small>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="widget_daemon_status" checked>
                        </div>
                    </div>

                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-shield-alt text-info me-2"></i>
                            <strong>Policy Status</strong>
                            <br><small class="text-muted">Active policies and their status</small>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="widget_policy_status" checked>
                        </div>
                    </div>

                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-chart-area text-warning me-2"></i>
                            <strong>Historical Charts</strong>
                            <br><small class="text-muted">7/30/60/90 day trend charts</small>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="widget_historical_charts" checked>
                        </div>
                    </div>

                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-list text-secondary me-2"></i>
                            <strong>Recent Activity</strong>
                            <br><small class="text-muted">Recent system activities and logs</small>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="widget_recent_activity" checked>
                        </div>
                    </div>

                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                            <strong>Recent Errors</strong>
                            <br><small class="text-muted">Latest system errors</small>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="widget_recent_errors" checked>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveWidgetPreferences()">
                    <i class="fas fa-save me-2"></i>Save Preferences
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
let metricsChart;
let autoRefreshInterval;
let socket;
let isWebSocketConnected = false;

document.addEventListener('DOMContentLoaded', function() {
    initializeDashboard();
    initializeWebSocket();
    initializeSortableWidgets();
    // Only start auto-refresh as fallback if WebSocket fails
});

function initializeDashboard() {
    loadMetrics();
    loadActivityFeed();
    loadPolicyStatus();
    loadSystemInfo();
    loadRecentErrors();
    initializeChart();
    load3LevelFlow();
}

function loadMetrics() {
    fetch('/api/metrics')
        .then(response => response.json())
        .then(data => {
            // Update health score
            const healthScore = data.health_score || 0;
            document.getElementById('healthScore').innerHTML = `
                <span class="text-${getHealthColor(healthScore)}">${healthScore}%</span>
            `;
            document.getElementById('healthScoreBar').style.width = healthScore + '%';
            document.getElementById('healthScoreBar').className = `progress-bar bg-${getHealthColor(healthScore)} bg-gradient`;

            // Update daemons
            const daemonsRunning = data.daemons_running || 0;
            const totalDaemons = data.daemons_total || 0;
            document.getElementById('daemonsRunning').innerHTML = `
                <span class="text-${daemonsRunning === totalDaemons ? 'success' : 'warning'}">${daemonsRunning}/${totalDaemons}</span>
            `;
            document.getElementById('daemonStatus').textContent = daemonsRunning === totalDaemons ? 'All systems operational' : 'Some daemons offline';

            // Update active policies
            const activePolicies = data.active_policies || 0;
            const totalPolicies = data.total_policies || 0;
            document.getElementById('activePolicies').innerHTML = `
                <span class="text-primary">${activePolicies}</span>
            `;
            document.getElementById('totalPoliciesText').textContent = `Out of ${totalPolicies} total`;

            // Update policy hits
            const policyHits = data.policy_hits_today || 0;
            document.getElementById('policyHits').innerHTML = `
                <span class="text-info">${policyHits}</span>
            `;

            // Update chart
            if (metricsChart && data.metrics_history) {
                updateChart(data.metrics_history);
            }
        })
        .catch(error => {
            console.error('Error loading metrics:', error);
            showError('Failed to load metrics');
        });
}

function loadActivityFeed() {
    fetch('/api/activity')
        .then(response => response.json())
        .then(data => {
            const feedContainer = document.getElementById('activityFeed');
            if (!data.activities || data.activities.length === 0) {
                feedContainer.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-2x mb-3"></i>
                        <p>No recent activity</p>
                    </div>
                `;
                return;
            }

            feedContainer.innerHTML = data.activities.map(activity => `
                <div class="activity-item mb-3 pb-3 border-bottom">
                    <div class="d-flex align-items-start">
                        <div class="flex-shrink-0">
                            <span class="badge bg-${getActivityColor(activity.type)} rounded-circle p-2">
                                <i class="fas ${getActivityIcon(activity.type)}"></i>
                            </span>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <p class="mb-1 small">${activity.message}</p>
                            <small class="text-muted">
                                <i class="far fa-clock me-1"></i>${activity.timestamp}
                            </small>
                        </div>
                    </div>
                </div>
            `).join('');
        })
        .catch(error => {
            console.error('Error loading activity:', error);
            document.getElementById('activityFeed').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Failed to load activity feed
                </div>
            `;
        });
}

function loadPolicyStatus() {
    fetch('/api/policies')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('policyCards');
            if (!data.policies || data.policies.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center text-muted py-4">
                        <i class="fas fa-exclamation-circle fa-2x mb-3"></i>
                        <p>No policies found</p>
                    </div>
                `;
                return;
            }

            // Group policies by level
            const groupedPolicies = {};
            data.policies.forEach(policy => {
                const level = policy.level || 'Other';
                if (!groupedPolicies[level]) {
                    groupedPolicies[level] = [];
                }
                groupedPolicies[level].push(policy);
            });

            // Sort policies within each level by phase
            Object.keys(groupedPolicies).forEach(level => {
                groupedPolicies[level].sort((a, b) => a.phase_num - b.phase_num);
            });

            // Define level order and styling
            const levelOrder = ['LEVEL -1', 'LEVEL 1', 'LEVEL 2', 'LEVEL 3', 'Infrastructure'];
            const levelInfo = {
                'LEVEL -1': { icon: 'fa-shield-alt', color: 'danger', title: 'Auto-Fix Enforcement' },
                'LEVEL 1': { icon: 'fa-sync-alt', color: 'primary', title: 'Sync System (Foundation)' },
                'LEVEL 2': { icon: 'fa-book', color: 'info', title: 'Standards System' },
                'LEVEL 3': { icon: 'fa-cogs', color: 'success', title: 'Execution System' },
                'Infrastructure': { icon: 'fa-server', color: 'secondary', title: 'Infrastructure' }
            };

            let html = '';

            levelOrder.forEach(level => {
                if (groupedPolicies[level]) {
                    const info = levelInfo[level];
                    const policies = groupedPolicies[level];

                    html += `
                        <div class="col-12 mb-3">
                            <div class="d-flex align-items-center mb-3">
                                <div class="me-3">
                                    <div class="bg-${info.color} text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                        <i class="fas ${info.icon}"></i>
                                    </div>
                                </div>
                                <div>
                                    <h5 class="mb-0 text-${info.color}">${level}</h5>
                                    <small class="text-muted">${info.title}</small>
                                </div>
                                <div class="ms-auto">
                                    <span class="badge bg-${info.color}">${policies.length} ${policies.length === 1 ? 'policy' : 'policies'}</span>
                                </div>
                            </div>
                        </div>
                    `;

                    policies.forEach(policy => {
                        html += `
                            <div class="col-md-4 mb-3">
                                <div class="card border-start border-${info.color} border-3 h-100 shadow-sm">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="mb-0">${policy.name}</h6>
                                            <span class="badge bg-${policy.status === 'active' ? 'success' : (policy.status === 'warning' ? 'warning' : 'secondary')}">
                                                ${policy.status}
                                            </span>
                                        </div>
                                        <p class="small text-muted mb-2">${policy.description || 'No description'}</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">
                                                <i class="fas fa-chart-line me-1"></i>
                                                ${policy.hits || 0} hits
                                            </small>
                                            <small class="badge bg-light text-dark">
                                                ${policy.phase || 'N/A'}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
            });

            container.innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading policies:', error);
            document.getElementById('policyCards').innerHTML = `
                <div class="col-12">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Failed to load policy status
                    </div>
                </div>
            `;
        });
}

function loadSystemInfo() {
    fetch('/api/system-info')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('systemInfo');

            // Determine badge color based on status
            const statusBadgeColor = data.status === 'Operational' ? 'success' :
                                    (data.status === 'Healthy' ? 'info' : 'warning');

            container.innerHTML = `
                <tr>
                    <td class="text-muted">Status:</td>
                    <td><span class="badge bg-${statusBadgeColor}">${data.status || 'Unknown'}</span></td>
                </tr>
                <tr>
                    <td class="text-muted">Memory Path:</td>
                    <td><code>${data.memory_path || 'N/A'}</code></td>
                </tr>
                <tr>
                    <td class="text-muted">Last Update:</td>
                    <td>${data.last_update || 'Unknown'}</td>
                </tr>
                <tr>
                    <td class="text-muted">Uptime:</td>
                    <td>${data.uptime || 'N/A'}</td>
                </tr>
            `;
        })
        .catch(error => {
            console.error('Error loading system info:', error);
            document.getElementById('systemInfo').innerHTML = `
                <tr>
                    <td colspan="2">
                        <div class="alert alert-danger mb-0">
                            Failed to load system information
                        </div>
                    </td>
                </tr>
            `;
        });
}

function loadRecentErrors() {
    fetch('/api/recent-errors')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('recentErrors');
            if (!data.errors || data.errors.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-check-circle fa-2x mb-3 text-success"></i>
                        <p>No recent errors</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = data.errors.map(error => `
                <div class="alert alert-danger py-2 px-3 mb-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>${error.message}</strong>
                            <br>
                            <small class="text-muted">${error.timestamp}</small>
                        </div>
                        <span class="badge bg-danger">${error.level}</span>
                    </div>
                </div>
            `).join('');
        })
        .catch(error => {
            console.error('Error loading recent errors:', error);
            document.getElementById('recentErrors').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Failed to load recent errors
                </div>
            `;
        });
}

function initializeChart() {
    const ctx = document.getElementById('metricsChart').getContext('2d');
    metricsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Policy Executions (Live)',
                data: [],
                borderColor: 'rgb(16, 185, 129)',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Executions: ' + context.parsed.y;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 100
                    },
                    title: {
                        display: true,
                        text: 'Number of Executions'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Time (Hourly)'
                    }
                }
            }
        }
    });
}

function updateChart(data) {
    if (!metricsChart || !data) return;

    // Update with real-time policy execution data
    metricsChart.data.labels = data.labels || [];
    metricsChart.data.datasets[0].data = data.policy_executions || [];
    metricsChart.update();
}

function refreshDashboard() {
    const btn = event.target.closest('button');
    const icon = btn.querySelector('i');
    icon.classList.add('fa-spin');

    initializeDashboard();
    load3LevelFlow();

    setTimeout(() => {
        icon.classList.remove('fa-spin');
    }, 1000);
}

// 3-Level Flow Widget Functions
function refresh3LevelFlow() {
    const btn = event.target.closest('button');
    const icon = btn ? btn.querySelector('i') : null;
    if (icon) icon.classList.add('fa-spin');
    load3LevelFlow();
    setTimeout(() => {
        if (icon) icon.classList.remove('fa-spin');
    }, 1000);
}

function load3LevelFlow() {
    fetch('/api/3level-flow/latest')
        .then(r => r.json())
        .then(data => {
            if (!data.success || !data.available) return;
            render3LevelFlow(data.session);
        })
        .catch(err => console.warn('3-level flow fetch error:', err));
}

function render3LevelFlow(s) {
    const body = document.getElementById('threeLevelFlowBody');
    if (!body || !s) return;

    const l1Status = s.level_minus_1 && s.level_minus_1.status === 'PASS';
    const l3ok = s.level_3 && (s.level_3.status === 'OK' || s.level_3.status === 'ok');
    const ctxPct = s.level_1 && s.level_1.context_pct != null ? s.level_1.context_pct : null;
    const ctxBadge = ctxPct == null ? 'secondary' : (ctxPct < 70 ? 'success' : (ctxPct < 85 ? 'warning' : 'danger'));

    body.innerHTML = `
    <div class="row g-3">
        <div class="col-md-3">
            <div class="card border-${l1Status ? 'success' : 'danger'} h-100">
                <div class="card-body text-center p-3">
                    <div class="fs-4 mb-1"><i class="fas fa-${l1Status ? 'check-circle text-success' : 'times-circle text-danger'}"></i></div>
                    <div class="fw-bold small">LEVEL -1</div>
                    <div class="text-muted small">Auto-Fix Enforcement</div>
                    <div class="badge bg-${l1Status ? 'success' : 'danger'} mt-1">${s.level_minus_1 ? s.level_minus_1.status : 'unknown'}</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-primary h-100">
                <div class="card-body text-center p-3">
                    <div class="fs-4 mb-1"><i class="fas fa-sync-alt text-primary"></i></div>
                    <div class="fw-bold small">LEVEL 1</div>
                    <div class="text-muted small">Sync System</div>
                    <div class="badge bg-${ctxBadge} mt-1">${ctxPct != null ? 'Context: ' + ctxPct + '%' : 'OK'}</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-warning h-100">
                <div class="card-body text-center p-3">
                    <div class="fs-4 mb-1"><i class="fas fa-book text-warning"></i></div>
                    <div class="fw-bold small">LEVEL 2</div>
                    <div class="text-muted small">Standards System</div>
                    <div class="badge bg-warning text-dark mt-1">
                        ${s.level_2 && s.level_2.standards ? s.level_2.standards + ' std, ' + s.level_2.rules + ' rules' : 'Loaded'}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-${l3ok ? 'success' : 'secondary'} h-100">
                <div class="card-body text-center p-3">
                    <div class="fs-4 mb-1"><i class="fas fa-cogs text-${l3ok ? 'success' : 'secondary'}"></i></div>
                    <div class="fw-bold small">LEVEL 3</div>
                    <div class="text-muted small">Execution (12 steps)</div>
                    <div class="badge bg-${l3ok ? 'success' : 'secondary'} mt-1">
                        ${s.level_3 && s.level_3.model ? s.level_3.model : 'N/A'}
                        ${s.level_3 && s.level_3.complexity ? ' | C=' + s.level_3.complexity : ''}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row mt-3">
        <div class="col-md-8">
            <div class="bg-light rounded p-3">
                <div class="row g-2 text-center">
                    <div class="col-3">
                        <div class="text-muted small">Session</div>
                        <div class="fw-bold small text-truncate" title="${s.session_id || ''}">${s.session_id ? s.session_id.slice(-12) : 'N/A'}</div>
                    </div>
                    <div class="col-3">
                        <div class="text-muted small">Task Type</div>
                        <div class="fw-bold small">${s.level_3 && s.level_3.task_type || 'N/A'}</div>
                    </div>
                    <div class="col-3">
                        <div class="text-muted small">Tasks</div>
                        <div class="fw-bold small">${s.level_3 && s.level_3.tasks != null ? s.level_3.tasks : 'N/A'}</div>
                    </div>
                    <div class="col-3">
                        <div class="text-muted small">Duration</div>
                        <div class="fw-bold small">${s.duration != null ? s.duration.toFixed(1) + 's' : 'N/A'}</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="bg-light rounded p-3 text-center">
                <div class="text-muted small mb-1">Last Prompt</div>
                <div class="small text-truncate" title="${s.user_prompt || ''}">${s.user_prompt ? (s.user_prompt.length > 60 ? s.user_prompt.slice(0, 60) + '...' : s.user_prompt) : 'N/A'}</div>
                <div class="text-muted" style="font-size:0.7rem;">${s.started || ''}</div>
            </div>
        </div>
    </div>`;
}

function startAutoRefresh() {
    autoRefreshInterval = setInterval(() => {
        loadMetrics();
        loadActivityFeed();
        loadRecentErrors();
    }, 30000); // Refresh every 30 seconds
}

function getHealthColor(score) {
    if (score >= 80) return 'success';
    if (score >= 60) return 'warning';
    return 'danger';
}

function getActivityColor(type) {
    const colors = {
        'policy': 'primary',
        'error': 'danger',
        'warning': 'warning',
        'success': 'success',
        'info': 'info'
    };
    return colors[type] || 'secondary';
}

function getActivityIcon(type) {
    const icons = {
        'policy': 'fa-shield-alt',
        'error': 'fa-exclamation-circle',
        'warning': 'fa-exclamation-triangle',
        'success': 'fa-check-circle',
        'info': 'fa-info-circle'
    };
    return icons[type] || 'fa-circle';
}

function showError(message) {
    console.error(message);
}

// Initialize Historical Charts
function initializeHistoricalCharts() {
    try {
        const chartData = {{ chart_data | tojson | safe }};

        if (!chartData || !chartData.dates || chartData.dates.length === 0) {
            console.warn('No historical data available');
            // Hide chart containers or show placeholder
            const chartContainers = document.querySelectorAll('.col-md-6 canvas');
            chartContainers.forEach(canvas => {
                const parent = canvas.parentElement;
                if (parent) {
                    parent.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-chart-line fa-2x mb-2"></i>
                            <p class="small">No historical data available yet</p>
                        </div>
                    `;
                }
            });
            return;
        }

        const labels = chartData.dates.map(date => {
            const d = new Date(date);
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });

    // Common chart options
    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                min: 0,
                ticks: {
                    stepSize: 10,
                    callback: function(value) {
                        return Math.max(0, value);
                    }
                },
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                }
            },
            x: {
                grid: {
                    display: false
                }
            }
        }
    };

    // Health Score Chart
    try {
        const healthCanvas = document.getElementById('healthScoreChart');
        if (healthCanvas) {
            new Chart(healthCanvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Health Score',
                        data: chartData.health_scores || [],
                        borderColor: 'rgb(16, 185, 129)',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y: {
                            ...commonOptions.scales.y,
                            min: 0,
                            max: 100,
                            ticks: {
                                stepSize: 20,
                                callback: function(value) {
                                    return Math.max(0, Math.min(100, value));
                                }
                            }
                        }
                    }
                }
            });
        }
    } catch (error) {
        console.error('Error creating health score chart:', error);
    }

    // Errors Chart
    try {
        const errorsCanvas = document.getElementById('errorsChart');
        if (errorsCanvas) {
            new Chart(errorsCanvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Errors',
                        data: chartData.errors || [],
                        backgroundColor: 'rgba(239, 68, 68, 0.7)',
                        borderColor: 'rgb(239, 68, 68)',
                        borderWidth: 1
                    }]
                },
                options: commonOptions
            });
        }
    } catch (error) {
        console.error('Error creating errors chart:', error);
    }

    // Policy Hits Chart
    try {
        const policyCanvas = document.getElementById('policyHitsChart');
        if (policyCanvas) {
            new Chart(policyCanvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Policy Hits',
                        data: chartData.policy_hits || [],
                        borderColor: 'rgb(99, 102, 241)',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: commonOptions
            });
        }
    } catch (error) {
        console.error('Error creating policy hits chart:', error);
    }

    // Context Usage Chart
    try {
        const contextCanvas = document.getElementById('contextUsageChart');
        if (contextCanvas) {
            new Chart(contextCanvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Context Usage %',
                        data: chartData.context_usage || [],
                        borderColor: 'rgb(245, 158, 11)',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y: {
                            ...commonOptions.scales.y,
                            min: 0,
                            max: 100,
                            ticks: {
                                stepSize: 20,
                                callback: function(value) {
                                    return Math.max(0, Math.min(100, value)) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
    } catch (error) {
        console.error('Error creating context usage chart:', error);
    }
    } catch (error) {
        console.error('Error initializing historical charts:', error);
    }
}

// Initialize Model Usage Chart
function initializeModelUsageChart() {
    fetch('/api/model-usage')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const canvas = document.getElementById('modelUsageChart');
                if (canvas) {
                    // Store percentage data in closure for access in callbacks
                    const percentageData = data.percentage_data || [0, 0, 0];

                    new Chart(canvas.getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: ['Haiku', 'Sonnet', 'Opus'],
                            datasets: [{
                                data: data.usage || [0, 0, 0],
                                backgroundColor: [
                                    'rgba(99, 102, 241, 0.8)',  // Haiku - Blue
                                    'rgba(139, 92, 246, 0.8)',  // Sonnet - Purple
                                    'rgba(236, 72, 153, 0.8)'   // Opus - Pink
                                ],
                                borderWidth: 2,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        padding: 15,
                                        usePointStyle: true,
                                        font: {
                                            size: 12
                                        },
                                        generateLabels: function(chart) {
                                            const chartData = chart.data;
                                            if (chartData.labels.length && chartData.datasets.length) {
                                                return chartData.labels.map((label, i) => {
                                                    const value = chartData.datasets[0].data[i];
                                                    const percentage = percentageData[i] || 0;
                                                    return {
                                                        text: `${label}: ${percentage.toFixed(1)}%`,
                                                        fillStyle: chartData.datasets[0].backgroundColor[i],
                                                        hidden: false,
                                                        index: i
                                                    };
                                                });
                                            }
                                            return [];
                                        }
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.parsed || 0;
                                            const percentage = percentageData[context.dataIndex] || 0;
                                            return `${label}: ${value} requests (${percentage.toFixed(1)}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }
        })
        .catch(error => {
            console.error('Error loading model usage data:', error);
        });
}

// Initialize Model Usage Trend Chart (Line Chart)
function initializeModelUsageTrendChart() {
    fetch('/api/model-usage-trend')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const canvas = document.getElementById('modelUsageTrendChart');
                if (canvas) {
                    new Chart(canvas.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: data.labels || [],
                            datasets: [
                                {
                                    label: 'Haiku',
                                    data: data.haiku_data || [],
                                    borderColor: 'rgba(99, 102, 241, 1)',
                                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                                    borderWidth: 2,
                                    fill: true,
                                    tension: 0.4
                                },
                                {
                                    label: 'Sonnet',
                                    data: data.sonnet_data || [],
                                    borderColor: 'rgba(139, 92, 246, 1)',
                                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                                    borderWidth: 2,
                                    fill: true,
                                    tension: 0.4
                                },
                                {
                                    label: 'Opus',
                                    data: data.opus_data || [],
                                    borderColor: 'rgba(236, 72, 153, 1)',
                                    backgroundColor: 'rgba(236, 72, 153, 0.1)',
                                    borderWidth: 2,
                                    fill: true,
                                    tension: 0.4
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        padding: 10,
                                        usePointStyle: true,
                                        font: {
                                            size: 11
                                        }
                                    }
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.dataset.label || '';
                                            const value = context.parsed.y || 0;
                                            return `${label}: ${value} requests`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    },
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    }
                                },
                                x: {
                                    grid: {
                                        display: false
                                    }
                                }
                            },
                            interaction: {
                                mode: 'nearest',
                                axis: 'x',
                                intersect: false
                            }
                        }
                    });
                }
            }
        })
        .catch(error => {
            console.error('Error loading model usage trend data:', error);
        });
}

// Initialize Policy Execution Tracking
function initializePolicyExecutionTracking() {
    // Fetch enforcement status
    fetch('/api/enforcement-status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateEnforcementSteps(data.enforcement);
                updatePolicyHealth(data.health);
            }
        })
        .catch(error => {
            console.error('Error loading enforcement status:', error);
        });

    // Fetch policy timeline
    fetch('/api/policy-timeline?hours=24')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                createPolicyTimelineChart(data.timeline);
                updateRecentExecutions(data.recent_executions);
            }
        })
        .catch(error => {
            console.error('Error loading policy timeline:', error);
        });
}

function updateEnforcementSteps(enforcement) {
    const container = document.getElementById('enforcementSteps');
    if (!container || !enforcement || !enforcement.steps) return;

    let html = '';
    enforcement.steps.forEach(step => {
        const icon = step.completed ?
            '<i class="fas fa-check-circle text-success me-2"></i>' :
            '<i class="fas fa-circle text-secondary me-2"></i>';

        const layerColors = {
            'SYNC': 'primary',
            'STANDARDS': 'success',
            'EXECUTION': 'danger'
        };

        const layerColor = layerColors[step.layer] || 'secondary';

        html += `
            <div class="mb-3 p-2 border-start border-${layerColor} border-3">
                <div class="d-flex align-items-center">
                    ${icon}
                    <div class="flex-grow-1">
                        <strong>${step.name}</strong>
                        <small class="text-muted ms-2">
                            <span class="badge bg-${layerColor}">${step.layer}</span>
                        </small>
                    </div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

function updatePolicyHealth(health) {
    const badge = document.getElementById('policyHealthBadge');
    if (!badge || !health) return;

    const statusClasses = {
        'EXCELLENT': 'bg-success',
        'GOOD': 'bg-info',
        'FAIR': 'bg-warning',
        'POOR': 'bg-danger'
    };

    badge.className = `badge ms-2 ${statusClasses[health.status] || 'bg-secondary'}`;
    badge.textContent = `${health.status} (${health.health_score}/100)`;
}

function createPolicyTimelineChart(timeline) {
    try {
        const canvas = document.getElementById('policyExecutionTimelineChart');
        if (!canvas || !timeline) return;

        new Chart(canvas.getContext('2d'), {
            type: 'line',
            data: {
                labels: timeline.labels || [],
                datasets: [{
                    label: 'Policy Executions',
                    data: timeline.data || [],
                    borderColor: 'rgb(99, 102, 241)',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        min: 0,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error creating policy timeline chart:', error);
    }
}

function updateRecentExecutions(executions) {
    const tbody = document.getElementById('recentExecutionsTable');
    if (!tbody || !executions) return;

    if (executions.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted">No recent policy executions</td>
            </tr>
        `;
        return;
    }

    let html = '';
    executions.forEach(exec => {
        const timestamp = new Date(exec.timestamp);
        const timeStr = timestamp.toLocaleTimeString();

        const statusBadges = {
            'OK': 'success',
            'CHECK': 'success',
            'SKIP': 'warning',
            'ERROR': 'danger',
            'SLEEP': 'secondary'
        };

        const badgeClass = statusBadges[exec.status] || 'secondary';

        html += `
            <tr>
                <td><small>${timeStr}</small></td>
                <td><code>${exec.policy_name}</code></td>
                <td><span class="badge bg-info">${exec.policy_category}</span></td>
                <td><span class="badge bg-${badgeClass}">${exec.status}</span></td>
                <td><small class="text-muted">${exec.message}</small></td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
}

// Call this after page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeHistoricalCharts();
    initializeModelUsageChart();
    initializeModelUsageTrendChart();
    initializePolicyExecutionTracking();
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
});

// Widget Customization Functions
function loadWidgetPreferences() {
    fetch('/api/widget-preferences')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const prefs = data.preferences;

                // Update checkboxes in modal
                document.getElementById('widget_system_health').checked = prefs.system_health !== false;
                document.getElementById('widget_daemon_status').checked = prefs.daemon_status !== false;
                document.getElementById('widget_policy_status').checked = prefs.policy_status !== false;
                document.getElementById('widget_historical_charts').checked = prefs.historical_charts !== false;
                document.getElementById('widget_recent_activity').checked = prefs.recent_activity !== false;
                document.getElementById('widget_recent_errors').checked = prefs.recent_errors !== false;
            }
        })
        .catch(error => {
            console.error('Error loading widget preferences:', error);
        });
}

function saveWidgetPreferences() {
    const preferences = {
        system_health: document.getElementById('widget_system_health').checked,
        daemon_status: document.getElementById('widget_daemon_status').checked,
        policy_status: document.getElementById('widget_policy_status').checked,
        historical_charts: document.getElementById('widget_historical_charts').checked,
        recent_activity: document.getElementById('widget_recent_activity').checked,
        recent_errors: document.getElementById('widget_recent_errors').checked
    };

    fetch('/api/widget-preferences', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ preferences: preferences })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('widgetCustomizeModal'));
            modal.hide();

            // Show success message
            showToast('Success', 'Widget preferences saved successfully!', 'success');

            // Reload page to apply changes
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showToast('Error', 'Failed to save preferences: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error saving widget preferences:', error);
        showToast('Error', 'Failed to save preferences', 'danger');
    });
}

function showToast(title, message, type) {
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        toastContainer.style.zIndex = '11';
        document.body.appendChild(toastContainer);
    }

    const toastId = 'toast_' + Date.now();
    const bgClass = type === 'success' ? 'bg-success' : (type === 'danger' ? 'bg-danger' : 'bg-info');

    const toastHtml = `
        <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <strong>${title}</strong><br>${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;

    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
    toast.show();

    // Remove toast after it's hidden
    toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
    });
}

// Load widget preferences when modal is opened
document.getElementById('widgetCustomizeModal')?.addEventListener('show.bs.modal', function() {
    loadWidgetPreferences();
});

// ============================================================
// WebSocket Real-time Updates
// ============================================================

function initializeWebSocket() {
    console.log('Initializing WebSocket connection...');

    // Connect to WebSocket server
    socket = io();

    // Connection established
    socket.on('connect', function() {
        console.log(' WebSocket connected!');
        isWebSocketConnected = true;
        updateConnectionStatus(true);

        // Stop polling if it's running
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
    });

    // Connection error
    socket.on('connect_error', function(error) {
        console.error(' WebSocket connection error:', error);
        isWebSocketConnected = false;
        updateConnectionStatus(false);

        // Fallback to polling
        if (!autoRefreshInterval) {
            console.log('Falling back to HTTP polling...');
            startAutoRefresh();
        }
    });

    // Disconnected
    socket.on('disconnect', function() {
        console.log(' WebSocket disconnected');
        isWebSocketConnected = false;
        updateConnectionStatus(false);

        // Fallback to polling
        if (!autoRefreshInterval) {
            console.log('Falling back to HTTP polling...');
            startAutoRefresh();
        }
    });

    // Receive metrics updates
    socket.on('metrics_update', function(data) {
        console.log(' Received real-time metrics:', data);
        updateDashboardWithWebSocketData(data);
    });

    // Receive LIVE policy executions (real-time event streaming!)
    socket.on('policy_execution', function(data) {
        console.log(' LIVE Policy Execution:', data);
        addPolicyExecutionToChart(data);
    });

    // Connection response
    socket.on('connection_response', function(data) {
        console.log('Connection response:', data);
    });

    // Error handling
    socket.on('error', function(error) {
        console.error('WebSocket error:', error);
    });
}

// Global counter for real-time executions
let executionCounter = 0;
const MAX_LIVE_DATAPOINTS = 30; // Show last 30 executions

function addPolicyExecutionToChart(execution) {
    if (!metricsChart) return;

    // Increment counter
    executionCounter++;

    // Add new data point
    const timeLabel = execution.time_ago || 'now';
    metricsChart.data.labels.push(timeLabel);
    metricsChart.data.datasets[0].data.push(executionCounter);

    // Keep only last N data points (rolling window)
    if (metricsChart.data.labels.length > MAX_LIVE_DATAPOINTS) {
        metricsChart.data.labels.shift();
        metricsChart.data.datasets[0].data.shift();
    }

    // Update chart
    metricsChart.update('none'); // 'none' for no animation = faster updates
}

function updateConnectionStatus(connected) {
    const badge = document.getElementById('autoRefreshBadge');
    if (badge) {
        if (connected) {
            badge.innerHTML = '<i class="fas fa-bolt me-1"></i>Real-time: WebSocket';
            badge.className = 'badge bg-success fs-6';
        } else {
            badge.innerHTML = '<i class="fas fa-sync-alt fa-spin me-1"></i>Auto-refresh: 30s';
            badge.className = 'badge bg-warning fs-6';
        }
    }
}

function updateDashboardWithWebSocketData(data) {
    try {
        // Update health score
        const healthScoreEl = document.getElementById('healthScore');
        if (healthScoreEl) {
            healthScoreEl.innerHTML = `
                <div class="text-${getHealthColor(data.health_score)}">${data.health_score}%</div>
            `;
        }

        // Update health score bar
        const healthScoreBar = document.getElementById('healthScoreBar');
        if (healthScoreBar) {
            healthScoreBar.style.width = data.health_score + '%';
            healthScoreBar.className = `progress-bar bg-gradient bg-${getHealthColor(data.health_score)}`;
        }

        // Update daemons
        const daemonsEl = document.getElementById('daemonsRunning');
        if (daemonsEl) {
            daemonsEl.innerHTML = `
                <div class="text-${data.daemons_running === data.daemons_total ? 'success' : 'warning'}">
                    ${data.daemons_running}/${data.daemons_total}
                </div>
            `;
        }

        const daemonStatusEl = document.getElementById('daemonStatus');
        if (daemonStatusEl) {
            daemonStatusEl.textContent = data.daemons_running === data.daemons_total ? 'All Running' : 'Some Stopped';
        }

        // Update active policies
        const policiesEl = document.getElementById('activePolicies');
        if (policiesEl) {
            policiesEl.innerHTML = `<div class="text-info">${data.active_policies}</div>`;
        }

        // Update total policies text
        const totalPoliciesEl = document.getElementById('totalPoliciesText');
        if (totalPoliciesEl && data.total_policies !== undefined) {
            totalPoliciesEl.textContent = `Out of ${data.total_policies} total`;
        }

        console.log(' Dashboard updated with real-time data');
    } catch (error) {
        console.error('Error updating dashboard with WebSocket data:', error);
    }
}

function getHealthColor(score) {
    if (score >= 90) return 'success';
    if (score >= 70) return 'warning';
    return 'danger';
}

// ============================================================
// Drag-and-Drop Widget Reordering
// ============================================================

function initializeSortableWidgets() {
    const sortableContainer = document.getElementById('sortableWidgets');
    if (!sortableContainer) return;

    // Load saved widget order
    const savedOrder = localStorage.getItem('widgetOrder');
    if (savedOrder) {
        applyWidgetOrder(JSON.parse(savedOrder));
    }

    // Initialize Sortable.js
    Sortable.create(sortableContainer, {
        animation: 150,
        handle: '.widget-drag-handle',
        ghostClass: 'widget-ghost',
        chosenClass: 'widget-chosen',
        dragClass: 'widget-drag',
        onEnd: function(evt) {
            console.log('Widget moved from', evt.oldIndex, 'to', evt.newIndex);
            saveWidgetOrder();
        }
    });

    // Add drag handles to all widgets
    addDragHandlesToWidgets();
}

function addDragHandlesToWidgets() {
    const widgets = document.querySelectorAll('#sortableWidgets > .row');
    widgets.forEach((widget, index) => {
        if (!widget.querySelector('.widget-drag-handle')) {
            // Add widget ID for tracking
            if (!widget.id) {
                widget.id = `widget-${index}`;
            }

            // Add drag handle
            const dragHandle = document.createElement('div');
            dragHandle.className = 'widget-drag-handle';
            dragHandle.innerHTML = '<i class="fas fa-grip-vertical"></i>';
            dragHandle.title = 'Drag to reorder';

            // Insert at the beginning of the widget
            widget.style.position = 'relative';
            widget.insertBefore(dragHandle, widget.firstChild);
        }
    });
}

function saveWidgetOrder() {
    const widgets = document.querySelectorAll('#sortableWidgets > .row');
    const order = Array.from(widgets).map(widget => widget.id);

    localStorage.setItem('widgetOrder', JSON.stringify(order));
    console.log('Widget order saved:', order);

    showToast('Success', 'Widget order saved!', 'success');
}

function applyWidgetOrder(order) {
    const container = document.getElementById('sortableWidgets');
    if (!container) return;

    const widgets = {};
    Array.from(container.children).forEach(widget => {
        if (widget.id) {
            widgets[widget.id] = widget;
        }
    });

    // Reorder widgets based on saved order
    order.forEach(widgetId => {
        if (widgets[widgetId]) {
            container.appendChild(widgets[widgetId]);
        }
    });

    console.log('Widget order applied:', order);
}

function resetWidgetOrder() {
    if (confirm('Reset all widgets to default order?')) {
        localStorage.removeItem('widgetOrder');
        location.reload();
    }
}
</script>

<style>
.activity-item:last-child {
    border-bottom: none !important;
    padding-bottom: 0 !important;
    margin-bottom: 0 !important;
}

.card {
    transition: transform 0.2s, box-shadow 0.2s;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}

#autoRefreshBadge {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.7;
    }
}

/* Drag-and-Drop Widget Styling */
.widget-drag-handle {
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 30px;
    height: 60px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 0 8px 8px 0;
    cursor: grab;
    opacity: 0;
    transition: opacity 0.3s, left 0.3s;
    z-index: 10;
    box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
}

.widget-drag-handle:hover {
    opacity: 1;
    left: 0;
}

.widget-drag-handle:active {
    cursor: grabbing;
}

.row:hover .widget-drag-handle {
    opacity: 0.7;
}

.widget-ghost {
    opacity: 0.4;
    background: #f0f0f0;
}

.widget-chosen {
    opacity: 0.8;
}

.widget-drag {
    opacity: 0.5;
    transform: rotate(2deg);
}

#sortableWidgets > .row {
    transition: transform 0.2s;
    cursor: move;
}

#sortableWidgets > .row:hover {
    transform: translateX(10px);
}
</style>
{% endblock %}
