{% extends "base.html" %}

{% block title %}Alert Routing & Escalation - Claude Insight{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-0"><i class="fas fa-route me-2"></i>Alert Routing & Escalation</h2>
                <p class="text-muted mt-2">Manage alert routing rules, escalation policies, and on-call schedules</p>
            </div>
            <div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createRuleModal">
                    <i class="fas fa-plus me-2"></i>Create Rule
                </button>
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createPolicyModal">
                    <i class="fas fa-layer-group me-2"></i>Create Policy
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4" id="statsRow">
    <!-- Stats will be loaded here -->
</div>

<!-- Tabs Navigation -->
<ul class="nav nav-tabs mb-4" id="alertRoutingTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="active-alerts-tab" data-bs-toggle="tab" data-bs-target="#active-alerts" type="button">
            <i class="fas fa-bell me-2"></i>Active Alerts
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="routing-rules-tab" data-bs-toggle="tab" data-bs-target="#routing-rules" type="button">
            <i class="fas fa-route me-2"></i>Routing Rules
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="escalation-policies-tab" data-bs-toggle="tab" data-bs-target="#escalation-policies" type="button">
            <i class="fas fa-layer-group me-2"></i>Escalation Policies
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="on-call-tab" data-bs-toggle="tab" data-bs-target="#on-call" type="button">
            <i class="fas fa-user-clock me-2"></i>On-Call Schedules
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="channels-tab" data-bs-toggle="tab" data-bs-target="#channels" type="button">
            <i class="fas fa-paper-plane me-2"></i>Notification Channels
        </button>
    </li>
</ul>

<!-- Tabs Content -->
<div class="tab-content" id="alertRoutingTabsContent">

    <!-- Active Alerts Tab -->
    <div class="tab-pane fade show active" id="active-alerts" role="tabpanel">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0"><i class="fas fa-bell me-2"></i>Active Alerts</h5>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush" id="activeAlertsList">
                    <div class="p-4 text-center text-muted">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                        <p>Loading active alerts...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Routing Rules Tab -->
    <div class="tab-pane fade" id="routing-rules" role="tabpanel">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0"><i class="fas fa-route me-2"></i>Routing Rules</h5>
            </div>
            <div class="card-body">
                <div id="routingRulesList">
                    <p class="text-muted">Loading routing rules...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Escalation Policies Tab -->
    <div class="tab-pane fade" id="escalation-policies" role="tabpanel">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0"><i class="fas fa-layer-group me-2"></i>Escalation Policies</h5>
            </div>
            <div class="card-body">
                <div id="escalationPoliciesList">
                    <p class="text-muted">Loading escalation policies...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- On-Call Schedules Tab -->
    <div class="tab-pane fade" id="on-call" role="tabpanel">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0"><i class="fas fa-user-clock me-2"></i>On-Call Schedules</h5>
            </div>
            <div class="card-body">
                <div id="onCallSchedulesList">
                    <p class="text-muted">Loading on-call schedules...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Channels Tab -->
    <div class="tab-pane fade" id="channels" role="tabpanel">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0"><i class="fas fa-paper-plane me-2"></i>Notification Channels</h5>
            </div>
            <div class="card-body">
                <div id="notificationChannelsList">
                    <p class="text-muted">Loading notification channels...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Rule Modal -->
<div class="modal fade" id="createRuleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Create Routing Rule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createRuleForm">
                    <div class="mb-3">
                        <label class="form-label">Rule Name</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Priority (1 = highest)</label>
                        <input type="number" class="form-control" name="priority" value="10" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Severity</label>
                        <select multiple class="form-select" name="severity">
                            <option value="critical">Critical</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notification Channels (comma-separated IDs)</label>
                        <input type="text" class="form-control" name="channels" placeholder="email_primary,sms_primary">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Escalation Policy ID (optional)</label>
                        <input type="text" class="form-control" name="policy_id" placeholder="policy_critical">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createRoutingRule()">Create Rule</button>
            </div>
        </div>
    </div>
</div>

<!-- Create Policy Modal -->
<div class="modal fade" id="createPolicyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-layer-group me-2"></i>Create Escalation Policy</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">Use the API or JSON editor to create complex escalation policies.</p>
                <div class="alert alert-info">
                    <strong>Example Policy Structure:</strong><br>
                    - Level 1: Primary on-call (5 min timeout)<br>
                    - Level 2: Secondary on-call (10 min timeout)<br>
                    - Level 3: Manager escalation (15 min timeout)
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    loadActiveAlerts();
    loadRoutingRules();
    loadEscalationPolicies();
    loadOnCallSchedules();
    loadNotificationChannels();

    // Auto-refresh every 30 seconds
    setInterval(() => {
        loadStats();
        loadActiveAlerts();
    }, 30000);
});

function loadStats() {
    fetch('/api/alert-routing/stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const stats = data.stats;
                const html = `
                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body text-center">
                                <h3 class="text-primary mb-1">${stats.total_alerts}</h3>
                                <p class="text-muted mb-0 small">Total Alerts</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body text-center">
                                <h3 class="text-danger mb-1">${stats.active}</h3>
                                <p class="text-muted mb-0 small">Active</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body text-center">
                                <h3 class="text-warning mb-1">${stats.escalated}</h3>
                                <p class="text-muted mb-0 small">Escalated</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body text-center">
                                <h3 class="text-success mb-1">${stats.resolved}</h3>
                                <p class="text-muted mb-0 small">Resolved</p>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('statsRow').innerHTML = html;
            }
        })
        .catch(error => console.error('Error loading stats:', error));
}

function loadActiveAlerts() {
    fetch('/api/alert-routing/active-alerts')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const list = document.getElementById('activeAlertsList');

                if (data.alerts.length === 0) {
                    list.innerHTML = `
                        <div class="p-4 text-center text-muted">
                            <i class="fas fa-check-circle fa-2x mb-3 text-success"></i>
                            <p>No active alerts</p>
                        </div>
                    `;
                    return;
                }

                const html = data.alerts.map(alert => {
                    const severityClass = alert.severity === 'critical' ? 'danger' :
                                        alert.severity === 'high' ? 'warning' :
                                        alert.severity === 'medium' ? 'info' : 'secondary';

                    const escalationInfo = alert.escalation ?
                        `<span class="badge bg-warning">Level ${alert.escalation.current_level}</span>` : '';

                    return `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-2">
                                        <span class="badge bg-${severityClass} me-2">${alert.severity.toUpperCase()}</span>
                                        ${escalationInfo}
                                        <strong class="ms-2">${alert.title || alert.metric}</strong>
                                    </div>
                                    <p class="mb-1">${alert.message}</p>
                                    <small class="text-muted">
                                        Created: ${new Date(alert.created_at).toLocaleString()}
                                    </small>
                                </div>
                                <div class="ms-3">
                                    <button class="btn btn-sm btn-outline-primary mb-1" onclick="acknowledgeRoutedAlert('${alert.id}')">
                                        <i class="fas fa-check"></i> Acknowledge
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" onclick="resolveRoutedAlert('${alert.id}')">
                                        <i class="fas fa-check-circle"></i> Resolve
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                list.innerHTML = html;
            }
        })
        .catch(error => console.error('Error loading active alerts:', error));
}

function loadRoutingRules() {
    fetch('/api/alert-routing/rules')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const rules = data.rules;
                const html = rules.map(rule => {
                    const statusBadge = rule.enabled ?
                        '<span class="badge bg-success">Enabled</span>' :
                        '<span class="badge bg-secondary">Disabled</span>';

                    return `
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6>${rule.name} ${statusBadge}</h6>
                                        <p class="mb-1"><strong>Priority:</strong> ${rule.priority}</p>
                                        <p class="mb-1"><strong>Conditions:</strong> ${JSON.stringify(rule.conditions)}</p>
                                        <p class="mb-0"><strong>Actions:</strong> ${rule.actions.length} action(s)</p>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="toggleRule('${rule.id}')">
                                            <i class="fas fa-toggle-on"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                document.getElementById('routingRulesList').innerHTML = html || '<p class="text-muted">No routing rules found</p>';
            }
        })
        .catch(error => console.error('Error loading routing rules:', error));
}

function loadEscalationPolicies() {
    fetch('/api/alert-routing/policies')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const policies = data.policies;
                const html = policies.map(policy => {
                    const statusBadge = policy.enabled ?
                        '<span class="badge bg-success">Enabled</span>' :
                        '<span class="badge bg-secondary">Disabled</span>';

                    const levelsHtml = policy.levels.map(level => `
                        <li>Level ${level.level}: ${level.timeout_minutes} min timeout â†’ ${level.channels.join(', ')}</li>
                    `).join('');

                    return `
                        <div class="card mb-3">
                            <div class="card-body">
                                <h6>${policy.name} ${statusBadge}</h6>
                                <p class="mb-2"><strong>Escalation Levels:</strong></p>
                                <ul class="small">${levelsHtml}</ul>
                                <p class="mb-0"><strong>Repeat:</strong> ${policy.repeat ? `Yes (max ${policy.max_repeats})` : 'No'}</p>
                            </div>
                        </div>
                    `;
                }).join('');

                document.getElementById('escalationPoliciesList').innerHTML = html || '<p class="text-muted">No escalation policies found</p>';
            }
        })
        .catch(error => console.error('Error loading escalation policies:', error));
}

function loadOnCallSchedules() {
    fetch('/api/alert-routing/on-call-schedules')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const schedules = data.schedules;
                const html = schedules.map(schedule => {
                    const statusBadge = schedule.enabled ?
                        '<span class="badge bg-success">Active</span>' :
                        '<span class="badge bg-secondary">Inactive</span>';

                    return `
                        <div class="card mb-3">
                            <div class="card-body">
                                <h6>${schedule.name} ${statusBadge}</h6>
                                <p class="mb-1"><strong>Type:</strong> ${schedule.type}</p>
                                <p class="mb-1"><strong>Current On-Call:</strong> ${data.current_on_call[schedule.id] || 'Unknown'}</p>
                                <p class="mb-0"><strong>Rotation:</strong> ${schedule.rotation.length} people</p>
                            </div>
                        </div>
                    `;
                }).join('');

                document.getElementById('onCallSchedulesList').innerHTML = html || '<p class="text-muted">No on-call schedules found</p>';
            }
        })
        .catch(error => console.error('Error loading on-call schedules:', error));
}

function loadNotificationChannels() {
    fetch('/api/alert-routing/channels')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const channels = data.channels;
                const html = channels.map(channel => {
                    const statusBadge = channel.enabled ?
                        '<span class="badge bg-success">Active</span>' :
                        '<span class="badge bg-secondary">Inactive</span>';

                    const typeIcons = {
                        'email': 'envelope',
                        'sms': 'mobile-alt',
                        'slack': 'slack',
                        'webhook': 'code'
                    };

                    const icon = typeIcons[channel.type] || 'bell';

                    return `
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6><i class="fab fa-${icon} me-2"></i>${channel.name} ${statusBadge}</h6>
                                        <p class="mb-1"><strong>Type:</strong> ${channel.type}</p>
                                        <p class="mb-0"><strong>ID:</strong> ${channel.id}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                document.getElementById('notificationChannelsList').innerHTML = html || '<p class="text-muted">No notification channels found</p>';
            }
        })
        .catch(error => console.error('Error loading notification channels:', error));
}

function acknowledgeRoutedAlert(alertId) {
    fetch(`/api/alert-routing/alerts/${alertId}/acknowledge`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({acknowledged_by: 'admin'})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Alert acknowledged successfully');
            loadActiveAlerts();
            loadStats();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error acknowledging alert');
    });
}

function resolveRoutedAlert(alertId) {
    const note = prompt('Resolution note (optional):');

    fetch(`/api/alert-routing/alerts/${alertId}/resolve`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            resolved_by: 'admin',
            resolution_note: note || ''
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Alert resolved successfully');
            loadActiveAlerts();
            loadStats();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error resolving alert');
    });
}

function createRoutingRule() {
    const form = document.getElementById('createRuleForm');
    const formData = new FormData(form);

    const severity = Array.from(form.querySelectorAll('select[name="severity"] option:checked')).map(o => o.value);
    const channels = formData.get('channels').split(',').map(c => c.trim()).filter(c => c);

    const rule = {
        name: formData.get('name'),
        priority: parseInt(formData.get('priority')),
        enabled: true,
        conditions: {
            severity: severity,
            logic: 'AND'
        },
        actions: [
            {
                type: 'notify',
                channels: channels
            }
        ]
    };

    if (formData.get('policy_id')) {
        rule.actions.push({
            type: 'escalate',
            policy_id: formData.get('policy_id')
        });
    }

    fetch('/api/alert-routing/rules', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(rule)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Routing rule created successfully');
            bootstrap.Modal.getInstance(document.getElementById('createRuleModal')).hide();
            form.reset();
            loadRoutingRules();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating routing rule');
    });
}

function toggleRule(ruleId) {
    fetch(`/api/alert-routing/rules/${ruleId}/toggle`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadRoutingRules();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => console.error('Error toggling rule:', error));
}
</script>
{% endblock %}
