{% extends "base.html" %}

{% block title %}Docs Browser - Claude Insight{% endblock %}

{% block extra_css %}
<style>
.doc-card {
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 14px;
    cursor: pointer;
    transition: box-shadow .15s, border-color .15s;
}
.doc-card:hover, .doc-card.active {
    box-shadow: 0 4px 16px rgba(99,102,241,.12);
    border-color: #6366f1;
}
.doc-card.active {
    background: #f5f3ff;
}
.cat-header {
    font-size: 13px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .05em;
    color: #64748b;
    margin: 20px 0 10px;
}
.doc-viewer {
    background: #1e293b;
    color: #e2e8f0;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    line-height: 1.6;
    padding: 16px;
    border-radius: 10px;
    height: 68vh;
    overflow-y: auto;
    white-space: pre-wrap;
    word-break: break-word;
}
.doc-viewer .md-h1  { color: #f472b6; font-weight: bold; }
.doc-viewer .md-h2  { color: #60a5fa; font-weight: bold; }
.doc-viewer .md-h3  { color: #34d399; font-weight: bold; }
.doc-viewer .md-code { background: rgba(255,255,255,.08); padding: 1px 4px; border-radius: 3px; color: #fbbf24; }
.doc-viewer .md-bold { font-weight: bold; color: #f8fafc; }
.missing-badge { background: #fef9c3; color: #854d0e; border: 1px solid #fde68a; font-size: 10px; padding: 1px 6px; border-radius: 10px; }
.exists-badge  { background: #ecfdf5; color: #065f46; border: 1px solid #a7f3d0; font-size: 10px; padding: 1px 6px; border-radius: 10px; }
#searchInput { max-width: 260px; }
.lines-badge { font-size: 11px; color: #94a3b8; }
.viewer-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #64748b;
    flex-direction: column;
    gap: 12px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">

    <!-- Page header -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
        <div>
            <h4 class="mb-0"><i class="fas fa-book-open me-2 text-primary"></i>Docs Browser</h4>
            <small class="text-muted">Browse <code>~/.claude/memory/docs/</code> â€” click any doc to view its content</small>
        </div>
        <div class="d-flex gap-2 align-items-center">
            <input type="text" id="searchInput" class="form-control form-control-sm"
                   placeholder="Search docs..." oninput="filterDocs(this.value)">
            <select id="catFilter" class="form-select form-select-sm" style="min-width:160px;"
                    onchange="filterDocs(document.getElementById('searchInput').value)">
                <option value="">All Categories</option>
            </select>
            <button class="btn btn-sm btn-outline-secondary" onclick="loadDocs()">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>

    <!-- Stats -->
    <div class="row g-3 mb-4">
        <div class="col-sm-4 col-md-3">
            <div class="card border-0 shadow-sm text-center py-3">
                <div class="fs-3 fw-bold text-primary" id="statTotal">-</div>
                <small class="text-muted">Total Docs</small>
            </div>
        </div>
        <div class="col-sm-4 col-md-3">
            <div class="card border-0 shadow-sm text-center py-3">
                <div class="fs-3 fw-bold text-success" id="statCategories">-</div>
                <small class="text-muted">Categories</small>
            </div>
        </div>
        <div class="col-sm-4 col-md-3">
            <div class="card border-0 shadow-sm text-center py-3">
                <div class="fs-3 fw-bold text-warning" id="statExists">-</div>
                <small class="text-muted">Files Found</small>
            </div>
        </div>
        <div class="col-sm-12 col-md-3">
            <div class="card border-0 shadow-sm text-center py-3">
                <div class="fs-3 fw-bold" id="statIndex">-</div>
                <small class="text-muted">INDEX.md</small>
            </div>
        </div>
    </div>

    <!-- Alert -->
    <div id="alertMsg" class="alert py-2 px-3 small mb-3" style="display:none;"></div>

    <!-- Main layout: list + viewer -->
    <div class="row g-3">
        <!-- Doc list -->
        <div class="col-lg-5" style="max-height: calc(68vh + 40px); overflow-y: auto;">
            <div id="docsContainer">
                <div class="text-center py-5 text-muted">
                    <i class="fas fa-spinner fa-spin fa-2x mb-3 d-block"></i>
                    Loading docs index...
                </div>
            </div>
        </div>

        <!-- Doc viewer -->
        <div class="col-lg-7">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 pt-3 pb-2 d-flex justify-content-between align-items-center">
                    <strong id="viewerTitle"><i class="fas fa-file-code me-2 text-muted"></i>Select a document</strong>
                    <div class="d-flex gap-2 align-items-center">
                        <span id="viewerLines" class="badge bg-light text-dark" style="display:none;"></span>
                        <button class="btn btn-sm btn-outline-secondary" id="copyBtn" style="display:none;"
                                onclick="copyDocContent()">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body p-2 pt-0">
                    <div id="docViewer" class="doc-viewer">
                        <div class="viewer-placeholder">
                            <i class="fas fa-hand-point-left fa-2x" style="color:#334155;"></i>
                            <span style="color:#64748b;">Click a document on the left to view it</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
let _allDocs = [];
let _categories = {};
let _rawDocContent = '';
let _activeFile = '';

function loadDocs() {
    document.getElementById('docsContainer').innerHTML =
        '<div class="text-center py-5 text-muted"><i class="fas fa-spinner fa-spin fa-2x mb-3 d-block"></i>Loading...</div>';

    fetch('/api/docs-index')
        .then(r => r.json())
        .then(data => {
            if (!data.success) {
                document.getElementById('docsContainer').innerHTML =
                    '<div class="alert alert-danger">Failed to load docs index.</div>';
                return;
            }

            _allDocs = data.docs || [];
            _categories = data.categories || {};

            // Stats
            document.getElementById('statTotal').textContent = data.total || 0;
            document.getElementById('statCategories').textContent = Object.keys(_categories).length;
            const existsCount = _allDocs.filter(d => d.exists).length;
            document.getElementById('statExists').textContent = existsCount;

            const indexEl = document.getElementById('statIndex');
            if (data.index_found) {
                indexEl.textContent = 'Found';
                indexEl.className = 'fs-3 fw-bold text-success';
            } else {
                indexEl.textContent = 'Missing';
                indexEl.className = 'fs-3 fw-bold text-warning';
            }

            // Category filter
            const catSel = document.getElementById('catFilter');
            catSel.innerHTML = '<option value="">All Categories</option>';
            Object.keys(_categories).sort().forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = c + ' (' + _categories[c] + ')';
                catSel.appendChild(opt);
            });

            renderDocs(_allDocs);
        })
        .catch(e => {
            document.getElementById('docsContainer').innerHTML =
                '<div class="alert alert-danger">Error: ' + e + '</div>';
        });
}

function renderDocs(docs) {
    const container = document.getElementById('docsContainer');
    if (!docs.length) {
        container.innerHTML = '<div class="text-center text-muted py-4">No documents found.</div>';
        return;
    }

    // Group by category
    const grouped = {};
    docs.forEach(d => {
        grouped[d.category] = grouped[d.category] || [];
        grouped[d.category].push(d);
    });

    let html = '';
    Object.keys(grouped).sort().forEach(cat => {
        const catDocs = grouped[cat];
        html += `<div class="cat-header"><i class="fas fa-folder me-2"></i>${cat} (${catDocs.length})</div>`;
        catDocs.forEach(d => {
            const existsBadge = d.exists
                ? `<span class="exists-badge">Found</span>`
                : `<span class="missing-badge">Missing</span>`;
            const linesBadge = d.lines != null ? `<span class="lines-badge ms-1">${d.lines} lines</span>` : '';
            const isActive = d.filename === _activeFile ? ' active' : '';
            html += `
            <div class="doc-card mb-2${isActive}" onclick="openDoc('${d.filename}', this)"
                 data-title="${d.title.toLowerCase()}" data-cat="${d.category}" data-desc="${(d.description||'').toLowerCase()}">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="fw-semibold small text-truncate" style="max-width:240px;" title="${d.title}">${d.title}</div>
                    <div class="ms-2 flex-shrink-0">${existsBadge}${linesBadge}</div>
                </div>
                <div class="text-muted" style="font-size:11px; margin-top:3px; line-height:1.4;">${(d.description||'').substring(0, 80)}${(d.description||'').length > 80 ? '...' : ''}</div>
            </div>`;
        });
    });

    container.innerHTML = html;
}

function filterDocs(query) {
    const cat = document.getElementById('catFilter').value;
    const q = (query || '').toLowerCase().trim();

    const filtered = _allDocs.filter(d => {
        const matchCat = !cat || d.category === cat;
        const matchQ = !q
            || d.title.toLowerCase().includes(q)
            || (d.description || '').toLowerCase().includes(q)
            || d.filename.toLowerCase().includes(q);
        return matchCat && matchQ;
    });
    renderDocs(filtered);
}

function openDoc(filename, cardEl) {
    // Highlight active card
    document.querySelectorAll('.doc-card').forEach(c => c.classList.remove('active'));
    if (cardEl) cardEl.classList.add('active');
    _activeFile = filename;

    const viewer = document.getElementById('docViewer');
    viewer.innerHTML = '<div class="viewer-placeholder"><i class="fas fa-spinner fa-spin fa-2x"></i></div>';

    fetch('/api/docs-content?file=' + encodeURIComponent(filename))
        .then(r => r.json())
        .then(data => {
            if (!data.success) {
                viewer.innerHTML = '<span style="color:#f87171;">Error: ' + data.message + '</span>';
                return;
            }
            _rawDocContent = data.content || '';
            viewer.innerHTML = renderMarkdown(_rawDocContent);
            document.getElementById('viewerTitle').innerHTML =
                '<i class="fas fa-file-code me-2 text-primary"></i>' + filename;
            document.getElementById('viewerLines').textContent = data.lines + ' lines';
            document.getElementById('viewerLines').style.display = '';
            document.getElementById('copyBtn').style.display = '';
        })
        .catch(e => {
            viewer.innerHTML = '<span style="color:#f87171;">Request failed: ' + e + '</span>';
        });
}

function renderMarkdown(raw) {
    if (!raw) return '';
    return raw
        .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
        .split('\n')
        .map(line => {
            if (/^#{3}\s/.test(line)) return `<span class="md-h3">${line}</span>`;
            if (/^#{2}\s/.test(line)) return `<span class="md-h2">${line}</span>`;
            if (/^#\s/.test(line))   return `<span class="md-h1">${line}</span>`;
            line = line.replace(/`([^`]+)`/g, '<span class="md-code">$1</span>');
            line = line.replace(/\*\*([^*]+)\*\*/g, '<span class="md-bold">$1</span>');
            return line;
        })
        .join('\n');
}

function copyDocContent() {
    if (!_rawDocContent) return;
    navigator.clipboard.writeText(_rawDocContent).then(() => {
        showAlert('Copied to clipboard.', 'success');
    });
}

function showAlert(msg, type) {
    const el = document.getElementById('alertMsg');
    el.className = `alert alert-${type} py-2 px-3 small mb-3`;
    el.textContent = msg;
    el.style.display = '';
    setTimeout(() => { el.style.display = 'none'; }, 3000);
}

document.addEventListener('DOMContentLoaded', loadDocs);
</script>
{% endblock %}
