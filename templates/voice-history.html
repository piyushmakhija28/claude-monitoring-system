{% extends "base.html" %}

{% block title %}Voice Notification History - Claude Insight{% endblock %}

{% block extra_css %}
<style>
.voice-card {
    border-left: 4px solid #10b981;
    border-radius: 0 8px 8px 0;
    transition: box-shadow .15s;
}
.voice-card:hover {
    box-shadow: 0 4px 14px rgba(16, 185, 129, .12);
}
.voice-meta {
    font-size: 11px;
    color: #94a3b8;
}
.summary-text {
    font-size: 14px;
    color: #1e293b;
    line-height: 1.6;
}
.empty-state {
    padding: 60px 20px;
    text-align: center;
    color: #94a3b8;
}
.badge-voice {
    background: #ecfdf5;
    color: #065f46;
    border: 1px solid #a7f3d0;
    font-size: 11px;
    padding: 3px 9px;
    border-radius: 20px;
}
#historyCount { font-size: 13px; color: #64748b; }
.filter-bar { max-width: 320px; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">

    <!-- Page header -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
        <div>
            <h4 class="mb-0"><i class="fas fa-volume-up me-2 text-success"></i>Voice Notification History</h4>
            <small class="text-muted">Session completion summaries spoken by the stop notifier</small>
        </div>
        <div class="d-flex gap-2 align-items-center">
            <input type="text" id="filterInput" class="form-control form-control-sm filter-bar"
                   placeholder="Filter notifications..." oninput="filterHistory(this.value)">
            <button class="btn btn-sm btn-outline-secondary" onclick="loadHistory()">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="clearHistory()">
                <i class="fas fa-trash-alt me-1"></i>Clear All
            </button>
        </div>
    </div>

    <!-- Stats row -->
    <div class="row g-3 mb-4">
        <div class="col-sm-4 col-md-3">
            <div class="card border-0 shadow-sm text-center py-3">
                <div class="fs-3 fw-bold text-success" id="statTotal">-</div>
                <small class="text-muted">Total Notifications</small>
            </div>
        </div>
        <div class="col-sm-4 col-md-3">
            <div class="card border-0 shadow-sm text-center py-3">
                <div class="fs-3 fw-bold text-primary" id="statToday">-</div>
                <small class="text-muted">Today</small>
            </div>
        </div>
        <div class="col-sm-4 col-md-3">
            <div class="card border-0 shadow-sm text-center py-3">
                <div class="fs-3 fw-bold text-info" id="statLatest">-</div>
                <small class="text-muted">Latest Session</small>
            </div>
        </div>
    </div>

    <!-- Alert -->
    <div id="alertMsg" class="alert py-2 px-3 small mb-3" style="display:none;"></div>

    <!-- History list -->
    <div id="historyContainer">
        <div class="text-center py-5 text-muted">
            <i class="fas fa-spinner fa-spin fa-2x mb-3 d-block"></i>
            Loading voice notification history...
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
let _allHistory = [];

function loadHistory() {
    fetch('/api/voice-history')
        .then(r => r.json())
        .then(data => {
            if (!data.success) {
                showAlert('Failed to load history: ' + (data.message || ''), 'danger');
                return;
            }
            _allHistory = data.history || [];
            updateStats(_allHistory);
            renderHistory(_allHistory);
        })
        .catch(e => showAlert('Request failed: ' + e, 'danger'));
}

function updateStats(hist) {
    document.getElementById('statTotal').textContent = hist.length;

    // Count today's
    const today = new Date().toISOString().slice(0, 10);
    const todayCount = hist.filter(h => (h.timestamp || '').startsWith(today)).length;
    document.getElementById('statToday').textContent = todayCount;

    // Latest session date
    if (hist.length > 0) {
        const ts = hist[0].timestamp || '';
        const d = ts ? new Date(ts).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'}) : '—';
        document.getElementById('statLatest').textContent = d;
    } else {
        document.getElementById('statLatest').textContent = '—';
    }
}

function renderHistory(hist) {
    const container = document.getElementById('historyContainer');

    if (!hist.length) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-volume-mute fa-3x mb-3 d-block" style="color:#cbd5e1;"></i>
                <p class="mb-1 fw-semibold">No voice notifications yet</p>
                <small>Summaries appear here when Claude finishes a session and the stop notifier fires.</small>
            </div>`;
        return;
    }

    let html = `<div class="d-flex justify-content-between align-items-center mb-3">
        <span id="historyCount" class="text-muted small">${hist.length} notification${hist.length !== 1 ? 's' : ''}</span>
    </div>`;

    hist.forEach((item, idx) => {
        const ts = item.timestamp ? new Date(item.timestamp) : null;
        const dateStr = ts ? ts.toLocaleDateString([], {month: 'short', day: 'numeric', year: 'numeric'}) : '—';
        const timeStr = ts ? ts.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit', second: '2-digit'}) : '';
        const session = item.session_id ? `<span class="badge bg-light text-dark me-2">${item.session_id}</span>` : '';

        html += `
        <div class="card border-0 shadow-sm mb-3 voice-card">
            <div class="card-body py-3 px-4">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        ${session}
                        <span class="badge-voice"><i class="fas fa-microphone me-1"></i>Voice Summary</span>
                    </div>
                    <div class="voice-meta text-end">
                        <div>${dateStr}</div>
                        <div>${timeStr}</div>
                    </div>
                </div>
                <div class="summary-text">${escapeHtml(item.summary || '—')}</div>
            </div>
        </div>`;
    });

    container.innerHTML = html;
}

function filterHistory(query) {
    const q = (query || '').toLowerCase().trim();
    const filtered = q
        ? _allHistory.filter(h => (h.summary || '').toLowerCase().includes(q) || (h.session_id || '').toLowerCase().includes(q))
        : _allHistory;
    renderHistory(filtered);
    const countEl = document.getElementById('historyCount');
    if (countEl) countEl.textContent = filtered.length + ' notification' + (filtered.length !== 1 ? 's' : '');
}

function clearHistory() {
    if (!confirm('Clear all voice notification history? This cannot be undone.')) return;
    fetch('/api/voice-history', {method: 'DELETE'})
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                _allHistory = [];
                updateStats([]);
                renderHistory([]);
                showAlert('History cleared.', 'success');
            } else {
                showAlert('Error: ' + data.message, 'danger');
            }
        })
        .catch(e => showAlert('Request failed: ' + e, 'danger'));
}

function escapeHtml(str) {
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
}

function showAlert(msg, type) {
    const el = document.getElementById('alertMsg');
    el.className = `alert alert-${type} py-2 px-3 small mb-3`;
    el.textContent = msg;
    el.style.display = '';
    setTimeout(() => { el.style.display = 'none'; }, 4000);
}

document.addEventListener('DOMContentLoaded', loadHistory);
</script>
{% endblock %}
