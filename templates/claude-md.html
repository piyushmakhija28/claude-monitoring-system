{% extends "base.html" %}

{% block title %}CLAUDE.md Viewer - Claude Insight{% endblock %}

{% block extra_css %}
<style>
.md-panel {
    background: #1e293b;
    color: #e2e8f0;
    border-radius: 10px;
    font-family: 'Courier New', monospace;
    font-size: 13px;
    line-height: 1.6;
    padding: 16px;
    height: 72vh;
    overflow-y: auto;
    white-space: pre-wrap;
    word-break: break-word;
}
.md-panel .md-h1  { color: #f472b6; font-weight: bold; }
.md-panel .md-h2  { color: #60a5fa; font-weight: bold; }
.md-panel .md-h3  { color: #34d399; font-weight: bold; }
.md-panel .md-code { background: rgba(255,255,255,.08); padding: 1px 4px; border-radius: 3px; color: #fbbf24; }
.md-panel .md-bold { font-weight: bold; color: #f8fafc; }
.panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}
.diff-badge-global  { background: #6366f1; color: #fff; }
.diff-badge-project { background: #10b981; color: #fff; }
.diff-badge-shared  { background: #f59e0b; color: #fff; }
.section-tag {
    display: inline-block;
    font-size: 11px;
    padding: 2px 7px;
    border-radius: 20px;
    margin: 2px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">

    <!-- Page header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="mb-0"><i class="fas fa-file-code me-2 text-primary"></i>CLAUDE.md Viewer</h4>
            <small class="text-muted">Read-only view of global and project CLAUDE.md files</small>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-secondary" onclick="refreshContent()">
                <i class="fas fa-sync-alt me-1"></i>Refresh
            </button>
            <button class="btn btn-sm btn-outline-primary" onclick="toggleDiff()">
                <i class="fas fa-code-branch me-1"></i>Diff Summary
            </button>
        </div>
    </div>

    <!-- Diff summary card (hidden by default) -->
    <div id="diffCard" class="card border-0 shadow-sm mb-4" style="display:none;">
        <div class="card-body p-4">
            <h6 class="fw-bold mb-3"><i class="fas fa-code-branch me-2"></i>Section Diff: Global vs Project</h6>
            <div class="row">
                <div class="col-md-4">
                    <p class="fw-bold text-muted small mb-2">Global Only</p>
                    <div id="diffGlobalOnly"></div>
                </div>
                <div class="col-md-4">
                    <p class="fw-bold text-muted small mb-2">Project Only</p>
                    <div id="diffProjectOnly"></div>
                </div>
                <div class="col-md-4">
                    <p class="fw-bold text-muted small mb-2">Shared Sections</p>
                    <div id="diffShared"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status bar -->
    <div id="statusBar" class="alert alert-info py-2 px-3 small mb-3" style="display:none;"></div>

    <!-- Side-by-side panels -->
    <div class="row g-3">
        <!-- Global CLAUDE.md -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 pt-3 pb-2">
                    <div class="panel-header">
                        <div>
                            <span class="badge bg-primary me-2">Global</span>
                            <strong>~/.claude/CLAUDE.md</strong>
                        </div>
                        <div>
                            <span id="globalLines" class="badge bg-light text-dark">Loading...</span>
                            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyContent('global')">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-3 pt-0">
                    <div id="globalContent" class="md-panel">
                        <span class="text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Project CLAUDE.md -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 pt-3 pb-2">
                    <div class="panel-header">
                        <div>
                            <span class="badge bg-success me-2">Project</span>
                            <strong>claude-insight/CLAUDE.md</strong>
                        </div>
                        <div>
                            <span id="projectLines" class="badge bg-light text-dark">Loading...</span>
                            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyContent('project')">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-3 pt-0">
                    <div id="projectContent" class="md-panel">
                        <span class="text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
let _rawGlobal = '';
let _rawProject = '';
let _diffVisible = false;

function renderMarkdown(raw) {
    if (!raw) return '<span class="text-muted fst-italic">File not found.</span>';
    // Basic syntax highlighting without external library
    return raw
        .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
        .split('\n')
        .map(line => {
            if (/^#{3}\s/.test(line)) return `<span class="md-h3">${line}</span>`;
            if (/^#{2}\s/.test(line)) return `<span class="md-h2">${line}</span>`;
            if (/^#\s/.test(line))   return `<span class="md-h1">${line}</span>`;
            // inline code
            line = line.replace(/`([^`]+)`/g, '<span class="md-code">$1</span>');
            // bold
            line = line.replace(/\*\*([^*]+)\*\*/g, '<span class="md-bold">$1</span>');
            return line;
        })
        .join('\n');
}

function loadContent() {
    fetch('/api/claude-md')
        .then(r => r.json())
        .then(data => {
            if (!data.success) {
                showStatus('Error: ' + data.message, 'danger');
                return;
            }

            const g = data.global;
            const p = data.project;
            _rawGlobal  = g.content || '';
            _rawProject = p.content || '';

            // Render global
            const gEl = document.getElementById('globalContent');
            if (g.exists) {
                gEl.innerHTML = renderMarkdown(_rawGlobal);
                const lines = _rawGlobal.split('\n').length;
                document.getElementById('globalLines').textContent = `${lines} lines`;
            } else {
                gEl.innerHTML = '<span class="text-warning">File not found: ' + g.path + '</span>';
                document.getElementById('globalLines').textContent = 'not found';
            }

            // Render project
            const pEl = document.getElementById('projectContent');
            if (p.exists) {
                pEl.innerHTML = renderMarkdown(_rawProject);
                const lines = _rawProject.split('\n').length;
                document.getElementById('projectLines').textContent = `${lines} lines`;
            } else {
                pEl.innerHTML = '<span class="text-warning">File not found: ' + p.path + '</span>';
                document.getElementById('projectLines').textContent = 'not found';
            }

            // Render diff summary
            if (data.diff_summary && typeof data.diff_summary === 'object') {
                renderDiff(data.diff_summary);
            }
        })
        .catch(e => showStatus('Failed to load: ' + e, 'danger'));
}

function renderDiff(diff) {
    const render = (ids, arr, cssClass) => {
        const el = document.getElementById(ids);
        if (!arr || arr.length === 0) {
            el.innerHTML = '<span class="text-muted small fst-italic">None</span>';
        } else {
            el.innerHTML = arr.map(s =>
                `<span class="section-tag badge ${cssClass}">${s.replace(/^#+\s*/, '')}</span>`
            ).join(' ');
        }
    };
    render('diffGlobalOnly',  diff.only_global,  'diff-badge-global');
    render('diffProjectOnly', diff.only_project, 'diff-badge-project');
    render('diffShared',      diff.shared,        'diff-badge-shared');
}

function toggleDiff() {
    _diffVisible = !_diffVisible;
    document.getElementById('diffCard').style.display = _diffVisible ? '' : 'none';
}

function refreshContent() {
    document.getElementById('globalContent').innerHTML  = '<span class="text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Refreshing...</span>';
    document.getElementById('projectContent').innerHTML = '<span class="text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Refreshing...</span>';
    loadContent();
}

function copyContent(which) {
    const text = which === 'global' ? _rawGlobal : _rawProject;
    if (!text) return;
    navigator.clipboard.writeText(text).then(() => {
        showStatus('Copied to clipboard.', 'success');
        setTimeout(() => document.getElementById('statusBar').style.display = 'none', 2000);
    });
}

function showStatus(msg, type) {
    const el = document.getElementById('statusBar');
    el.className = `alert alert-${type} py-2 px-3 small mb-3`;
    el.textContent = msg;
    el.style.display = '';
}

document.addEventListener('DOMContentLoaded', loadContent);
</script>
{% endblock %}
