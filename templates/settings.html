{% extends "base.html" %}

{% block title %}Settings - Claude Insight{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="mb-0">
            <i class="fas fa-cog me-2"></i>Settings & Preferences
        </h2>
        <p class="text-muted mt-2">Customize your monitoring dashboard experience</p>
    </div>
</div>

<div class="row">
    <div class="col-lg-8 mx-auto">
        <!-- Success/Error Messages -->
        <div id="alertContainer"></div>

        <!-- Display Settings -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0">
                    <i class="fas fa-desktop me-2"></i>Display Settings
                </h5>
            </div>
            <div class="card-body p-4">
                <!-- Auto-Refresh Interval -->
                <div class="mb-4">
                    <label for="refreshInterval" class="form-label fw-bold">
                        <i class="fas fa-sync-alt me-2 text-primary"></i>Auto-Refresh Interval
                    </label>
                    <select class="form-select" id="refreshInterval">
                        <option value="disabled">Disabled</option>
                        <option value="30" selected>30 seconds</option>
                        <option value="60">60 seconds (1 minute)</option>
                        <option value="120">120 seconds (2 minutes)</option>
                        <option value="300">300 seconds (5 minutes)</option>
                    </select>
                    <small class="text-muted d-block mt-2">
                        <i class="fas fa-info-circle"></i>
                        Controls how often the dashboard refreshes automatically
                    </small>
                </div>

                <!-- Theme Preference -->
                <div class="mb-4">
                    <label for="themePreference" class="form-label fw-bold">
                        <i class="fas fa-palette me-2 text-primary"></i>Theme Preference
                    </label>
                    <select class="form-select" id="themePreference" onchange="applyThemeFromSettings()">
                        <option value="light" selected>Light Mode</option>
                        <option value="dark">Dark Mode</option>
                        <option value="auto">Auto (System Default)</option>
                    </select>
                    <small class="text-muted d-block mt-2">
                        <i class="fas fa-info-circle"></i>
                        Choose your preferred theme for the dashboard
                    </small>
                </div>

                <!-- Default Page -->
                <div class="mb-4">
                    <label for="defaultPage" class="form-label fw-bold">
                        <i class="fas fa-home me-2 text-primary"></i>Default Page on Login
                    </label>
                    <select class="form-select" id="defaultPage">
                        <option value="dashboard" selected>Dashboard</option>
                        <option value="comparison">Cost Comparison</option>
                        <option value="policies">Policies</option>
                        <option value="logs">Logs</option>
                        <option value="sessions">Sessions</option>
                    </select>
                    <small class="text-muted d-block mt-2">
                        <i class="fas fa-info-circle"></i>
                        Choose which page to display after logging in
                    </small>
                </div>

                <!-- Dashboard Layout -->
                <div class="mb-0">
                    <label for="dashboardDensity" class="form-label fw-bold">
                        <i class="fas fa-th me-2 text-primary"></i>Dashboard Density
                    </label>
                    <select class="form-select" id="dashboardDensity">
                        <option value="comfortable" selected>Comfortable</option>
                        <option value="compact">Compact</option>
                        <option value="spacious">Spacious</option>
                    </select>
                    <small class="text-muted d-block mt-2">
                        <i class="fas fa-info-circle"></i>
                        Adjust spacing and card sizes on the dashboard
                    </small>
                </div>
            </div>
        </div>

        <!-- Claude Memory System Settings -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0">
                    <i class="fas fa-brain me-2"></i>Claude Memory System
                </h5>
            </div>
            <div class="card-body p-4">
                <!-- TRACE_MODE Toggle -->
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <div>
                        <strong><i class="fas fa-route me-2 text-primary"></i>TRACE_MODE</strong>
                        <small class="d-block text-muted mt-1">
                            Show the full 3-level architecture flow trace before every response.
                            Writes to <code>~/.claude/CLAUDE.md</code>.
                        </small>
                    </div>
                    <div class="form-check form-switch ms-4">
                        <input class="form-check-input" type="checkbox" role="switch"
                               id="traceModeToggle" style="transform: scale(1.4);"
                               onchange="setTraceMode(this.checked)">
                    </div>
                </div>
                <div id="traceModeStatus" class="small text-muted mb-2"></div>

                <hr class="my-3">

                <!-- Windows Startup & Hook Status -->
                <div class="d-flex align-items-start justify-content-between mb-2">
                    <div>
                        <strong><i class="fas fa-rocket me-2 text-warning"></i>Startup &amp; Hook Status</strong>
                        <small class="d-block text-muted mt-1">
                            Windows auto-start shortcut and <code>~/.claude/settings.json</code> hook health.
                        </small>
                    </div>
                    <button class="btn btn-sm btn-outline-secondary ms-4 flex-shrink-0" onclick="loadStartupStatus()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div id="startupStatusBody" class="mt-2">
                    <div class="text-muted small"><i class="fas fa-spinner fa-spin me-1"></i>Checking...</div>
                </div>
            </div>
        </div>

        <!-- Custom Dashboard Themes -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0">
                    <i class="fas fa-palette me-2"></i>Custom Dashboard Themes
                </h5>
            </div>
            <div class="card-body p-4">
                <p class="text-muted mb-4">
                    <i class="fas fa-info-circle me-2"></i>
                    Choose a color scheme for your dashboard. Theme preference is saved automatically.
                </p>

                <div class="row g-3" id="themeGallery">
                    <!-- Default Theme -->
                    <div class="col-md-4">
                        <div class="theme-card" data-theme="default" onclick="selectTheme('default')">
                            <div class="theme-preview">
                                <div class="theme-color" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
                                <div class="theme-color" style="background: #f8f9fa;"></div>
                                <div class="theme-color" style="background: #ffffff;"></div>
                            </div>
                            <div class="theme-info">
                                <h6 class="mb-1"><i class="fas fa-check-circle text-primary me-2"></i>Default</h6>
                                <small class="text-muted">Purple gradient with light background</small>
                            </div>
                        </div>
                    </div>

                    <!-- Dark Theme -->
                    <div class="col-md-4">
                        <div class="theme-card" data-theme="dark" onclick="selectTheme('dark')">
                            <div class="theme-preview">
                                <div class="theme-color" style="background: #1e293b;"></div>
                                <div class="theme-color" style="background: #334155;"></div>
                                <div class="theme-color" style="background: #64748b;"></div>
                            </div>
                            <div class="theme-info">
                                <h6 class="mb-1"><i class="fas fa-moon text-dark me-2"></i>Dark</h6>
                                <small class="text-muted">Dark slate with high contrast</small>
                            </div>
                        </div>
                    </div>

                    <!-- Blue Theme -->
                    <div class="col-md-4">
                        <div class="theme-card" data-theme="blue" onclick="selectTheme('blue')">
                            <div class="theme-preview">
                                <div class="theme-color" style="background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);"></div>
                                <div class="theme-color" style="background: #dbeafe;"></div>
                                <div class="theme-color" style="background: #ffffff;"></div>
                            </div>
                            <div class="theme-info">
                                <h6 class="mb-1"><i class="fas fa-water text-primary me-2"></i>Blue</h6>
                                <small class="text-muted">Ocean blue with light tones</small>
                            </div>
                        </div>
                    </div>

                    <!-- Purple Theme -->
                    <div class="col-md-4">
                        <div class="theme-card" data-theme="purple" onclick="selectTheme('purple')">
                            <div class="theme-preview">
                                <div class="theme-color" style="background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);"></div>
                                <div class="theme-color" style="background: #f3e8ff;"></div>
                                <div class="theme-color" style="background: #ffffff;"></div>
                            </div>
                            <div class="theme-info">
                                <h6 class="mb-1"><i class="fas fa-star text-purple me-2"></i>Purple</h6>
                                <small class="text-muted">Royal purple with soft accents</small>
                            </div>
                        </div>
                    </div>

                    <!-- Green Theme -->
                    <div class="col-md-4">
                        <div class="theme-card" data-theme="green" onclick="selectTheme('green')">
                            <div class="theme-preview">
                                <div class="theme-color" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);"></div>
                                <div class="theme-color" style="background: #d1fae5;"></div>
                                <div class="theme-color" style="background: #ffffff;"></div>
                            </div>
                            <div class="theme-info">
                                <h6 class="mb-1"><i class="fas fa-leaf text-success me-2"></i>Green</h6>
                                <small class="text-muted">Fresh green with natural feel</small>
                            </div>
                        </div>
                    </div>

                    <!-- Orange Theme -->
                    <div class="col-md-4">
                        <div class="theme-card" data-theme="orange" onclick="selectTheme('orange')">
                            <div class="theme-preview">
                                <div class="theme-color" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);"></div>
                                <div class="theme-color" style="background: #fed7aa;"></div>
                                <div class="theme-color" style="background: #ffffff;"></div>
                            </div>
                            <div class="theme-info">
                                <h6 class="mb-1"><i class="fas fa-fire text-warning me-2"></i>Orange</h6>
                                <small class="text-muted">Warm orange with energetic vibe</small>
                            </div>
                        </div>
                    </div>

                    <!-- Cyberpunk Theme -->
                    <div class="col-md-4">
                        <div class="theme-card" data-theme="cyberpunk" onclick="selectTheme('cyberpunk')">
                            <div class="theme-preview">
                                <div class="theme-color" style="background: linear-gradient(135deg, #ff00ff 0%, #00ffff 100%);"></div>
                                <div class="theme-color" style="background: #0a0a0a;"></div>
                                <div class="theme-color" style="background: #1a1a2e;"></div>
                            </div>
                            <div class="theme-info">
                                <h6 class="mb-1"><i class="fas fa-robot text-info me-2"></i>Cyberpunk</h6>
                                <small class="text-muted">Neon pink & cyan with dark background</small>
                            </div>
                        </div>
                    </div>

                    <!-- Ocean Theme -->
                    <div class="col-md-4">
                        <div class="theme-card" data-theme="ocean" onclick="selectTheme('ocean')">
                            <div class="theme-preview">
                                <div class="theme-color" style="background: linear-gradient(135deg, #0077be 0%, #00a8e8 100%);"></div>
                                <div class="theme-color" style="background: #e0f4ff;"></div>
                                <div class="theme-color" style="background: #f0f9ff;"></div>
                            </div>
                            <div class="theme-info">
                                <h6 class="mb-1"><i class="fas fa-water text-primary me-2"></i>Ocean</h6>
                                <small class="text-muted">Deep blue ocean with wave accents</small>
                            </div>
                        </div>
                    </div>

                    <!-- Forest Theme -->
                    <div class="col-md-4">
                        <div class="theme-card" data-theme="forest" onclick="selectTheme('forest')">
                            <div class="theme-preview">
                                <div class="theme-color" style="background: linear-gradient(135deg, #2d5016 0%, #4a7c59 100%);"></div>
                                <div class="theme-color" style="background: #d4edda;"></div>
                                <div class="theme-color" style="background: #f1f8f4;"></div>
                            </div>
                            <div class="theme-info">
                                <h6 class="mb-1"><i class="fas fa-tree text-success me-2"></i>Forest</h6>
                                <small class="text-muted">Deep forest green with nature feel</small>
                            </div>
                        </div>
                    </div>

                    <!-- Sunset Theme -->
                    <div class="col-md-4">
                        <div class="theme-card" data-theme="sunset" onclick="selectTheme('sunset')">
                            <div class="theme-preview">
                                <div class="theme-color" style="background: linear-gradient(135deg, #ff6b6b 0%, #ffd93d 100%);"></div>
                                <div class="theme-color" style="background: #ffe5e5;"></div>
                                <div class="theme-color" style="background: #fff8dc;"></div>
                            </div>
                            <div class="theme-info">
                                <h6 class="mb-1"><i class="fas fa-sun text-warning me-2"></i>Sunset</h6>
                                <small class="text-muted">Warm sunset red to golden yellow</small>
                            </div>
                        </div>
                    </div>

                    <!-- Nord Theme -->
                    <div class="col-md-4">
                        <div class="theme-card" data-theme="nord" onclick="selectTheme('nord')">
                            <div class="theme-preview">
                                <div class="theme-color" style="background: linear-gradient(135deg, #5e81ac 0%, #81a1c1 100%);"></div>
                                <div class="theme-color" style="background: #eceff4;"></div>
                                <div class="theme-color" style="background: #d8dee9;"></div>
                            </div>
                            <div class="theme-info">
                                <h6 class="mb-1"><i class="fas fa-snowflake text-info me-2"></i>Nord</h6>
                                <small class="text-muted">Arctic blue with cool accents</small>
                            </div>
                        </div>
                    </div>

                    <!-- Tokyo Night Theme -->
                    <div class="col-md-4">
                        <div class="theme-card" data-theme="tokyo-night" onclick="selectTheme('tokyo-night')">
                            <div class="theme-preview">
                                <div class="theme-color" style="background: linear-gradient(135deg, #7aa2f7 0%, #bb9af7 100%);"></div>
                                <div class="theme-color" style="background: #1a1b26;"></div>
                                <div class="theme-color" style="background: #24283b;"></div>
                            </div>
                            <div class="theme-info">
                                <h6 class="mb-1"><i class="fas fa-city text-primary me-2"></i>Tokyo Night</h6>
                                <small class="text-muted">Modern dark with blue & purple</small>
                            </div>
                        </div>
                    </div>

                    <!-- Dracula Theme -->
                    <div class="col-md-4">
                        <div class="theme-card" data-theme="dracula" onclick="selectTheme('dracula')">
                            <div class="theme-preview">
                                <div class="theme-color" style="background: linear-gradient(135deg, #bd93f9 0%, #ff79c6 100%);"></div>
                                <div class="theme-color" style="background: #282a36;"></div>
                                <div class="theme-color" style="background: #44475a;"></div>
                            </div>
                            <div class="theme-info">
                                <h6 class="mb-1"><i class="fas fa-vampire text-danger me-2"></i>Dracula</h6>
                                <small class="text-muted">Popular dark with purple & pink</small>
                            </div>
                        </div>
                    </div>

                    <!-- Monokai Theme -->
                    <div class="col-md-4">
                        <div class="theme-card" data-theme="monokai" onclick="selectTheme('monokai')">
                            <div class="theme-preview">
                                <div class="theme-color" style="background: linear-gradient(135deg, #f92672 0%, #a6e22e 100%);"></div>
                                <div class="theme-color" style="background: #272822;"></div>
                                <div class="theme-color" style="background: #3e3d32;"></div>
                            </div>
                            <div class="theme-info">
                                <h6 class="mb-1"><i class="fas fa-code text-success me-2"></i>Monokai</h6>
                                <small class="text-muted">Classic dark with vibrant colors</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-3">
                    <span class="badge bg-success" id="themeStatus" style="display: none;">
                        <i class="fas fa-check me-1"></i>Theme applied successfully
                    </span>
                </div>
            </div>
        </div>

        <!-- Custom Theme Builder -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0">
                    <i class="fas fa-paint-brush me-2"></i>Custom Theme Builder
                </h5>
            </div>
            <div class="card-body p-4">
                <p class="text-muted mb-4">
                    <i class="fas fa-magic me-2"></i>
                    Create your own custom theme with personalized colors, fonts, and styling.
                </p>

                <!-- Color Customization -->
                <div class="mb-4">
                    <h6 class="mb-3"><i class="fas fa-palette me-2 text-primary"></i>Color Scheme</h6>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="primaryColor" class="form-label">Primary Color</label>
                            <input type="color" class="form-control form-control-color" id="primaryColor" value="#667eea" title="Choose primary color">
                            <small class="text-muted">Main brand color</small>
                        </div>
                        <div class="col-md-3">
                            <label for="secondaryColor" class="form-label">Secondary Color</label>
                            <input type="color" class="form-control form-control-color" id="secondaryColor" value="#764ba2" title="Choose secondary color">
                            <small class="text-muted">Accent color</small>
                        </div>
                        <div class="col-md-3">
                            <label for="backgroundColor" class="form-label">Background Color</label>
                            <input type="color" class="form-control form-control-color" id="backgroundColor" value="#f8f9fa" title="Choose background color">
                            <small class="text-muted">Page background</small>
                        </div>
                        <div class="col-md-3">
                            <label for="textColor" class="form-label">Text Color</label>
                            <input type="color" class="form-control form-control-color" id="textColor" value="#212529" title="Choose text color">
                            <small class="text-muted">Main text color</small>
                        </div>
                        <div class="col-md-3">
                            <label for="successColor" class="form-label">Success Color</label>
                            <input type="color" class="form-control form-control-color" id="successColor" value="#10b981" title="Choose success color">
                            <small class="text-muted">Success states</small>
                        </div>
                        <div class="col-md-3">
                            <label for="warningColor" class="form-label">Warning Color</label>
                            <input type="color" class="form-control form-control-color" id="warningColor" value="#f59e0b" title="Choose warning color">
                            <small class="text-muted">Warning states</small>
                        </div>
                        <div class="col-md-3">
                            <label for="dangerColor" class="form-label">Danger Color</label>
                            <input type="color" class="form-control form-control-color" id="dangerColor" value="#ef4444" title="Choose danger color">
                            <small class="text-muted">Error states</small>
                        </div>
                        <div class="col-md-3">
                            <label for="infoColor" class="form-label">Info Color</label>
                            <input type="color" class="form-control form-control-color" id="infoColor" value="#3b82f6" title="Choose info color">
                            <small class="text-muted">Info states</small>
                        </div>
                    </div>
                </div>

                <hr class="my-4">

                <!-- Font Customization -->
                <div class="mb-4">
                    <h6 class="mb-3"><i class="fas fa-font me-2 text-success"></i>Typography</h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="fontFamily" class="form-label">Font Family</label>
                            <select class="form-select" id="fontFamily">
                                <option value="system-ui">System Default</option>
                                <option value="Inter">Inter (Modern)</option>
                                <option value="Roboto">Roboto (Clean)</option>
                                <option value="Open Sans">Open Sans (Friendly)</option>
                                <option value="Lato">Lato (Elegant)</option>
                                <option value="Poppins">Poppins (Rounded)</option>
                                <option value="Montserrat">Montserrat (Geometric)</option>
                                <option value="Nunito">Nunito (Soft)</option>
                                <option value="Source Sans Pro">Source Sans Pro</option>
                                <option value="JetBrains Mono">JetBrains Mono (Code)</option>
                                <option value="Fira Code">Fira Code (Code)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="fontSize" class="form-label">Base Font Size</label>
                            <select class="form-select" id="fontSize">
                                <option value="12px">Small (12px)</option>
                                <option value="14px" selected>Medium (14px)</option>
                                <option value="16px">Large (16px)</option>
                                <option value="18px">Extra Large (18px)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="fontWeight" class="form-label">Font Weight</label>
                            <select class="form-select" id="fontWeight">
                                <option value="300">Light (300)</option>
                                <option value="400" selected>Normal (400)</option>
                                <option value="500">Medium (500)</option>
                                <option value="600">Semi-Bold (600)</option>
                                <option value="700">Bold (700)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <hr class="my-4">

                <!-- Preview & Actions -->
                <div class="mb-3">
                    <h6 class="mb-3"><i class="fas fa-eye me-2 text-info"></i>Live Preview</h6>
                    <div id="customThemePreview" class="p-4 border rounded" style="background: var(--bg-color, #f8f9fa);">
                        <h5 style="color: var(--primary-color, #667eea); font-family: var(--font-family, system-ui); font-size: var(--font-size, 14px); font-weight: var(--font-weight, 400);">
                            Sample Heading
                        </h5>
                        <p style="color: var(--text-color, #212529); font-family: var(--font-family, system-ui); font-size: var(--font-size, 14px);">
                            This is sample text showing how your custom theme will look.
                        </p>
                        <div class="d-flex gap-2 mt-3">
                            <span class="badge" style="background-color: var(--success-color, #10b981);">Success</span>
                            <span class="badge" style="background-color: var(--warning-color, #f59e0b);">Warning</span>
                            <span class="badge" style="background-color: var(--danger-color, #ef4444);">Danger</span>
                            <span class="badge" style="background-color: var(--info-color, #3b82f6);">Info</span>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="row g-2">
                    <div class="col-md-3">
                        <button type="button" class="btn btn-primary w-100" onclick="applyCustomTheme()">
                            <i class="fas fa-check me-2"></i>Apply Theme
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="btn btn-success w-100" onclick="saveCustomTheme()">
                            <i class="fas fa-save me-2"></i>Save Theme
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="btn btn-info w-100" onclick="exportTheme()">
                            <i class="fas fa-download me-2"></i>Export Theme
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="btn btn-warning w-100" onclick="importTheme()">
                            <i class="fas fa-upload me-2"></i>Import Theme
                        </button>
                    </div>
                </div>

                <!-- Import File Input (Hidden) -->
                <input type="file" id="themeImportFile" accept=".json" style="display: none;" onchange="handleThemeImport(event)">

                <div class="mt-3">
                    <span class="badge bg-info" id="customThemeStatus" style="display: none;">
                        <i class="fas fa-info-circle me-1"></i>Custom theme ready
                    </span>
                </div>
            </div>
        </div>

        <!-- Email/SMS Alert Configuration -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0">
                    <i class="fas fa-envelope me-2"></i>Email & SMS Alerts
                </h5>
            </div>
            <div class="card-body p-4">
                <p class="text-muted mb-4">
                    <i class="fas fa-info-circle me-2"></i>
                    Configure email and SMS alerts for critical system events. Alerts are sent based on configured rules.
                </p>

                <!-- Email Configuration -->
                <div class="mb-4">
                    <h6 class="mb-3"><i class="fas fa-envelope me-2 text-primary"></i>Email Configuration</h6>

                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="emailEnabled">
                        <label class="form-check-label" for="emailEnabled">
                            <strong>Enable Email Alerts</strong>
                        </label>
                    </div>

                    <div id="emailConfig" style="display: none;">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="smtpServer" class="form-label">SMTP Server</label>
                                <input type="text" class="form-control" id="smtpServer" placeholder="smtp.gmail.com">
                            </div>
                            <div class="col-md-6">
                                <label for="smtpPort" class="form-label">SMTP Port</label>
                                <input type="number" class="form-control" id="smtpPort" placeholder="587">
                            </div>
                            <div class="col-md-6">
                                <label for="emailUsername" class="form-label">Email Username</label>
                                <input type="email" class="form-control" id="emailUsername" placeholder="your@email.com">
                            </div>
                            <div class="col-md-6">
                                <label for="emailPassword" class="form-label">Email Password / App Password</label>
                                <input type="password" class="form-control" id="emailPassword" placeholder="••••••••">
                                <small class="text-muted">For Gmail, use <a href="https://myaccount.google.com/apppasswords" target="_blank">App Password</a></small>
                            </div>
                            <div class="col-md-6">
                                <label for="fromEmail" class="form-label">From Email</label>
                                <input type="email" class="form-control" id="fromEmail" placeholder="alerts@yourdomain.com">
                            </div>
                            <div class="col-md-6">
                                <label for="emailRecipients" class="form-label">Recipients (comma-separated)</label>
                                <input type="text" class="form-control" id="emailRecipients" placeholder="admin@example.com, team@example.com">
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-primary mt-3" onclick="testEmail()">
                            <i class="fas fa-paper-plane me-2"></i>Send Test Email
                        </button>
                    </div>
                </div>

                <hr class="my-4">

                <!-- SMS Configuration -->
                <div class="mb-4">
                    <h6 class="mb-3"><i class="fas fa-sms me-2 text-success"></i>SMS Configuration (Twilio)</h6>

                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="smsEnabled">
                        <label class="form-check-label" for="smsEnabled">
                            <strong>Enable SMS Alerts</strong>
                        </label>
                    </div>

                    <div id="smsConfig" style="display: none;">
                        <div class="alert alert-info mb-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Twilio Setup:</strong> Get your credentials from <a href="https://www.twilio.com/console" target="_blank">Twilio Console</a>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="twilioAccountSid" class="form-label">Account SID</label>
                                <input type="text" class="form-control" id="twilioAccountSid" placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
                            </div>
                            <div class="col-md-6">
                                <label for="twilioAuthToken" class="form-label">Auth Token</label>
                                <input type="password" class="form-control" id="twilioAuthToken" placeholder="••••••••••••••••••••••••••••••••">
                            </div>
                            <div class="col-md-6">
                                <label for="twilioFromNumber" class="form-label">From Number</label>
                                <input type="tel" class="form-control" id="twilioFromNumber" placeholder="+1234567890">
                            </div>
                            <div class="col-md-6">
                                <label for="smsRecipients" class="form-label">Recipients (comma-separated)</label>
                                <input type="text" class="form-control" id="smsRecipients" placeholder="+1234567890, +0987654321">
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-success mt-3" onclick="testSMS()">
                            <i class="fas fa-mobile-alt me-2"></i>Send Test SMS
                        </button>
                    </div>
                </div>

                <hr class="my-4">

                <!-- Alert Rules -->
                <div class="mb-4">
                    <h6 class="mb-3"><i class="fas fa-sliders-h me-2 text-warning"></i>Alert Rules</h6>

                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="criticalOnly" checked>
                        <label class="form-check-label" for="criticalOnly">
                            <strong>Critical Alerts Only</strong>
                            <small class="d-block text-muted">Only send alerts for critical severity</small>
                        </label>
                    </div>

                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="includeWarnings">
                        <label class="form-check-label" for="includeWarnings">
                            <strong>Include Warnings</strong>
                            <small class="d-block text-muted">Also send alerts for warning severity</small>
                        </label>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Alert Types to Send</label>
                        <div class="form-check">
                            <input class="form-check-input alert-type" type="checkbox" value="health_score" id="alertTypeHealth" checked>
                            <label class="form-check-label" for="alertTypeHealth">Health Score Drops</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input alert-type" type="checkbox" value="hook_failure" id="alertTypeHook" checked>
                            <label class="form-check-label" for="alertTypeHook">Hook Failure</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input alert-type" type="checkbox" value="error_threshold" id="alertTypeError" checked>
                            <label class="form-check-label" for="alertTypeError">Error Threshold Exceeded</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input alert-type" type="checkbox" value="context_usage" id="alertTypeContext">
                            <label class="form-check-label" for="alertTypeContext">Context Usage High</label>
                        </div>
                    </div>

                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="rateLimitEnabled" checked>
                        <label class="form-check-label" for="rateLimitEnabled">
                            <strong>Rate Limiting</strong>
                            <small class="d-block text-muted">Limit to 10 alerts per hour to prevent spam</small>
                        </label>
                    </div>

                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="quietHoursEnabled">
                        <label class="form-check-label" for="quietHoursEnabled">
                            <strong>Quiet Hours</strong>
                        </label>
                    </div>

                    <div id="quietHoursConfig" style="display: none;">
                        <div class="row g-3 ms-4">
                            <div class="col-md-6">
                                <label for="quietHoursStart" class="form-label">Start Time</label>
                                <input type="time" class="form-control" id="quietHoursStart" value="22:00">
                            </div>
                            <div class="col-md-6">
                                <label for="quietHoursEnd" class="form-label">End Time</label>
                                <input type="time" class="form-control" id="quietHoursEnd" value="08:00">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Save Button -->
                <button type="button" class="btn btn-primary" onclick="saveAlertConfig()">
                    <i class="fas fa-save me-2"></i>Save Alert Configuration
                </button>
            </div>
        </div>

        <!-- Notification Settings -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0">
                    <i class="fas fa-bell me-2"></i>Notification Preferences
                </h5>
            </div>
            <div class="card-body p-4">
                <div class="alert alert-info mb-4">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Coming Soon:</strong> Browser notifications for system alerts and policy violations.
                </div>

                <!-- Enable Notifications -->
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="enableNotifications" disabled>
                    <label class="form-check-label" for="enableNotifications">
                        <strong>Enable Browser Notifications</strong>
                        <small class="d-block text-muted">Receive alerts for critical system events</small>
                    </label>
                </div>

                <!-- Error Alerts -->
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="notifyErrors" disabled>
                    <label class="form-check-label" for="notifyErrors">
                        <strong>Error Alerts</strong>
                        <small class="d-block text-muted">Get notified when errors occur</small>
                    </label>
                </div>

                <!-- Policy Violations -->
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="notifyPolicyViolations" disabled>
                    <label class="form-check-label" for="notifyPolicyViolations">
                        <strong>Policy Violations</strong>
                        <small class="d-block text-muted">Alert when policies are violated</small>
                    </label>
                </div>

                <!-- Health Score Drops -->
                <div class="form-check form-switch mb-0">
                    <input class="form-check-input" type="checkbox" id="notifyHealthScore" disabled>
                    <label class="form-check-label" for="notifyHealthScore">
                        <strong>Health Score Drops</strong>
                        <small class="d-block text-muted">Notify when system health drops below threshold</small>
                    </label>
                </div>
            </div>
        </div>

        <!-- Data & Export Settings -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0">
                    <i class="fas fa-database me-2"></i>Data & Export
                </h5>
            </div>
            <div class="card-body p-4">
                <!-- Data Retention -->
                <div class="mb-4">
                    <label for="dataRetention" class="form-label fw-bold">
                        <i class="fas fa-calendar-alt me-2 text-primary"></i>Log Retention Period
                    </label>
                    <select class="form-select" id="dataRetention">
                        <option value="7">7 days</option>
                        <option value="30" selected>30 days</option>
                        <option value="60">60 days</option>
                        <option value="90">90 days</option>
                        <option value="180">180 days</option>
                    </select>
                    <small class="text-muted d-block mt-2">
                        <i class="fas fa-info-circle"></i>
                        How long to keep historical log data
                    </small>
                </div>

                <!-- Export Format -->
                <div class="mb-4">
                    <label for="exportFormat" class="form-label fw-bold">
                        <i class="fas fa-file-export me-2 text-primary"></i>Default Export Format
                    </label>
                    <select class="form-select" id="exportFormat">
                        <option value="csv" selected>CSV (Comma Separated)</option>
                        <option value="json">JSON</option>
                        <option value="xlsx">Excel (Coming Soon)</option>
                    </select>
                    <small class="text-muted d-block mt-2">
                        <i class="fas fa-info-circle"></i>
                        Preferred format for exported data
                    </small>
                </div>

                <!-- Include Headers -->
                <div class="form-check form-switch mb-0">
                    <input class="form-check-input" type="checkbox" id="exportHeaders" checked>
                    <label class="form-check-label" for="exportHeaders">
                        <strong>Include Headers in Exports</strong>
                        <small class="d-block text-muted">Add column headers to CSV exports</small>
                    </label>
                </div>
            </div>
        </div>

        <!-- Advanced Settings -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0">
                    <i class="fas fa-sliders-h me-2"></i>Advanced Settings
                </h5>
            </div>
            <div class="card-body p-4">
                <!-- Show Debug Info -->
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="showDebugInfo">
                    <label class="form-check-label" for="showDebugInfo">
                        <strong>Show Debug Information</strong>
                        <small class="d-block text-muted">Display additional technical details in the UI</small>
                    </label>
                </div>

                <!-- API Response Time -->
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="showApiTime">
                    <label class="form-check-label" for="showApiTime">
                        <strong>Show API Response Times</strong>
                        <small class="d-block text-muted">Display how long API calls take</small>
                    </label>
                </div>

                <!-- Compact Navigation -->
                <div class="form-check form-switch mb-0">
                    <input class="form-check-input" type="checkbox" id="compactNav">
                    <label class="form-check-label" for="compactNav">
                        <strong>Compact Navigation</strong>
                        <small class="d-block text-muted">Use a smaller navigation bar</small>
                    </label>
                </div>
            </div>
        </div>

        <!-- Alert Thresholds -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0">
                    <i class="fas fa-bell me-2"></i>Alert Thresholds
                </h5>
            </div>
            <div class="card-body p-4">
                <p class="text-muted mb-4">
                    <i class="fas fa-info-circle me-2"></i>
                    Set custom thresholds for system alerts. You'll be notified when metrics cross these values.
                </p>

                <!-- Health Score Threshold -->
                <div class="mb-4">
                    <label for="healthScoreThreshold" class="form-label fw-bold">
                        <i class="fas fa-heartbeat me-2 text-danger"></i>Health Score Threshold
                    </label>
                    <div class="d-flex align-items-center gap-3">
                        <input type="range" class="form-range flex-grow-1" id="healthScoreThreshold"
                               min="0" max="100" value="{{ alert_thresholds.health_score }}" step="5"
                               oninput="updateThresholdValue('healthScore', this.value)">
                        <span class="badge bg-danger fs-6" id="healthScoreValue" style="min-width: 60px;">
                            {{ alert_thresholds.health_score }}%
                        </span>
                    </div>
                    <small class="text-muted d-block mt-2">
                        Alert when health score falls below this value
                    </small>
                </div>

                <!-- Error Count Threshold -->
                <div class="mb-4">
                    <label for="errorCountThreshold" class="form-label fw-bold">
                        <i class="fas fa-exclamation-triangle me-2 text-warning"></i>Error Count Threshold (per hour)
                    </label>
                    <div class="d-flex align-items-center gap-3">
                        <input type="range" class="form-range flex-grow-1" id="errorCountThreshold"
                               min="0" max="50" value="{{ alert_thresholds.error_count }}" step="5"
                               oninput="updateThresholdValue('errorCount', this.value)">
                        <span class="badge bg-warning fs-6" id="errorCountValue" style="min-width: 60px;">
                            {{ alert_thresholds.error_count }}
                        </span>
                    </div>
                    <small class="text-muted d-block mt-2">
                        Alert when errors exceed this count per hour
                    </small>
                </div>

                <!-- Context Usage Threshold -->
                <div class="mb-4">
                    <label for="contextUsageThreshold" class="form-label fw-bold">
                        <i class="fas fa-database me-2 text-info"></i>Context Usage Threshold
                    </label>
                    <div class="d-flex align-items-center gap-3">
                        <input type="range" class="form-range flex-grow-1" id="contextUsageThreshold"
                               min="50" max="100" value="{{ alert_thresholds.context_usage }}" step="5"
                               oninput="updateThresholdValue('contextUsage', this.value)">
                        <span class="badge bg-info fs-6" id="contextUsageValue" style="min-width: 60px;">
                            {{ alert_thresholds.context_usage }}%
                        </span>
                    </div>
                    <small class="text-muted d-block mt-2">
                        Alert when context usage exceeds this percentage
                    </small>
                </div>

                <!-- Hook Failure Alert -->
                <div class="form-check form-switch mb-4">
                    <input class="form-check-input" type="checkbox" id="hookFailureAlert"
                           {{ 'checked' if alert_thresholds.get('hook_failure', False) else '' }}>
                    <label class="form-check-label" for="hookFailureAlert">
                        <strong><i class="fas fa-plug me-2 text-primary"></i>Alert on Hook Failure</strong>
                        <small class="d-block text-muted">Get notified when enforcement hooks fail</small>
                    </label>
                </div>

                <!-- Save Button -->
                <button type="button" class="btn btn-primary" onclick="saveAlertThresholds()">
                    <i class="fas fa-save me-2"></i>Save Alert Thresholds
                </button>

                <!-- Current Alerts Badge -->
                <div class="mt-4 p-3 bg-light rounded" id="currentAlerts" style="display: none;">
                    <h6 class="mb-2"><i class="fas fa-bell me-2 text-warning"></i>Active Alerts</h6>
                    <div id="alertsList"></div>
                </div>
            </div>
        </div>

        <!-- Change Password -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0">
                    <i class="fas fa-key me-2"></i>Change Password
                </h5>
            </div>
            <div class="card-body p-4">
                <form id="changePasswordForm" onsubmit="changePassword(event)">
                    <!-- Current Password -->
                    <div class="mb-3">
                        <label for="currentPassword" class="form-label fw-bold">
                            <i class="fas fa-lock me-2 text-primary"></i>Current Password
                        </label>
                        <input type="password" class="form-control" id="currentPassword" required
                               placeholder="Enter your current password">
                    </div>

                    <!-- New Password -->
                    <div class="mb-3">
                        <label for="newPassword" class="form-label fw-bold">
                            <i class="fas fa-lock me-2 text-success"></i>New Password
                        </label>
                        <input type="password" class="form-control" id="newPassword" required
                               minlength="6" placeholder="Enter new password (min 6 characters)">
                        <small class="text-muted d-block mt-2">
                            <i class="fas fa-info-circle"></i>
                            Password must be at least 6 characters long
                        </small>
                    </div>

                    <!-- Confirm Password -->
                    <div class="mb-4">
                        <label for="confirmPassword" class="form-label fw-bold">
                            <i class="fas fa-lock me-2 text-success"></i>Confirm New Password
                        </label>
                        <input type="password" class="form-control" id="confirmPassword" required
                               minlength="6" placeholder="Confirm new password">
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-key me-2"></i>Change Password
                    </button>
                </form>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                    <div>
                        <button type="button" class="btn btn-primary btn-lg" onclick="saveSettings()">
                            <i class="fas fa-save me-2"></i>Save Settings
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-lg" onclick="resetSettings()">
                            <i class="fas fa-undo me-2"></i>Reset to Defaults
                        </button>
                    </div>
                    <button type="button" class="btn btn-outline-danger" onclick="clearAllData()">
                        <i class="fas fa-trash-alt me-2"></i>Clear All Data
                    </button>
                </div>
            </div>
        </div>

        <!-- System Info -->
        <div class="card border-0 shadow-sm bg-light">
            <div class="card-body p-4">
                <div class="row text-center">
                    <div class="col-md-4 mb-3 mb-md-0">
                        <div class="text-muted small">Version</div>
                        <div class="fw-bold">v2.5</div>
                    </div>
                    <div class="col-md-4 mb-3 mb-md-0">
                        <div class="text-muted small">Last Updated</div>
                        <div class="fw-bold" id="lastSaved">Never</div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-muted small">Settings Status</div>
                        <div class="fw-bold">
                            <span class="badge bg-success" id="settingsStatus">
                                <i class="fas fa-check"></i> Saved
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Settings management
let currentSettings = {};

document.addEventListener('DOMContentLoaded', function() {
    loadSettings();
});

function loadSettings() {
    // Load settings from localStorage
    const savedSettings = localStorage.getItem('claudeMonitorSettings');
    if (savedSettings) {
        currentSettings = JSON.parse(savedSettings);
        applySettings(currentSettings);

        // Update last saved time
        if (currentSettings.lastSaved) {
            document.getElementById('lastSaved').textContent = new Date(currentSettings.lastSaved).toLocaleString();
        }
    } else {
        // Load defaults
        currentSettings = getDefaultSettings();
    }
}

function getDefaultSettings() {
    return {
        refreshInterval: '30',
        themePreference: 'light',
        defaultPage: 'dashboard',
        dashboardDensity: 'comfortable',
        enableNotifications: false,
        notifyErrors: false,
        notifyPolicyViolations: false,
        notifyHealthScore: false,
        dataRetention: '30',
        exportFormat: 'csv',
        exportHeaders: true,
        showDebugInfo: false,
        showApiTime: false,
        compactNav: false,
        lastSaved: null
    };
}

function applySettings(settings) {
    // Apply each setting to the form
    document.getElementById('refreshInterval').value = settings.refreshInterval || '30';
    document.getElementById('themePreference').value = settings.themePreference || 'light';
    document.getElementById('defaultPage').value = settings.defaultPage || 'dashboard';
    document.getElementById('dashboardDensity').value = settings.dashboardDensity || 'comfortable';
    document.getElementById('dataRetention').value = settings.dataRetention || '30';
    document.getElementById('exportFormat').value = settings.exportFormat || 'csv';
    document.getElementById('exportHeaders').checked = settings.exportHeaders !== false;
    document.getElementById('showDebugInfo').checked = settings.showDebugInfo === true;
    document.getElementById('showApiTime').checked = settings.showApiTime === true;
    document.getElementById('compactNav').checked = settings.compactNav === true;
}

function collectSettings() {
    return {
        refreshInterval: document.getElementById('refreshInterval').value,
        themePreference: document.getElementById('themePreference').value,
        defaultPage: document.getElementById('defaultPage').value,
        dashboardDensity: document.getElementById('dashboardDensity').value,
        enableNotifications: document.getElementById('enableNotifications').checked,
        notifyErrors: document.getElementById('notifyErrors').checked,
        notifyPolicyViolations: document.getElementById('notifyPolicyViolations').checked,
        notifyHealthScore: document.getElementById('notifyHealthScore').checked,
        dataRetention: document.getElementById('dataRetention').value,
        exportFormat: document.getElementById('exportFormat').value,
        exportHeaders: document.getElementById('exportHeaders').checked,
        showDebugInfo: document.getElementById('showDebugInfo').checked,
        showApiTime: document.getElementById('showApiTime').checked,
        compactNav: document.getElementById('compactNav').checked,
        lastSaved: new Date().toISOString()
    };
}

function saveSettings() {
    currentSettings = collectSettings();

    // Save to localStorage
    localStorage.setItem('claudeMonitorSettings', JSON.stringify(currentSettings));

    // Apply theme immediately
    applyThemeFromSettings();

    // Update last saved time
    document.getElementById('lastSaved').textContent = new Date(currentSettings.lastSaved).toLocaleString();

    // Show success message
    showAlert('success', 'Settings saved successfully!');

    // Update status badge
    const statusBadge = document.getElementById('settingsStatus');
    statusBadge.innerHTML = '<i class="fas fa-check"></i> Saved';
    statusBadge.className = 'badge bg-success';
}

function resetSettings() {
    if (confirm('Are you sure you want to reset all settings to their default values?')) {
        currentSettings = getDefaultSettings();
        applySettings(currentSettings);
        localStorage.removeItem('claudeMonitorSettings');

        document.getElementById('lastSaved').textContent = 'Never';
        showAlert('info', 'Settings reset to defaults. Click "Save Settings" to apply.');

        // Update status badge
        const statusBadge = document.getElementById('settingsStatus');
        statusBadge.innerHTML = '<i class="fas fa-exclamation-circle"></i> Unsaved';
        statusBadge.className = 'badge bg-warning';
    }
}

function clearAllData() {
    if (confirm('Are you sure you want to clear ALL stored data? This action cannot be undone and will:\n\n- Clear all settings\n- Clear browser cache\n- Reset all preferences\n\nYou will need to reconfigure your settings.')) {
        // Clear localStorage
        localStorage.clear();

        // Reset form
        currentSettings = getDefaultSettings();
        applySettings(currentSettings);
        document.getElementById('lastSaved').textContent = 'Never';

        showAlert('warning', 'All data has been cleared. Please reconfigure your settings.');

        // Update status badge
        const statusBadge = document.getElementById('settingsStatus');
        statusBadge.innerHTML = '<i class="fas fa-exclamation-circle"></i> Reset';
        statusBadge.className = 'badge bg-danger';
    }
}

function showAlert(type, message) {
    const alertContainer = document.getElementById('alertContainer');
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            <i class="fas ${getAlertIcon(type)} me-2"></i>
            <strong>${message}</strong>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    alertContainer.innerHTML = alertHtml;

    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        const alert = alertContainer.querySelector('.alert');
        if (alert) {
            alert.classList.remove('show');
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 150);
        }
    }, 5000);
}

function getAlertIcon(type) {
    const icons = {
        'success': 'fa-check-circle',
        'danger': 'fa-exclamation-circle',
        'warning': 'fa-exclamation-triangle',
        'info': 'fa-info-circle'
    };
    return icons[type] || 'fa-info-circle';
}

// Detect unsaved changes
document.querySelectorAll('input, select').forEach(element => {
    element.addEventListener('change', function() {
        const statusBadge = document.getElementById('settingsStatus');
        if (statusBadge.classList.contains('bg-success')) {
            statusBadge.innerHTML = '<i class="fas fa-exclamation-circle"></i> Unsaved';
            statusBadge.className = 'badge bg-warning';
        }
    });
});

// Apply theme from settings dropdown
function applyThemeFromSettings() {
    const theme = document.getElementById('themePreference').value;

    if (theme === 'auto') {
        // Use system preference
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        applyTheme(prefersDark ? 'dark' : 'light');
    } else {
        applyTheme(theme);
    }

    // Store preference as 'theme' in localStorage for base.html to use
    localStorage.setItem('theme', theme === 'auto' ?
        (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') :
        theme
    );
}

// Alert Thresholds Functions
function updateThresholdValue(type, value) {
    document.getElementById(type + 'Value').textContent = value + (type === 'errorCount' ? '' : '%');
}

function saveAlertThresholds() {
    const thresholds = {
        health_score: parseInt(document.getElementById('healthScoreThreshold').value),
        error_count: parseInt(document.getElementById('errorCountThreshold').value),
        context_usage: parseInt(document.getElementById('contextUsageThreshold').value),
        hook_failure: document.getElementById('hookFailureAlert').checked
    };

    fetch('/api/alert-thresholds', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(thresholds)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', 'Alert thresholds saved successfully!');
            checkAlerts();  // Check if any alerts are currently triggered
        } else {
            showAlert('danger', data.message || 'Failed to save alert thresholds');
        }
    })
    .catch(error => {
        console.error('Error saving alert thresholds:', error);
        showAlert('danger', 'An error occurred while saving alert thresholds');
    });
}

function checkAlerts() {
    fetch('/api/check-alerts')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const alertsContainer = document.getElementById('currentAlerts');
                const alertsList = document.getElementById('alertsList');

                if (data.alert_count > 0) {
                    alertsContainer.style.display = 'block';
                    alertsList.innerHTML = data.alerts.map(alert => `
                        <div class="alert alert-${alert.severity === 'critical' ? 'danger' : 'warning'} py-2 mb-2">
                            <i class="fas fa-${alert.severity === 'critical' ? 'exclamation-circle' : 'exclamation-triangle'} me-2"></i>
                            <strong>${alert.type.replace('_', ' ').toUpperCase()}:</strong> ${alert.message}
                        </div>
                    `).join('');
                } else {
                    alertsContainer.style.display = 'none';
                }
            }
        })
        .catch(error => {
            console.error('Error checking alerts:', error);
        });
}

// Check alerts on page load
document.addEventListener('DOMContentLoaded', function() {
    checkAlerts();
    // Check alerts every 30 seconds
    setInterval(checkAlerts, 30000);

    // Load alert configuration
    loadAlertConfig();

    // Toggle email/SMS config visibility
    document.getElementById('emailEnabled').addEventListener('change', function() {
        document.getElementById('emailConfig').style.display = this.checked ? 'block' : 'none';
    });

    document.getElementById('smsEnabled').addEventListener('change', function() {
        document.getElementById('smsConfig').style.display = this.checked ? 'block' : 'none';
    });

    document.getElementById('quietHoursEnabled').addEventListener('change', function() {
        document.getElementById('quietHoursConfig').style.display = this.checked ? 'block' : 'none';
    });
});

// Alert Configuration Functions
function loadAlertConfig() {
    fetch('/api/alert-config')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.config) {
                const config = data.config;

                // Email config
                if (config.email) {
                    document.getElementById('emailEnabled').checked = config.email.enabled || false;
                    document.getElementById('smtpServer').value = config.email.smtp_server || 'smtp.gmail.com';
                    document.getElementById('smtpPort').value = config.email.smtp_port || 587;
                    document.getElementById('emailUsername').value = config.email.username || '';
                    document.getElementById('fromEmail').value = config.email.from_email || '';
                    document.getElementById('emailRecipients').value = (config.email.recipients || []).join(', ');

                    if (config.email.enabled) {
                        document.getElementById('emailConfig').style.display = 'block';
                    }
                }

                // SMS config
                if (config.sms) {
                    document.getElementById('smsEnabled').checked = config.sms.enabled || false;
                    document.getElementById('twilioAccountSid').value = config.sms.account_sid || '';
                    document.getElementById('twilioFromNumber').value = config.sms.from_number || '';
                    document.getElementById('smsRecipients').value = (config.sms.recipients || []).join(', ');

                    if (config.sms.enabled) {
                        document.getElementById('smsConfig').style.display = 'block';
                    }
                }

                // Alert rules
                if (config.alert_rules) {
                    document.getElementById('criticalOnly').checked = config.alert_rules.critical_only !== false;
                    document.getElementById('includeWarnings').checked = config.alert_rules.include_warnings || false;

                    const alertTypes = config.alert_rules.alert_types || [];
                    document.querySelectorAll('.alert-type').forEach(checkbox => {
                        checkbox.checked = alertTypes.includes(checkbox.value);
                    });

                    if (config.alert_rules.rate_limiting) {
                        document.getElementById('rateLimitEnabled').checked = config.alert_rules.rate_limiting.enabled !== false;
                    }

                    if (config.alert_rules.quiet_hours) {
                        document.getElementById('quietHoursEnabled').checked = config.alert_rules.quiet_hours.enabled || false;
                        document.getElementById('quietHoursStart').value = config.alert_rules.quiet_hours.start || '22:00';
                        document.getElementById('quietHoursEnd').value = config.alert_rules.quiet_hours.end || '08:00';

                        if (config.alert_rules.quiet_hours.enabled) {
                            document.getElementById('quietHoursConfig').style.display = 'block';
                        }
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error loading alert config:', error);
        });
}

function saveAlertConfig() {
    const emailRecipients = document.getElementById('emailRecipients').value
        .split(',').map(e => e.trim()).filter(e => e);
    const smsRecipients = document.getElementById('smsRecipients').value
        .split(',').map(e => e.trim()).filter(e => e);

    const alertTypes = Array.from(document.querySelectorAll('.alert-type:checked'))
        .map(checkbox => checkbox.value);

    const config = {
        email: {
            enabled: document.getElementById('emailEnabled').checked,
            smtp_server: document.getElementById('smtpServer').value,
            smtp_port: parseInt(document.getElementById('smtpPort').value) || 587,
            username: document.getElementById('emailUsername').value,
            password: document.getElementById('emailPassword').value || undefined,
            from_email: document.getElementById('fromEmail').value,
            recipients: emailRecipients,
            use_tls: true
        },
        sms: {
            enabled: document.getElementById('smsEnabled').checked,
            provider: 'twilio',
            account_sid: document.getElementById('twilioAccountSid').value,
            auth_token: document.getElementById('twilioAuthToken').value || undefined,
            from_number: document.getElementById('twilioFromNumber').value,
            recipients: smsRecipients
        },
        alert_rules: {
            critical_only: document.getElementById('criticalOnly').checked,
            include_warnings: document.getElementById('includeWarnings').checked,
            alert_types: alertTypes,
            quiet_hours: {
                enabled: document.getElementById('quietHoursEnabled').checked,
                start: document.getElementById('quietHoursStart').value,
                end: document.getElementById('quietHoursEnd').value
            },
            rate_limiting: {
                enabled: document.getElementById('rateLimitEnabled').checked,
                max_alerts_per_hour: 10
            }
        }
    };

    fetch('/api/alert-config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', 'Alert configuration saved successfully!');
        } else {
            showAlert('danger', data.message || 'Failed to save alert configuration');
        }
    })
    .catch(error => {
        console.error('Error saving alert config:', error);
        showAlert('danger', 'An error occurred while saving alert configuration');
    });
}

function testEmail() {
    showAlert('info', 'Sending test email...');

    fetch('/api/test-email', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', 'Test email sent successfully! Check your inbox.');
        } else {
            showAlert('danger', data.message || 'Failed to send test email');
        }
    })
    .catch(error => {
        console.error('Error sending test email:', error);
        showAlert('danger', 'An error occurred while sending test email');
    });
}

function testSMS() {
    showAlert('info', 'Sending test SMS...');

    fetch('/api/test-sms', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', 'Test SMS sent successfully! Check your phone.');
        } else {
            showAlert('danger', data.message || 'Failed to send test SMS');
        }
    })
    .catch(error => {
        console.error('Error sending test SMS:', error);
        showAlert('danger', 'An error occurred while sending test SMS');
    });
}

// Change password function
function changePassword(event) {
    event.preventDefault();

    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;

    // Validate passwords match
    if (newPassword !== confirmPassword) {
        showAlert('danger', 'New passwords do not match!');
        return;
    }

    // Validate password length
    if (newPassword.length < 6) {
        showAlert('danger', 'Password must be at least 6 characters long!');
        return;
    }

    // Send request to change password
    fetch('/api/change-password', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            current_password: currentPassword,
            new_password: newPassword,
            confirm_password: confirmPassword
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', 'Password changed successfully!');
            // Clear form
            document.getElementById('changePasswordForm').reset();
        } else {
            showAlert('danger', data.message || 'Failed to change password');
        }
    })
    .catch(error => {
        console.error('Error changing password:', error);
        showAlert('danger', 'An error occurred while changing password');
    });
}

// Theme selection function
function selectTheme(themeName) {
    // Save theme to server
    fetch('/api/themes', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ theme: themeName })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove active class from all theme cards
            document.querySelectorAll('.theme-card').forEach(card => {
                card.classList.remove('active');
            });

            // Add active class to selected theme
            const selectedCard = document.querySelector(`[data-theme="${themeName}"]`);
            if (selectedCard) {
                selectedCard.classList.add('active');
            }

            // Show success message
            const statusBadge = document.getElementById('themeStatus');
            statusBadge.style.display = 'inline-block';
            setTimeout(() => {
                statusBadge.style.display = 'none';
            }, 3000);

            // Apply theme to current page
            applyThemeColors(themeName);
        }
    })
    .catch(error => {
        console.error('Error saving theme:', error);
        showAlert('danger', 'Failed to save theme preference');
    });
}

// Apply theme colors to page
function applyThemeColors(themeName) {
    const themes = {
        'default': {
            primary: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            background: '#f8f9fa'
        },
        'dark': {
            primary: '#1e293b',
            background: '#334155'
        },
        'blue': {
            primary: 'linear-gradient(135deg, #3b82f6 0%, #1e40af 100%)',
            background: '#dbeafe'
        },
        'purple': {
            primary: 'linear-gradient(135deg, #a855f7 0%, #7c3aed 100%)',
            background: '#f3e8ff'
        },
        'green': {
            primary: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
            background: '#d1fae5'
        },
        'orange': {
            primary: 'linear-gradient(135deg, #f97316 0%, #ea580c 100%)',
            background: '#fed7aa'
        },
        'cyberpunk': {
            primary: 'linear-gradient(135deg, #ff00ff 0%, #00ffff 100%)',
            background: '#0a0a0a'
        },
        'ocean': {
            primary: 'linear-gradient(135deg, #0077be 0%, #00a8e8 100%)',
            background: '#e0f4ff'
        },
        'forest': {
            primary: 'linear-gradient(135deg, #2d5016 0%, #4a7c59 100%)',
            background: '#d4edda'
        },
        'sunset': {
            primary: 'linear-gradient(135deg, #ff6b6b 0%, #ffd93d 100%)',
            background: '#ffe5e5'
        },
        'nord': {
            primary: 'linear-gradient(135deg, #5e81ac 0%, #81a1c1 100%)',
            background: '#eceff4'
        },
        'tokyo-night': {
            primary: 'linear-gradient(135deg, #7aa2f7 0%, #bb9af7 100%)',
            background: '#1a1b26'
        },
        'dracula': {
            primary: 'linear-gradient(135deg, #bd93f9 0%, #ff79c6 100%)',
            background: '#282a36'
        },
        'monokai': {
            primary: 'linear-gradient(135deg, #f92672 0%, #a6e22e 100%)',
            background: '#272822'
        },
        'purple': {
            primary: 'linear-gradient(135deg, #a855f7 0%, #7c3aed 100%)',
            background: '#f3e8ff'
        },
        'green': {
            primary: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
            background: '#d1fae5'
        },
        'orange': {
            primary: 'linear-gradient(135deg, #f97316 0%, #ea580c 100%)',
            background: '#fed7aa'
        }
    };

    const theme = themes[themeName] || themes['default'];

    // Apply to primary buttons
    document.querySelectorAll('.btn-primary').forEach(btn => {
        btn.style.background = theme.primary;
    });

    // Save to localStorage for persistence
    localStorage.setItem('selectedTheme', themeName);
}

// Load saved theme on page load
document.addEventListener('DOMContentLoaded', function() {
    const savedTheme = localStorage.getItem('selectedTheme') || 'default';
    const savedCard = document.querySelector(`[data-theme="${savedTheme}"]`);
    if (savedCard) {
        savedCard.classList.add('active');
    }
    applyThemeColors(savedTheme);

    // Initialize custom theme builder listeners
    initCustomThemeBuilder();
});

// ========================================
// CUSTOM THEME BUILDER FUNCTIONS
// ========================================

function initCustomThemeBuilder() {
    // Add event listeners for color pickers
    const colorInputs = ['primaryColor', 'secondaryColor', 'backgroundColor', 'textColor',
                        'successColor', 'warningColor', 'dangerColor', 'infoColor'];

    colorInputs.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('input', updateCustomThemePreview);
        }
    });

    // Add event listeners for font settings
    const fontInputs = ['fontFamily', 'fontSize', 'fontWeight'];
    fontInputs.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('change', updateCustomThemePreview);
        }
    });

    // Load saved custom theme if exists
    const savedCustomTheme = localStorage.getItem('customTheme');
    if (savedCustomTheme) {
        loadCustomThemeToBuilder(JSON.parse(savedCustomTheme));
    }
}

function updateCustomThemePreview() {
    const preview = document.getElementById('customThemePreview');
    if (!preview) return;

    // Get color values
    const primaryColor = document.getElementById('primaryColor').value;
    const secondaryColor = document.getElementById('secondaryColor').value;
    const backgroundColor = document.getElementById('backgroundColor').value;
    const textColor = document.getElementById('textColor').value;
    const successColor = document.getElementById('successColor').value;
    const warningColor = document.getElementById('warningColor').value;
    const dangerColor = document.getElementById('dangerColor').value;
    const infoColor = document.getElementById('infoColor').value;

    // Get font values
    const fontFamily = document.getElementById('fontFamily').value;
    const fontSize = document.getElementById('fontSize').value;
    const fontWeight = document.getElementById('fontWeight').value;

    // Apply to preview
    preview.style.setProperty('--primary-color', primaryColor);
    preview.style.setProperty('--secondary-color', secondaryColor);
    preview.style.setProperty('--bg-color', backgroundColor);
    preview.style.setProperty('--text-color', textColor);
    preview.style.setProperty('--success-color', successColor);
    preview.style.setProperty('--warning-color', warningColor);
    preview.style.setProperty('--danger-color', dangerColor);
    preview.style.setProperty('--info-color', infoColor);
    preview.style.setProperty('--font-family', fontFamily);
    preview.style.setProperty('--font-size', fontSize);
    preview.style.setProperty('--font-weight', fontWeight);
}

function applyCustomTheme() {
    // Get all custom theme values
    const customTheme = collectCustomTheme();

    // Apply to document root
    applyCustomThemeToPage(customTheme);

    // Show success message
    const statusBadge = document.getElementById('customThemeStatus');
    if (statusBadge) {
        statusBadge.textContent = '✓ Custom theme applied!';
        statusBadge.className = 'badge bg-success';
        statusBadge.style.display = 'inline-block';

        setTimeout(() => {
            statusBadge.style.display = 'none';
        }, 3000);
    }
}

function saveCustomTheme() {
    const customTheme = collectCustomTheme();

    // Save to localStorage
    localStorage.setItem('customTheme', JSON.stringify(customTheme));

    // Apply immediately
    applyCustomThemeToPage(customTheme);

    // Show success message
    const statusBadge = document.getElementById('customThemeStatus');
    if (statusBadge) {
        statusBadge.textContent = '✓ Custom theme saved!';
        statusBadge.className = 'badge bg-success';
        statusBadge.style.display = 'inline-block';

        setTimeout(() => {
            statusBadge.style.display = 'none';
        }, 3000);
    }

    showAlert('success', 'Custom theme saved successfully!');
}

function exportTheme() {
    const customTheme = collectCustomTheme();

    // Add metadata
    customTheme.metadata = {
        name: prompt('Enter a name for this theme:', 'My Custom Theme') || 'Custom Theme',
        author: prompt('Enter author name (optional):', '') || 'Anonymous',
        version: '1.0.0',
        createdAt: new Date().toISOString()
    };

    // Convert to JSON
    const themeJSON = JSON.stringify(customTheme, null, 2);

    // Create blob and download
    const blob = new Blob([themeJSON], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${customTheme.metadata.name.replace(/\s+/g, '-').toLowerCase()}-theme.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    showAlert('success', 'Theme exported successfully!');
}

function importTheme() {
    const fileInput = document.getElementById('themeImportFile');
    if (fileInput) {
        fileInput.click();
    }
}

function handleThemeImport(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const theme = JSON.parse(e.target.result);

            // Validate theme structure
            if (!theme.colors || !theme.typography) {
                throw new Error('Invalid theme format');
            }

            // Load theme to builder
            loadCustomThemeToBuilder(theme);

            // Apply theme
            applyCustomThemeToPage(theme);

            // Save to localStorage
            localStorage.setItem('customTheme', JSON.stringify(theme));

            showAlert('success', `Theme "${theme.metadata?.name || 'Imported Theme'}" loaded successfully!`);
        } catch (error) {
            console.error('Error importing theme:', error);
            showAlert('danger', 'Failed to import theme. Please check the file format.');
        }
    };
    reader.readAsText(file);

    // Reset file input
    event.target.value = '';
}

function collectCustomTheme() {
    return {
        colors: {
            primary: document.getElementById('primaryColor').value,
            secondary: document.getElementById('secondaryColor').value,
            background: document.getElementById('backgroundColor').value,
            text: document.getElementById('textColor').value,
            success: document.getElementById('successColor').value,
            warning: document.getElementById('warningColor').value,
            danger: document.getElementById('dangerColor').value,
            info: document.getElementById('infoColor').value
        },
        typography: {
            fontFamily: document.getElementById('fontFamily').value,
            fontSize: document.getElementById('fontSize').value,
            fontWeight: document.getElementById('fontWeight').value
        }
    };
}

function loadCustomThemeToBuilder(theme) {
    if (theme.colors) {
        document.getElementById('primaryColor').value = theme.colors.primary || '#667eea';
        document.getElementById('secondaryColor').value = theme.colors.secondary || '#764ba2';
        document.getElementById('backgroundColor').value = theme.colors.background || '#f8f9fa';
        document.getElementById('textColor').value = theme.colors.text || '#212529';
        document.getElementById('successColor').value = theme.colors.success || '#10b981';
        document.getElementById('warningColor').value = theme.colors.warning || '#f59e0b';
        document.getElementById('dangerColor').value = theme.colors.danger || '#ef4444';
        document.getElementById('infoColor').value = theme.colors.info || '#3b82f6';
    }

    if (theme.typography) {
        document.getElementById('fontFamily').value = theme.typography.fontFamily || 'system-ui';
        document.getElementById('fontSize').value = theme.typography.fontSize || '14px';
        document.getElementById('fontWeight').value = theme.typography.fontWeight || '400';
    }

    // Update preview
    updateCustomThemePreview();
}

function applyCustomThemeToPage(theme) {
    const root = document.documentElement;

    // Apply colors
    root.style.setProperty('--bs-primary', theme.colors.primary);
    root.style.setProperty('--bs-secondary', theme.colors.secondary);
    root.style.setProperty('--bs-body-bg', theme.colors.background);
    root.style.setProperty('--bs-body-color', theme.colors.text);
    root.style.setProperty('--bs-success', theme.colors.success);
    root.style.setProperty('--bs-warning', theme.colors.warning);
    root.style.setProperty('--bs-danger', theme.colors.danger);
    root.style.setProperty('--bs-info', theme.colors.info);

    // Apply typography
    root.style.setProperty('--bs-body-font-family', theme.typography.fontFamily);
    root.style.setProperty('--bs-body-font-size', theme.typography.fontSize);
    root.style.setProperty('--bs-body-font-weight', theme.typography.fontWeight);

    // Apply to body
    document.body.style.fontFamily = theme.typography.fontFamily;
    document.body.style.fontSize = theme.typography.fontSize;
    document.body.style.fontWeight = theme.typography.fontWeight;
    document.body.style.backgroundColor = theme.colors.background;
    document.body.style.color = theme.colors.text;
}

// ========================================
// END CUSTOM THEME BUILDER FUNCTIONS
// ========================================

// ========================================
// TRACE_MODE TOGGLE
// ========================================
function loadTraceMode() {
    fetch('/api/trace-mode')
        .then(r => r.json())
        .then(data => {
            const toggle = document.getElementById('traceModeToggle');
            const status = document.getElementById('traceModeStatus');
            if (!toggle) return;

            if (!data.claude_md_exists) {
                status.textContent = 'CLAUDE.md not found - memory system may not be installed.';
                toggle.disabled = true;
            } else if (data.enabled === null) {
                status.textContent = 'TRACE_MODE flag not found in CLAUDE.md.';
                toggle.disabled = true;
            } else {
                toggle.checked = data.enabled;
                status.textContent = data.enabled
                    ? 'Currently ON - 3-level flow trace is shown before every response.'
                    : 'Currently OFF - policies run silently in the background.';
            }
        })
        .catch(() => {
            const status = document.getElementById('traceModeStatus');
            if (status) status.textContent = 'Could not load TRACE_MODE status.';
        });
}

function setTraceMode(enabled) {
    const status = document.getElementById('traceModeStatus');
    if (status) status.textContent = 'Saving...';

    fetch('/api/trace-mode', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({enabled: enabled})
    })
    .then(r => r.json())
    .then(data => {
        if (status) {
            status.textContent = data.success
                ? (enabled ? 'Saved. TRACE_MODE is now ON.' : 'Saved. TRACE_MODE is now OFF.')
                : ('Error: ' + data.message);
            status.className = 'small ' + (data.success ? 'text-success' : 'text-danger') + ' mb-2';
        }
    })
    .catch(e => {
        if (status) { status.textContent = 'Request failed: ' + e; status.className = 'small text-danger mb-2'; }
    });
}

// ========================================
// STARTUP & HOOK STATUS
// ========================================
function loadStartupStatus() {
    const body = document.getElementById('startupStatusBody');
    if (!body) return;
    body.innerHTML = '<div class="text-muted small"><i class="fas fa-spinner fa-spin me-1"></i>Checking...</div>';

    fetch('/api/startup-status')
        .then(r => r.json())
        .then(data => {
            if (!data.success) {
                body.innerHTML = '<div class="text-danger small">Error loading status.</div>';
                return;
            }

            let html = '<div class="row g-2 small">';

            // Platform
            html += `<div class="col-12 text-muted mb-1">Platform: <strong>${data.platform}</strong></div>`;

            // Windows startup .lnk
            if (data.startup_lnk.checked) {
                const ok = data.startup_lnk.exists;
                html += `<div class="col-md-6">
                    <span class="badge ${ok ? 'bg-success' : 'bg-warning text-dark'}">
                        <i class="fas ${ok ? 'fa-check' : 'fa-exclamation-triangle'} me-1"></i>
                        Startup Shortcut
                    </span>
                    <small class="d-block text-muted mt-1">${ok ? 'Found' : 'Not found — daemons may not auto-start'}</small>
                </div>`;
            }

            // settings.json hooks
            const sh = data.settings_json;
            if (sh.checked) {
                const ok = sh.exists && sh.hooks_count > 0;
                html += `<div class="col-md-6">
                    <span class="badge ${ok ? 'bg-success' : 'bg-warning text-dark'}">
                        <i class="fas ${ok ? 'fa-check' : 'fa-exclamation-triangle'} me-1"></i>
                        Hooks (${sh.hooks_count})
                    </span>
                    <small class="d-block text-muted mt-1">${ok ? sh.hooks_count + ' hook(s) installed' : 'settings.json missing or no hooks'}</small>
                </div>`;
            }

            // Hook scripts
            if (data.hook_scripts && data.hook_scripts.length > 0) {
                html += '<div class="col-12 mt-2"><strong class="text-muted">Hook Scripts:</strong></div>';
                data.hook_scripts.forEach(s => {
                    html += `<div class="col-md-6">
                        <span class="badge ${s.exists ? 'bg-success' : 'bg-danger'} me-1">
                            <i class="fas ${s.exists ? 'fa-check' : 'fa-times'} me-1"></i>${s.name}
                        </span>
                    </div>`;
                });
            }

            html += '</div>';
            body.innerHTML = html;
        })
        .catch(() => {
            body.innerHTML = '<div class="text-danger small">Failed to load startup status.</div>';
        });
}

document.addEventListener('DOMContentLoaded', function() {
    loadTraceMode();
    loadStartupStatus();
});
</script>

<style>
.form-label {
    color: #1e293b;
    margin-bottom: 0.75rem;
}

.form-select,
.form-check-input {
    cursor: pointer;
}

.form-select:focus,
.form-check-input:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
}

.form-check-input:checked {
    background-color: #667eea;
    border-color: #667eea;
}

.form-check-input:disabled {
    cursor: not-allowed;
    opacity: 0.5;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    padding: 0.75rem 1.5rem;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
}

.btn-outline-secondary:hover {
    background-color: #f8f9fa;
    border-color: #dee2e6;
}

.btn-outline-danger:hover {
    background-color: #ef4444;
    border-color: #ef4444;
}

.card {
    transition: transform 0.2s, box-shadow 0.2s;
}

.alert {
    border-radius: 12px;
    border: none;
}

@media (max-width: 768px) {
    .btn-lg {
        padding: 0.5rem 1rem;
        font-size: 1rem;
    }
}

/* Theme Gallery Styles */
.theme-card {
    border: 3px solid transparent;
    border-radius: 12px;
    padding: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    background: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.theme-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.15);
}

.theme-card.active {
    border-color: #667eea;
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
}

.theme-preview {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
    height: 80px;
    border-radius: 8px;
    overflow: hidden;
}

.theme-color {
    flex: 1;
    transition: transform 0.3s ease;
}

.theme-card:hover .theme-color {
    transform: scale(1.05);
}

.theme-info h6 {
    font-weight: 600;
    color: #1e293b;
}

.theme-info small {
    font-size: 0.85rem;
}

#themeStatus {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>
{% endblock %}
