{% extends "base.html" %}

{% block title %}Session Diff - Claude Insight{% endblock %}

{% block extra_css %}
<style>
.diff-table th { background: #f8fafc; font-size: 12px; text-transform: uppercase; letter-spacing: .04em; }
.diff-row-changed td { background: #fefce8 !important; }
.val-a  { color: #6366f1; font-weight: 600; }
.val-b  { color: #10b981; font-weight: 600; }
.changed-indicator { color: #f59e0b; }
.same-indicator    { color: #94a3b8; }
.session-select { min-width: 220px; font-family: monospace; font-size: 12px; }
.trace-panel {
    background: #1e293b;
    color: #e2e8f0;
    font-family: monospace;
    font-size: 11px;
    border-radius: 8px;
    padding: 12px;
    height: 340px;
    overflow: auto;
    white-space: pre-wrap;
    word-break: break-word;
}
.badge-model-haiku  { background: #10b981; }
.badge-model-sonnet { background: #6366f1; }
.badge-model-opus   { background: #f59e0b; }
.summary-box {
    border-radius: 10px;
    padding: 16px;
    height: 100%;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">

    <!-- Page header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="mb-0"><i class="fas fa-code-branch me-2 text-primary"></i>Session Diff</h4>
            <small class="text-muted">Compare two flow-trace sessions side by side</small>
        </div>
    </div>

    <!-- Session selector -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-4">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label fw-bold small">Session A <span class="text-primary">(left)</span></label>
                    <select id="sessionA" class="form-select session-select">
                        <option value="">— select session —</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold small">Session B <span class="text-success">(right)</span></label>
                    <select id="sessionB" class="form-select session-select">
                        <option value="">— select session —</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100" onclick="runDiff()">
                        <i class="fas fa-balance-scale me-2"></i>Compare
                    </button>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-secondary w-100" onclick="clearDiff()">
                        <i class="fas fa-times me-1"></i>Clear
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Status -->
    <div id="statusMsg" class="alert py-2 px-3 small mb-3" style="display:none;"></div>

    <!-- Results -->
    <div id="diffResults" style="display:none;">

        <!-- Summary cards -->
        <div class="row g-3 mb-4">
            <div class="col-md-6">
                <div class="summary-box border border-2 border-primary-subtle bg-primary bg-opacity-5">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong class="text-primary">Session A</strong>
                        <code id="summaryAId" class="small text-muted"></code>
                    </div>
                    <div id="summaryAContent"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="summary-box border border-2 border-success-subtle bg-success bg-opacity-5">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong class="text-success">Session B</strong>
                        <code id="summaryBId" class="small text-muted"></code>
                    </div>
                    <div id="summaryBContent"></div>
                </div>
            </div>
        </div>

        <!-- Diff table -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-0 pt-3 pb-2">
                <strong><i class="fas fa-table me-2"></i>Field-by-Field Diff</strong>
                <span id="changedCount" class="badge bg-warning text-dark ms-2"></span>
            </div>
            <div class="card-body p-0">
                <table class="table table-sm mb-0">
                    <thead>
                        <tr>
                            <th class="ps-3" style="width:160px;">Field</th>
                            <th>Session A <span class="text-primary">(left)</span></th>
                            <th>Session B <span class="text-success">(right)</span></th>
                            <th style="width:80px;">Status</th>
                        </tr>
                    </thead>
                    <tbody id="diffTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Raw trace panels -->
        <div class="row g-3 mb-4">
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-0 pt-3 pb-2">
                        <strong class="text-primary">Raw Trace — Session A</strong>
                    </div>
                    <div class="card-body p-2">
                        <div id="rawTraceA" class="trace-panel">Loading...</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-0 pt-3 pb-2">
                        <strong class="text-success">Raw Trace — Session B</strong>
                    </div>
                    <div class="card-body p-2">
                        <div id="rawTraceB" class="trace-panel">Loading...</div>
                    </div>
                </div>
            </div>
        </div>

    </div><!-- /diffResults -->

</div>
{% endblock %}

{% block extra_js %}
<script>
function loadSessions() {
    fetch('/api/3level-flow/sessions')
        .then(r => r.json())
        .then(data => {
            if (!data.success) return;
            const sessions = data.sessions || [];
            ['sessionA', 'sessionB'].forEach(selId => {
                const sel = document.getElementById(selId);
                sessions.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.session_id || s.id || s;
                    const label = (s.session_id || s.id || s) +
                        (s.task_type ? ' [' + s.task_type + ']' : '') +
                        (s.model ? ' ' + s.model : '');
                    opt.textContent = label;
                    sel.appendChild(opt);
                });
            });
        })
        .catch(() => {});
}

function runDiff() {
    const a = document.getElementById('sessionA').value;
    const b = document.getElementById('sessionB').value;
    if (!a || !b) {
        showStatus('Please select both sessions.', 'warning');
        return;
    }
    if (a === b) {
        showStatus('Select two different sessions to compare.', 'info');
        return;
    }

    showStatus('Comparing...', 'info');

    fetch(`/api/session-diff?a=${encodeURIComponent(a)}&b=${encodeURIComponent(b)}`)
        .then(r => r.json())
        .then(data => {
            if (!data.success) {
                showStatus('Error: ' + data.message, 'danger');
                return;
            }
            hideStatus();
            renderDiff(data);
        })
        .catch(e => showStatus('Request failed: ' + e, 'danger'));
}

function renderDiff(data) {
    document.getElementById('diffResults').style.display = '';

    const sa = data.session_a;
    const sb = data.session_b;

    // Session IDs
    document.getElementById('summaryAId').textContent = sa.session_id;
    document.getElementById('summaryBId').textContent = sb.session_id;

    // Summary cards
    document.getElementById('summaryAContent').innerHTML = renderSummaryCard(sa);
    document.getElementById('summaryBContent').innerHTML = renderSummaryCard(sb);

    // Diff table
    const tbody = document.getElementById('diffTableBody');
    let changedCount = 0;
    tbody.innerHTML = (data.diff || []).map(row => {
        if (row.changed) changedCount++;
        const rowClass = row.changed ? 'diff-row-changed' : '';
        const indicator = row.changed
            ? '<span class="changed-indicator"><i class="fas fa-exclamation-circle"></i> Changed</span>'
            : '<span class="same-indicator"><i class="fas fa-check"></i> Same</span>';
        const valA = row.a !== null && row.a !== undefined ? String(row.a) : '<span class="text-muted">—</span>';
        const valB = row.b !== null && row.b !== undefined ? String(row.b) : '<span class="text-muted">—</span>';
        return `<tr class="${rowClass}">
            <td class="ps-3 fw-semibold small">${row.field}</td>
            <td><span class="val-a">${valA}</span></td>
            <td><span class="val-b">${valB}</span></td>
            <td class="small">${indicator}</td>
        </tr>`;
    }).join('');

    document.getElementById('changedCount').textContent =
        changedCount > 0 ? changedCount + ' changed' : 'No differences';

    // Raw traces
    const rawA = sa.raw ? JSON.stringify(sa.raw, null, 2) : (data.errors.a || 'Not available');
    const rawB = sb.raw ? JSON.stringify(sb.raw, null, 2) : (data.errors.b || 'Not available');
    document.getElementById('rawTraceA').textContent = rawA;
    document.getElementById('rawTraceB').textContent = rawB;
}

function renderSummaryCard(s) {
    if (!s.available) return `<div class="text-danger small">Not available</div>`;
    const modelBadge = s.model
        ? `<span class="badge badge-model-${(s.model || '').toLowerCase()} text-white">${s.model}</span>`
        : '';
    const statusBadge = s.overall_status === 'success'
        ? '<span class="badge bg-success">OK</span>'
        : '<span class="badge bg-danger">' + (s.overall_status || 'unknown') + '</span>';
    return `
    <div class="small">
      <div class="mb-1">${statusBadge} ${modelBadge}</div>
      <div><strong>Task:</strong> ${s.task_type || '—'} (complexity ${s.complexity || '—'})</div>
      <div><strong>Skill:</strong> ${s.skill_agent || '—'}</div>
      <div><strong>Plan mode:</strong> ${s.plan_mode || '—'}</div>
      <div><strong>Context:</strong> ${s.context_pct != null ? s.context_pct + '%' : '—'}</div>
      <div class="text-muted mt-1 text-truncate" style="max-width:360px;" title="${s.message || ''}">${s.message || ''}</div>
    </div>`;
}

function clearDiff() {
    document.getElementById('sessionA').value = '';
    document.getElementById('sessionB').value = '';
    document.getElementById('diffResults').style.display = 'none';
    hideStatus();
}

function showStatus(msg, type) {
    const el = document.getElementById('statusMsg');
    el.className = `alert alert-${type} py-2 px-3 small mb-3`;
    el.textContent = msg;
    el.style.display = '';
}
function hideStatus() {
    document.getElementById('statusMsg').style.display = 'none';
}

document.addEventListener('DOMContentLoaded', loadSessions);
</script>
{% endblock %}
