{% extends "base.html" %}

{% block title %}Logs - Claude Insight{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-0">
                    <i class="fas fa-file-alt me-2"></i>Log Analyzer
                </h2>
                <p class="text-muted mt-2">View and analyze system logs in real-time</p>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ url_for('export_logs') }}" class="btn btn-success">
                    <i class="fas fa-download me-2"></i>Export to CSV
                </a>
                <button class="btn btn-outline-primary" onclick="refreshLogs()">
                    <i class="fas fa-sync-alt me-2"></i>Refresh
                </button>
                <button class="btn btn-primary" onclick="downloadLogs()">
                    <i class="fas fa-download me-2"></i>Download Raw
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Log Stats -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
                <div class="display-5 mb-2">
                    <i class="fas fa-exclamation-circle text-danger"></i>
                    <span id="errorCount" class="ms-2">0</span>
                </div>
                <h6 class="card-title text-muted mb-0">Errors</h6>
                <small class="text-muted">Last 24 hours</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
                <div class="display-5 mb-2">
                    <i class="fas fa-exclamation-triangle text-warning"></i>
                    <span id="warningCount" class="ms-2">0</span>
                </div>
                <h6 class="card-title text-muted mb-0">Warnings</h6>
                <small class="text-muted">Last 24 hours</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
                <div class="display-5 mb-2">
                    <i class="fas fa-info-circle text-info"></i>
                    <span id="infoCount" class="ms-2">0</span>
                </div>
                <h6 class="card-title text-muted mb-0">Info</h6>
                <small class="text-muted">Last 24 hours</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
                <div class="display-5 mb-2">
                    <i class="fas fa-list text-primary"></i>
                    <span id="totalLogs" class="ms-2">0</span>
                </div>
                <h6 class="card-title text-muted mb-0">Total Entries</h6>
                <small class="text-muted">All logs</small>
            </div>
        </div>
    </div>
</div>

<!-- Log File Selector and Filters -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="row align-items-end">
                    <div class="col-md-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-file me-1"></i>Log File
                        </label>
                        <select class="form-select" id="logFileSelect" onchange="loadLogContent()">
                            <option value="">Loading log files...</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-filter me-1"></i>Log Level
                        </label>
                        <select class="form-select" id="logLevelFilter" onchange="applyFilters()">
                            <option value="all">All Levels</option>
                            <option value="ERROR">ERROR</option>
                            <option value="WARNING">WARNING</option>
                            <option value="INFO">INFO</option>
                            <option value="DEBUG">DEBUG</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">
                            <i class="fas fa-search me-1"></i>Search
                        </label>
                        <input type="text" class="form-control" id="logSearchInput"
                               placeholder="Search in logs..."
                               onkeyup="applyFilters()">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                            <i class="fas fa-times me-2"></i>Clear
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Log Level Distribution Chart -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>Log Distribution
                </h5>
            </div>
            <div class="card-body">
                <canvas id="logDistributionChart" height="100"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0">
                    <i class="fas fa-folder me-2"></i>Available Log Files
                </h5>
            </div>
            <div class="card-body" style="max-height: 350px; overflow-y: auto;">
                <div id="logFilesList">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                        <p>Loading log files...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Log Content Viewer -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-terminal me-2"></i>Log Content
                    </h5>
                    <div class="d-flex gap-2">
                        <span class="badge bg-info" id="logEntryCount">0 entries</span>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="autoScrollToggle" checked>
                            <label class="form-check-label" for="autoScrollToggle">
                                Auto-scroll
                            </label>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="autoRefreshToggle">
                            <label class="form-check-label" for="autoRefreshToggle">
                                Auto-refresh
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="logContent" class="log-viewer">
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-file-alt fa-3x mb-3"></i>
                        <p>Select a log file to view its content</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Log Analysis -->
<div class="row">
    <div class="col-md-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Error Trends
                </h5>
            </div>
            <div class="card-body">
                <canvas id="errorTrendChart" height="150"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>Top Issues
                </h5>
            </div>
            <div class="card-body" style="max-height: 350px; overflow-y: auto;">
                <div id="topIssuesList">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                        <p>Analyzing logs...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
let logDistributionChart, errorTrendChart;
let allLogEntries = [];
let autoRefreshInterval;

document.addEventListener('DOMContentLoaded', function() {
    loadLogFiles();
    initializeCharts();
    setupAutoRefresh();
});

function loadLogFiles() {
    fetch('/api/log-files')
        .then(response => response.json())
        .then(data => {
            updateLogFilesList(data);
            updateLogFileSelect(data);
            updateLogStats(data);
        })
        .catch(error => {
            console.error('Error loading log files:', error);
            showError('Failed to load log files');
        });
}

function updateLogFilesList(data) {
    const container = document.getElementById('logFilesList');
    const logFiles = data.log_files || [];

    if (logFiles.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-inbox fa-2x mb-3"></i>
                <p>No log files found</p>
            </div>
        `;
        return;
    }

    container.innerHTML = logFiles.map(file => `
        <div class="log-file-item p-3 mb-2 bg-light rounded cursor-pointer"
             onclick="selectLogFile('${file.name}')">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>${file.name}</strong>
                    <br>
                    <small class="text-muted">
                        <i class="fas fa-file-alt me-1"></i>${formatFileSize(file.size)}
                    </small>
                </div>
                <div class="text-end">
                    <small class="text-muted d-block">${file.modified}</small>
                    <span class="badge bg-${getLogFileColor(file.name)} mt-1">
                        ${file.entries || 0} entries
                    </span>
                </div>
            </div>
        </div>
    `).join('');
}

function updateLogFileSelect(data) {
    const select = document.getElementById('logFileSelect');
    const logFiles = data.log_files || [];

    if (logFiles.length === 0) {
        select.innerHTML = '<option value="">No log files available</option>';
        return;
    }

    select.innerHTML = '<option value="">Select a log file...</option>' +
        logFiles.map(file => `
            <option value="${file.name}">${file.name} (${file.entries || 0} entries)</option>
        `).join('');
}

function updateLogStats(data) {
    const stats = data.stats || {};
    document.getElementById('errorCount').textContent = stats.errors || 0;
    document.getElementById('warningCount').textContent = stats.warnings || 0;
    document.getElementById('infoCount').textContent = stats.info || 0;
    document.getElementById('totalLogs').textContent = stats.total || 0;

    if (logDistributionChart) {
        updateLogDistributionChart(stats);
    }
}

function selectLogFile(fileName) {
    document.getElementById('logFileSelect').value = fileName;
    loadLogContent();
}

function loadLogContent() {
    const fileName = document.getElementById('logFileSelect').value;
    if (!fileName) return;

    const logContent = document.getElementById('logContent');
    logContent.innerHTML = `
        <div class="text-center text-muted py-5">
            <i class="fas fa-spinner fa-spin fa-3x mb-3"></i>
            <p>Loading log content...</p>
        </div>
    `;

    fetch(`/api/log-content/${fileName}`)
        .then(response => response.json())
        .then(data => {
            allLogEntries = data.entries || [];
            renderLogContent(allLogEntries);
            updateLogEntryCount(allLogEntries.length);
            analyzeTopIssues(allLogEntries);
            updateErrorTrendChart(data.trend_data || {});
        })
        .catch(error => {
            console.error('Error loading log content:', error);
            logContent.innerHTML = `
                <div class="alert alert-danger m-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Failed to load log content
                </div>
            `;
        });
}

function renderLogContent(entries) {
    const container = document.getElementById('logContent');

    if (entries.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="fas fa-inbox fa-3x mb-3"></i>
                <p>No log entries found</p>
            </div>
        `;
        return;
    }

    container.innerHTML = entries.map(entry => `
        <div class="log-entry log-${entry.level.toLowerCase()}">
            <div class="log-timestamp">${entry.timestamp}</div>
            <div class="log-level">
                <span class="badge bg-${getLogLevelColor(entry.level)}">
                    ${entry.level}
                </span>
            </div>
            <div class="log-message">${escapeHtml(entry.message)}</div>
        </div>
    `).join('');

    if (document.getElementById('autoScrollToggle').checked) {
        container.scrollTop = container.scrollHeight;
    }
}

function applyFilters() {
    const level = document.getElementById('logLevelFilter').value;
    const searchTerm = document.getElementById('logSearchInput').value.toLowerCase();

    let filtered = allLogEntries;

    // Apply level filter
    if (level !== 'all') {
        filtered = filtered.filter(entry => entry.level === level);
    }

    // Apply search filter
    if (searchTerm) {
        filtered = filtered.filter(entry =>
            entry.message.toLowerCase().includes(searchTerm) ||
            entry.timestamp.toLowerCase().includes(searchTerm)
        );
    }

    renderLogContent(filtered);
    updateLogEntryCount(filtered.length);
}

function clearFilters() {
    document.getElementById('logLevelFilter').value = 'all';
    document.getElementById('logSearchInput').value = '';
    renderLogContent(allLogEntries);
    updateLogEntryCount(allLogEntries.length);
}

function refreshLogs() {
    const btn = event.target.closest('button');
    const icon = btn.querySelector('i');
    icon.classList.add('fa-spin');

    loadLogFiles();

    const selectedFile = document.getElementById('logFileSelect').value;
    if (selectedFile) {
        loadLogContent();
    }

    setTimeout(() => {
        icon.classList.remove('fa-spin');
    }, 1000);
}

function downloadLogs() {
    const fileName = document.getElementById('logFileSelect').value;
    if (!fileName) {
        alert('Please select a log file first');
        return;
    }

    window.location.href = `/api/download-log/${fileName}`;
}

function initializeCharts() {
    // Log Distribution Chart
    const distCtx = document.getElementById('logDistributionChart').getContext('2d');
    logDistributionChart = new Chart(distCtx, {
        type: 'doughnut',
        data: {
            labels: ['ERROR', 'WARNING', 'INFO', 'DEBUG'],
            datasets: [{
                data: [0, 0, 0, 0],
                backgroundColor: [
                    'rgba(220, 53, 69, 0.8)',
                    'rgba(255, 193, 7, 0.8)',
                    'rgba(13, 202, 240, 0.8)',
                    'rgba(108, 117, 125, 0.8)'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Error Trend Chart
    const trendCtx = document.getElementById('errorTrendChart').getContext('2d');
    errorTrendChart = new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Errors',
                data: [],
                borderColor: 'rgb(220, 53, 69)',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Warnings',
                data: [],
                borderColor: 'rgb(255, 193, 7)',
                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function updateLogDistributionChart(stats) {
    if (!logDistributionChart) return;

    logDistributionChart.data.datasets[0].data = [
        stats.errors || 0,
        stats.warnings || 0,
        stats.info || 0,
        stats.debug || 0
    ];
    logDistributionChart.update();
}

function updateErrorTrendChart(trendData) {
    if (!errorTrendChart) return;

    errorTrendChart.data.labels = trendData.labels || [];
    errorTrendChart.data.datasets[0].data = trendData.errors || [];
    errorTrendChart.data.datasets[1].data = trendData.warnings || [];
    errorTrendChart.update();
}

function analyzeTopIssues(entries) {
    const errorEntries = entries.filter(e => e.level === 'ERROR');
    const issueMap = {};

    errorEntries.forEach(entry => {
        const key = entry.message.substring(0, 100);
        if (!issueMap[key]) {
            issueMap[key] = { message: entry.message, count: 0, lastSeen: entry.timestamp };
        }
        issueMap[key].count++;
        issueMap[key].lastSeen = entry.timestamp;
    });

    const topIssues = Object.values(issueMap)
        .sort((a, b) => b.count - a.count)
        .slice(0, 10);

    const container = document.getElementById('topIssuesList');

    if (topIssues.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-check-circle fa-2x mb-3 text-success"></i>
                <p>No errors found</p>
            </div>
        `;
        return;
    }

    container.innerHTML = topIssues.map((issue, index) => `
        <div class="issue-item mb-3 p-3 bg-light rounded">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <span class="badge bg-danger">#${index + 1}</span>
                <span class="badge bg-secondary">${issue.count} occurrences</span>
            </div>
            <p class="mb-2 small">${truncate(issue.message, 150)}</p>
            <small class="text-muted">
                <i class="far fa-clock me-1"></i>Last seen: ${issue.lastSeen}
            </small>
        </div>
    `).join('');
}

function setupAutoRefresh() {
    document.getElementById('autoRefreshToggle').addEventListener('change', function() {
        if (this.checked) {
            autoRefreshInterval = setInterval(() => {
                const selectedFile = document.getElementById('logFileSelect').value;
                if (selectedFile) {
                    loadLogContent();
                }
            }, 5000);
        } else {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        }
    });
}

function updateLogEntryCount(count) {
    document.getElementById('logEntryCount').textContent = `${count} entries`;
}

function getLogLevelColor(level) {
    const colors = {
        'ERROR': 'danger',
        'WARNING': 'warning',
        'INFO': 'info',
        'DEBUG': 'secondary'
    };
    return colors[level] || 'secondary';
}

function getLogFileColor(fileName) {
    if (fileName.includes('error')) return 'danger';
    if (fileName.includes('policy')) return 'primary';
    return 'secondary';
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function truncate(str, length) {
    if (!str) return '';
    return str.length > length ? str.substring(0, length) + '...' : str;
}

function showError(message) {
    console.error(message);
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
});
</script>

<style>
.log-viewer {
    max-height: 600px;
    overflow-y: auto;
    background-color: #1e1e1e;
    color: #d4d4d4;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 13px;
    padding: 1rem;
}

.log-entry {
    display: grid;
    grid-template-columns: 180px 100px 1fr;
    gap: 1rem;
    padding: 0.5rem;
    border-bottom: 1px solid #333;
    transition: background-color 0.2s;
}

.log-entry:hover {
    background-color: #2d2d2d;
}

.log-timestamp {
    color: #858585;
    font-size: 12px;
}

.log-level {
    display: flex;
    align-items: center;
}

.log-message {
    word-break: break-word;
}

.log-error {
    background-color: rgba(220, 53, 69, 0.1);
}

.log-warning {
    background-color: rgba(255, 193, 7, 0.1);
}

.log-info {
    background-color: rgba(13, 202, 240, 0.05);
}

.log-file-item {
    transition: all 0.2s;
    cursor: pointer;
}

.log-file-item:hover {
    background-color: #e9ecef !important;
    transform: translateX(5px);
}

.issue-item {
    transition: all 0.2s;
}

.issue-item:hover {
    background-color: #e9ecef !important;
    transform: translateX(5px);
}

.cursor-pointer {
    cursor: pointer;
}

/* Scrollbar styling for log viewer */
.log-viewer::-webkit-scrollbar {
    width: 10px;
}

.log-viewer::-webkit-scrollbar-track {
    background: #1e1e1e;
}

.log-viewer::-webkit-scrollbar-thumb {
    background: #555;
    border-radius: 5px;
}

.log-viewer::-webkit-scrollbar-thumb:hover {
    background: #777;
}

/* Animation for auto-refresh */
@keyframes refresh-pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.5;
    }
}

#autoRefreshToggle:checked + label {
    animation: refresh-pulse 2s infinite;
}
</style>
{% endblock %}
