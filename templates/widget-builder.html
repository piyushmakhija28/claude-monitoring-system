{% extends "base.html" %}

{% block title %}Widget Builder - Claude Monitoring System{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-0">
                    <i class="fas fa-magic me-2"></i>Advanced Widget Builder
                </h2>
                <p class="text-muted mt-2">Create custom dashboard widgets with visual editor</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary" onclick="loadTemplate()">
                    <i class="fas fa-file-import me-2"></i>Load Template
                </button>
                <button class="btn btn-outline-info" onclick="openVersionControl()" title="Version History">
                    <i class="fas fa-code-branch me-2"></i>Versions
                </button>
                <button class="btn btn-outline-primary" onclick="previewWidget()">
                    <i class="fas fa-eye me-2"></i>Preview
                </button>
                <button class="btn btn-success" onclick="saveWidget()">
                    <i class="fas fa-save me-2"></i>Save Widget
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Builder Interface -->
<div class="row">
    <!-- Left Panel - Component Library -->
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-0">
                <ul class="nav nav-tabs card-header-tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#componentsTab">
                            <i class="fas fa-cubes me-1"></i>Components
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#templatesTab">
                            <i class="fas fa-layer-group me-1"></i>Templates
                        </a>
                    </li>
                </ul>
            </div>
            <div class="card-body p-0">
                <div class="tab-content">
                    <!-- Components Tab -->
                    <div class="tab-pane fade show active" id="componentsTab">
                        <div class="component-library">
                            <div class="component-category">
                                <h6 class="px-3 py-2 mb-0 bg-light"><i class="fas fa-chart-bar me-2"></i>Charts</h6>
                                <div class="component-item" draggable="true" data-type="line-chart">
                                    <i class="fas fa-chart-line text-primary"></i>
                                    <span>Line Chart</span>
                                </div>
                                <div class="component-item" draggable="true" data-type="bar-chart">
                                    <i class="fas fa-chart-bar text-success"></i>
                                    <span>Bar Chart</span>
                                </div>
                                <div class="component-item" draggable="true" data-type="pie-chart">
                                    <i class="fas fa-chart-pie text-warning"></i>
                                    <span>Pie Chart</span>
                                </div>
                                <div class="component-item" draggable="true" data-type="doughnut-chart">
                                    <i class="fas fa-circle-notch text-info"></i>
                                    <span>Doughnut Chart</span>
                                </div>
                            </div>

                            <div class="component-category">
                                <h6 class="px-3 py-2 mb-0 bg-light"><i class="fas fa-tachometer-alt me-2"></i>Metrics</h6>
                                <div class="component-item" draggable="true" data-type="metric-card">
                                    <i class="fas fa-square text-primary"></i>
                                    <span>Metric Card</span>
                                </div>
                                <div class="component-item" draggable="true" data-type="gauge">
                                    <i class="fas fa-tachometer-alt text-danger"></i>
                                    <span>Gauge</span>
                                </div>
                                <div class="component-item" draggable="true" data-type="progress-bar">
                                    <i class="fas fa-tasks text-success"></i>
                                    <span>Progress Bar</span>
                                </div>
                                <div class="component-item" draggable="true" data-type="stat-number">
                                    <i class="fas fa-hashtag text-info"></i>
                                    <span>Stat Number</span>
                                </div>
                            </div>

                            <div class="component-category">
                                <h6 class="px-3 py-2 mb-0 bg-light"><i class="fas fa-list me-2"></i>Lists & Tables</h6>
                                <div class="component-item" draggable="true" data-type="table">
                                    <i class="fas fa-table text-primary"></i>
                                    <span>Data Table</span>
                                </div>
                                <div class="component-item" draggable="true" data-type="list">
                                    <i class="fas fa-list-ul text-success"></i>
                                    <span>List</span>
                                </div>
                                <div class="component-item" draggable="true" data-type="timeline">
                                    <i class="fas fa-stream text-warning"></i>
                                    <span>Timeline</span>
                                </div>
                            </div>

                            <div class="component-category">
                                <h6 class="px-3 py-2 mb-0 bg-light"><i class="fas fa-text-height me-2"></i>Content</h6>
                                <div class="component-item" draggable="true" data-type="heading">
                                    <i class="fas fa-heading text-dark"></i>
                                    <span>Heading</span>
                                </div>
                                <div class="component-item" draggable="true" data-type="text">
                                    <i class="fas fa-align-left text-secondary"></i>
                                    <span>Text Block</span>
                                </div>
                                <div class="component-item" draggable="true" data-type="badge">
                                    <i class="fas fa-tag text-info"></i>
                                    <span>Badge</span>
                                </div>
                                <div class="component-item" draggable="true" data-type="icon">
                                    <i class="fas fa-icons text-warning"></i>
                                    <span>Icon</span>
                                </div>
                            </div>

                            <div class="component-category">
                                <h6 class="px-3 py-2 mb-0 bg-light"><i class="fas fa-cogs me-2"></i>Advanced</h6>
                                <div class="component-item" draggable="true" data-type="html">
                                    <i class="fas fa-code text-danger"></i>
                                    <span>Custom HTML</span>
                                </div>
                                <div class="component-item" draggable="true" data-type="iframe">
                                    <i class="fas fa-window-maximize text-primary"></i>
                                    <span>Iframe</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Templates Tab -->
                    <div class="tab-pane fade" id="templatesTab">
                        <div class="template-library p-3">
                            <div class="template-item" onclick="loadTemplateById('health-monitor')">
                                <div class="template-preview">
                                    <i class="fas fa-heartbeat fa-2x text-danger"></i>
                                </div>
                                <div class="template-info">
                                    <h6>Health Monitor</h6>
                                    <small class="text-muted">Gauge + Stats</small>
                                </div>
                            </div>
                            <div class="template-item" onclick="loadTemplateById('trends-dashboard')">
                                <div class="template-preview">
                                    <i class="fas fa-chart-line fa-2x text-primary"></i>
                                </div>
                                <div class="template-info">
                                    <h6>Trends Dashboard</h6>
                                    <small class="text-muted">Line Chart + Cards</small>
                                </div>
                            </div>
                            <div class="template-item" onclick="loadTemplateById('status-board')">
                                <div class="template-preview">
                                    <i class="fas fa-server fa-2x text-success"></i>
                                </div>
                                <div class="template-info">
                                    <h6>Status Board</h6>
                                    <small class="text-muted">List + Badges</small>
                                </div>
                            </div>
                            <div class="template-item" onclick="loadTemplateById('analytics-panel')">
                                <div class="template-preview">
                                    <i class="fas fa-chart-pie fa-2x text-warning"></i>
                                </div>
                                <div class="template-info">
                                    <h6>Analytics Panel</h6>
                                    <small class="text-muted">Multiple Charts</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Center Panel - Canvas -->
    <div class="col-md-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-drafting-compass me-2"></i>Canvas</h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary" onclick="clearCanvas()" title="Clear">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button class="btn btn-outline-secondary" onclick="undoAction()" title="Undo">
                        <i class="fas fa-undo"></i>
                    </button>
                    <button class="btn btn-outline-secondary" onclick="redoAction()" title="Redo">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-3">
                <div id="widgetCanvas" class="widget-canvas">
                    <div class="canvas-placeholder">
                        <i class="fas fa-mouse-pointer fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Drag components here to start building</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Panel - Properties -->
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-0">
                <ul class="nav nav-tabs card-header-tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#propertiesTab">
                            <i class="fas fa-sliders-h me-1"></i>Properties
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#dataTab">
                            <i class="fas fa-database me-1"></i>Data
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#codeTab">
                            <i class="fas fa-code me-1"></i>Code
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#commentsTab">
                            <i class="fas fa-comments me-1"></i>Comments
                            <span class="badge bg-primary ms-1" id="commentCountBadge">0</span>
                        </a>
                    </li>
                </ul>
            </div>
            <div class="card-body p-0">
                <div class="tab-content">
                    <!-- Properties Tab -->
                    <div class="tab-pane fade show active" id="propertiesTab">
                        <div class="properties-panel p-3">
                            <div id="propertiesContent">
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-mouse-pointer fa-2x mb-3"></i>
                                    <p>Select a component to edit properties</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Data Tab -->
                    <div class="tab-pane fade" id="dataTab">
                        <div class="data-panel p-3">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Data Source</label>
                                <select class="form-select form-select-sm" id="dataSource">
                                    <option value="">Static</option>
                                    <option value="/api/metrics/live">Live Metrics</option>
                                    <option value="/api/daemon-status">Daemon Status</option>
                                    <option value="/api/comparison">Cost Comparison</option>
                                    <option value="/api/notifications">Notifications</option>
                                    <option value="custom">Custom API</option>
                                </select>
                            </div>
                            <div class="mb-3" id="customApiField" style="display: none;">
                                <label class="form-label fw-bold">Custom API URL</label>
                                <input type="text" class="form-control form-control-sm" id="customApiUrl" placeholder="/api/custom-endpoint">
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Refresh Interval (seconds)</label>
                                <input type="number" class="form-control form-control-sm" id="refreshInterval" value="30" min="0">
                                <small class="text-muted">0 = no auto-refresh</small>
                            </div>
                            <button class="btn btn-sm btn-primary w-100" onclick="testDataSource()">
                                <i class="fas fa-sync me-2"></i>Test Connection
                            </button>
                        </div>
                    </div>

                    <!-- Code Tab -->
                    <div class="tab-pane fade" id="codeTab">
                        <div class="code-panel p-3">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Widget HTML</label>
                                <textarea class="form-control font-monospace" id="widgetHtml" rows="10" style="font-size: 12px;"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Widget CSS</label>
                                <textarea class="form-control font-monospace" id="widgetCss" rows="5" style="font-size: 12px;"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Widget JS</label>
                                <textarea class="form-control font-monospace" id="widgetJs" rows="5" style="font-size: 12px;"></textarea>
                            </div>
                            <button class="btn btn-sm btn-success w-100" onclick="applyCode()">
                                <i class="fas fa-check me-2"></i>Apply Code
                            </button>
                        </div>
                    </div>

                    <!-- Comments Tab -->
                    <div class="tab-pane fade" id="commentsTab">
                        <div class="comments-panel" style="max-height: 600px; overflow-y: auto;">
                            <!-- Add Comment Form -->
                            <div class="p-3 border-bottom bg-light sticky-top">
                                <div class="input-group input-group-sm">
                                    <input type="text" class="form-control" id="newCommentInput" placeholder="Add a comment or use @mention...">
                                    <button class="btn btn-primary" onclick="addComment()">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                                <div id="mentionSuggestions" class="mention-suggestions" style="display: none;"></div>
                            </div>

                            <!-- Comments List -->
                            <div id="commentsList" class="p-3">
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-comments fa-2x mb-3"></i>
                                    <p>No comments yet. Be the first to comment!</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-eye me-2"></i>Widget Preview
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="previewContainer" class="p-4 bg-light rounded"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="exportWidget()">
                    <i class="fas fa-download me-2"></i>Export
                </button>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="{{ url_for('static', filename='css/version-control.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/comments.css') }}">
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="{{ url_for('static', filename='js/version-control.js') }}"></script>
<script src="{{ url_for('static', filename='js/comments.js') }}"></script>
<script>
let widgetData = {
    components: [],
    config: {
        dataSource: '',
        refreshInterval: 30
    }
};
let selectedComponent = null;
let history = [];
let historyIndex = -1;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    initializeDragAndDrop();
    initializeCanvas();

    document.getElementById('dataSource').addEventListener('change', function() {
        document.getElementById('customApiField').style.display =
            this.value === 'custom' ? 'block' : 'none';
    });
});

function initializeDragAndDrop() {
    const componentItems = document.querySelectorAll('.component-item');

    componentItems.forEach(item => {
        item.addEventListener('dragstart', function(e) {
            e.dataTransfer.setData('componentType', this.dataset.type);
            this.classList.add('dragging');
        });

        item.addEventListener('dragend', function(e) {
            this.classList.remove('dragging');
        });
    });
}

function initializeCanvas() {
    const canvas = document.getElementById('widgetCanvas');

    canvas.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('drag-over');
    });

    canvas.addEventListener('dragleave', function(e) {
        this.classList.remove('drag-over');
    });

    canvas.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('drag-over');

        const componentType = e.dataTransfer.getData('componentType');
        if (componentType) {
            addComponent(componentType);
        }
    });

    // Make canvas sortable
    new Sortable(canvas, {
        animation: 150,
        ghostClass: 'component-ghost',
        onEnd: function() {
            saveHistory();
        }
    });
}

function addComponent(type) {
    const canvas = document.getElementById('widgetCanvas');
    const placeholder = canvas.querySelector('.canvas-placeholder');
    if (placeholder) placeholder.remove();

    const component = createComponent(type);
    canvas.appendChild(component);

    widgetData.components.push({
        id: component.id,
        type: type,
        properties: getDefaultProperties(type)
    });

    saveHistory();
}

function createComponent(type) {
    const div = document.createElement('div');
    div.className = 'widget-component';
    div.id = 'component-' + Date.now();
    div.dataset.type = type;

    let content = '';
    switch(type) {
        case 'line-chart':
            content = `
                <div class="component-header">
                    <i class="fas fa-chart-line"></i>
                    <span>Line Chart</span>
                    <button class="btn-delete" onclick="deleteComponent('${div.id}')"><i class="fas fa-times"></i></button>
                </div>
                <div class="component-content">
                    <canvas id="${div.id}-chart"></canvas>
                </div>
            `;
            break;
        case 'bar-chart':
            content = `
                <div class="component-header">
                    <i class="fas fa-chart-bar"></i>
                    <span>Bar Chart</span>
                    <button class="btn-delete" onclick="deleteComponent('${div.id}')"><i class="fas fa-times"></i></button>
                </div>
                <div class="component-content">
                    <canvas id="${div.id}-chart"></canvas>
                </div>
            `;
            break;
        case 'metric-card':
            content = `
                <div class="component-header">
                    <i class="fas fa-square"></i>
                    <span>Metric Card</span>
                    <button class="btn-delete" onclick="deleteComponent('${div.id}')"><i class="fas fa-times"></i></button>
                </div>
                <div class="component-content text-center">
                    <h3 class="mb-1">100</h3>
                    <p class="text-muted mb-0">Health Score</p>
                </div>
            `;
            break;
        case 'gauge':
            content = `
                <div class="component-header">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Gauge</span>
                    <button class="btn-delete" onclick="deleteComponent('${div.id}')"><i class="fas fa-times"></i></button>
                </div>
                <div class="component-content">
                    <canvas id="${div.id}-gauge"></canvas>
                </div>
            `;
            break;
        case 'heading':
            content = `
                <div class="component-header">
                    <i class="fas fa-heading"></i>
                    <span>Heading</span>
                    <button class="btn-delete" onclick="deleteComponent('${div.id}')"><i class="fas fa-times"></i></button>
                </div>
                <div class="component-content">
                    <h4>Widget Title</h4>
                </div>
            `;
            break;
        case 'text':
            content = `
                <div class="component-header">
                    <i class="fas fa-align-left"></i>
                    <span>Text Block</span>
                    <button class="btn-delete" onclick="deleteComponent('${div.id}')"><i class="fas fa-times"></i></button>
                </div>
                <div class="component-content">
                    <p>Your text content here</p>
                </div>
            `;
            break;
        default:
            content = `
                <div class="component-header">
                    <i class="fas fa-cube"></i>
                    <span>${type}</span>
                    <button class="btn-delete" onclick="deleteComponent('${div.id}')"><i class="fas fa-times"></i></button>
                </div>
                <div class="component-content">
                    <p class="text-muted">Component: ${type}</p>
                </div>
            `;
    }

    div.innerHTML = content;

    div.addEventListener('click', function(e) {
        if (!e.target.closest('.btn-delete')) {
            selectComponent(this);
        }
    });

    // Initialize chart if needed
    setTimeout(() => {
        if (type === 'line-chart' || type === 'bar-chart') {
            initializeChart(div.id + '-chart', type === 'line-chart' ? 'line' : 'bar');
        } else if (type === 'gauge') {
            initializeGauge(div.id + '-gauge');
        }
    }, 100);

    return div;
}

function getDefaultProperties(type) {
    return {
        width: '100%',
        height: 'auto',
        backgroundColor: '#ffffff',
        borderRadius: '8px',
        padding: '15px',
        title: 'Widget Title',
        color: '#333333'
    };
}

function selectComponent(element) {
    document.querySelectorAll('.widget-component').forEach(c => c.classList.remove('selected'));
    element.classList.add('selected');
    selectedComponent = element;

    loadProperties(element);
}

function loadProperties(component) {
    const type = component.dataset.type;
    const componentData = widgetData.components.find(c => c.id === component.id);
    const props = componentData ? componentData.properties : getDefaultProperties(type);

    const html = `
        <div class="mb-3">
            <label class="form-label fw-bold">Title</label>
            <input type="text" class="form-control form-control-sm" id="propTitle" value="${props.title}" onchange="updateProperty('title', this.value)">
        </div>
        <div class="mb-3">
            <label class="form-label fw-bold">Background Color</label>
            <input type="color" class="form-control form-control-sm form-control-color" id="propBg" value="${props.backgroundColor}" onchange="updateProperty('backgroundColor', this.value)">
        </div>
        <div class="mb-3">
            <label class="form-label fw-bold">Text Color</label>
            <input type="color" class="form-control form-control-sm form-control-color" id="propColor" value="${props.color}" onchange="updateProperty('color', this.value)">
        </div>
        <div class="mb-3">
            <label class="form-label fw-bold">Padding</label>
            <input type="text" class="form-control form-control-sm" id="propPadding" value="${props.padding}" onchange="updateProperty('padding', this.value)">
        </div>
        <div class="mb-3">
            <label class="form-label fw-bold">Border Radius</label>
            <input type="text" class="form-control form-control-sm" id="propRadius" value="${props.borderRadius}" onchange="updateProperty('borderRadius', this.value)">
        </div>
    `;

    document.getElementById('propertiesContent').innerHTML = html;
}

function updateProperty(prop, value) {
    if (!selectedComponent) return;

    const componentData = widgetData.components.find(c => c.id === selectedComponent.id);
    if (componentData) {
        componentData.properties[prop] = value;

        // Apply style
        selectedComponent.style[prop] = value;

        // Update title if applicable
        if (prop === 'title') {
            const titleEl = selectedComponent.querySelector('h4, h3, .component-header span');
            if (titleEl) titleEl.textContent = value;
        }
    }
}

function deleteComponent(id) {
    const component = document.getElementById(id);
    if (component && confirm('Delete this component?')) {
        component.remove();
        widgetData.components = widgetData.components.filter(c => c.id !== id);

        if (selectedComponent && selectedComponent.id === id) {
            selectedComponent = null;
            document.getElementById('propertiesContent').innerHTML = `
                <div class="text-center text-muted py-5">
                    <i class="fas fa-mouse-pointer fa-2x mb-3"></i>
                    <p>Select a component to edit properties</p>
                </div>
            `;
        }

        saveHistory();
    }
}

function clearCanvas() {
    if (confirm('Clear all components?')) {
        document.getElementById('widgetCanvas').innerHTML = `
            <div class="canvas-placeholder">
                <i class="fas fa-mouse-pointer fa-3x text-muted mb-3"></i>
                <p class="text-muted">Drag components here to start building</p>
            </div>
        `;
        widgetData.components = [];
        selectedComponent = null;
        saveHistory();
    }
}

function saveHistory() {
    history = history.slice(0, historyIndex + 1);
    history.push(JSON.stringify(widgetData));
    historyIndex++;
}

function undoAction() {
    if (historyIndex > 0) {
        historyIndex--;
        widgetData = JSON.parse(history[historyIndex]);
        rebuildCanvas();
    }
}

function redoAction() {
    if (historyIndex < history.length - 1) {
        historyIndex++;
        widgetData = JSON.parse(history[historyIndex]);
        rebuildCanvas();
    }
}

function rebuildCanvas() {
    const canvas = document.getElementById('widgetCanvas');
    canvas.innerHTML = '';
    widgetData.components.forEach(comp => {
        const element = createComponent(comp.type);
        element.id = comp.id;
        Object.assign(element.style, comp.properties);
        canvas.appendChild(element);
    });
}

function previewWidget() {
    const canvas = document.getElementById('widgetCanvas');
    const preview = document.getElementById('previewContainer');
    preview.innerHTML = canvas.innerHTML;

    new bootstrap.Modal(document.getElementById('previewModal')).show();
}

function saveWidget() {
    const name = prompt('Enter widget name:');
    if (!name) return;

    const widget = {
        name: name,
        components: widgetData.components,
        config: {
            dataSource: document.getElementById('dataSource').value,
            refreshInterval: document.getElementById('refreshInterval').value
        },
        html: document.getElementById('widgetCanvas').innerHTML,
        css: document.getElementById('widgetCss').value,
        js: document.getElementById('widgetJs').value
    };

    fetch('/api/widgets/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(widget)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Widget saved successfully!');
        } else {
            alert('Error saving widget: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving widget');
    });
}

function exportWidget() {
    const widget = {
        components: widgetData.components,
        html: document.getElementById('widgetCanvas').innerHTML,
        css: document.getElementById('widgetCss').value,
        js: document.getElementById('widgetJs').value
    };

    const blob = new Blob([JSON.stringify(widget, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'widget-' + Date.now() + '.json';
    a.click();
}

function loadTemplateById(templateId) {
    // Load predefined templates
    const templates = {
        'health-monitor': {
            components: [
                { type: 'heading', properties: { title: 'System Health' } },
                { type: 'gauge', properties: {} },
                { type: 'metric-card', properties: { title: 'Health Score' } }
            ]
        },
        'trends-dashboard': {
            components: [
                { type: 'heading', properties: { title: 'Performance Trends' } },
                { type: 'line-chart', properties: {} },
                { type: 'metric-card', properties: { title: 'Avg Response Time' } }
            ]
        }
    };

    const template = templates[templateId];
    if (template) {
        clearCanvas();
        template.components.forEach(comp => {
            addComponent(comp.type);
        });
    }
}

function testDataSource() {
    const dataSource = document.getElementById('dataSource').value;
    if (!dataSource) {
        alert('Please select a data source');
        return;
    }

    fetch(dataSource)
        .then(response => response.json())
        .then(data => {
            alert('Connection successful! Data received.');
            console.log('Data:', data);
        })
        .catch(error => {
            alert('Connection failed: ' + error.message);
        });
}

function applyCode() {
    const html = document.getElementById('widgetHtml').value;
    if (html) {
        document.getElementById('widgetCanvas').innerHTML = html;
    }

    const css = document.getElementById('widgetCss').value;
    if (css) {
        let styleTag = document.getElementById('widget-custom-style');
        if (!styleTag) {
            styleTag = document.createElement('style');
            styleTag.id = 'widget-custom-style';
            document.head.appendChild(styleTag);
        }
        styleTag.textContent = css;
    }
}

function initializeChart(canvasId, type) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;

    new Chart(ctx, {
        type: type,
        data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            datasets: [{
                label: 'Sample Data',
                data: [65, 59, 80, 81, 56, 55, 40],
                borderColor: 'rgb(102, 126, 234)',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } }
        }
    });
}

function initializeGauge(canvasId) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;

    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Value', 'Remaining'],
            datasets: [{
                data: [75, 25],
                backgroundColor: ['rgb(102, 126, 234)', 'rgba(200, 200, 200, 0.3)'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            circumference: 180,
            rotation: -90,
            plugins: {
                legend: { display: false },
                tooltip: { enabled: false }
            }
        }
    });
}
</script>

<!-- Version Control Modal -->
<div class="modal fade" id="versionControlModal" tabindex="-1" aria-labelledby="versionControlModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-gradient-primary text-white">
                <h5 class="modal-title" id="versionControlModalLabel">
                    <i class="fas fa-code-branch me-2"></i>Version Control & History
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div class="row g-0">
                    <!-- Left Panel - Version Timeline -->
                    <div class="col-md-4 border-end">
                        <div class="p-3 bg-light border-bottom">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="fas fa-history me-2"></i>Version Timeline</h6>
                                <button class="btn btn-sm btn-primary" onclick="createNewVersion()">
                                    <i class="fas fa-plus me-1"></i>New Version
                                </button>
                            </div>
                        </div>
                        <div id="versionTimeline" class="version-timeline p-3" style="max-height: 500px; overflow-y: auto;">
                            <!-- Version items will be loaded here -->
                            <div class="text-center text-muted py-5">
                                <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                <p>Loading versions...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Right Panel - Version Details & Diff Viewer -->
                    <div class="col-md-8">
                        <ul class="nav nav-tabs px-3 pt-3" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" data-bs-toggle="tab" href="#versionDetailsTab">
                                    <i class="fas fa-info-circle me-1"></i>Details
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#versionDiffTab">
                                    <i class="fas fa-code-compare me-1"></i>Diff Viewer
                                </a>
                            </li>
                        </ul>

                        <div class="tab-content p-3" style="max-height: 500px; overflow-y: auto;">
                            <!-- Version Details Tab -->
                            <div class="tab-pane fade show active" id="versionDetailsTab">
                                <div id="versionDetails">
                                    <div class="text-center text-muted py-5">
                                        <i class="fas fa-mouse-pointer fa-2x mb-3"></i>
                                        <p>Select a version to view details</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Diff Viewer Tab -->
                            <div class="tab-pane fade" id="versionDiffTab">
                                <div class="mb-3">
                                    <label class="form-label">Compare versions:</label>
                                    <div class="row g-2">
                                        <div class="col-md-5">
                                            <select class="form-select" id="diffFromVersion">
                                                <option value="">Select version...</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2 text-center">
                                            <i class="fas fa-arrow-right mt-2"></i>
                                        </div>
                                        <div class="col-md-5">
                                            <select class="form-select" id="diffToVersion">
                                                <option value="">Select version...</option>
                                            </select>
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-primary mt-2" onclick="compareDiff()">
                                        <i class="fas fa-code-compare me-1"></i>Compare
                                    </button>
                                </div>
                                <div id="diffViewer">
                                    <div class="text-center text-muted py-5">
                                        <i class="fas fa-code-compare fa-2x mb-3"></i>
                                        <p>Select versions to compare</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Create Version Modal -->
<div class="modal fade" id="createVersionModal" tabindex="-1" aria-labelledby="createVersionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createVersionModalLabel">
                    <i class="fas fa-tag me-2"></i>Create New Version
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="versionType" class="form-label">Version Type</label>
                    <select class="form-select" id="versionType">
                        <option value="patch">Patch (Bug fixes, minor changes)</option>
                        <option value="minor">Minor (New features, backward compatible)</option>
                        <option value="major">Major (Breaking changes)</option>
                    </select>
                    <div class="form-text">
                        <strong>Current version:</strong> <span id="currentVersionDisplay">1.0.0</span>
                        â†’ <strong>New version:</strong> <span id="newVersionDisplay">1.0.1</span>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="commitMessage" class="form-label">Commit Message</label>
                    <textarea class="form-control" id="commitMessage" rows="3" placeholder="Describe your changes..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveNewVersion()">
                    <i class="fas fa-save me-1"></i>Create Version
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.component-library {
    max-height: 600px;
    overflow-y: auto;
}

.component-category {
    margin-bottom: 0;
}

.component-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    cursor: move;
    transition: all 0.2s;
    border-bottom: 1px solid #f0f0f0;
}

.component-item:hover {
    background-color: #f8f9fa;
    padding-left: 20px;
}

.component-item.dragging {
    opacity: 0.5;
}

.component-item i {
    font-size: 1.2rem;
}

.widget-canvas {
    min-height: 500px;
    background: #f8f9fa;
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 15px;
}

.widget-canvas.drag-over {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.05);
}

.canvas-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    min-height: 400px;
}

.widget-component {
    background: white;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    margin-bottom: 15px;
    transition: all 0.2s;
    cursor: pointer;
}

.widget-component:hover {
    border-color: #667eea;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
}

.widget-component.selected {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
}

.component-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 15px;
    background: #f8f9fa;
    border-bottom: 1px solid #e0e0e0;
    border-radius: 6px 6px 0 0;
}

.component-header i {
    color: #667eea;
}

.component-header span {
    flex: 1;
    font-weight: 600;
    font-size: 14px;
}

.btn-delete {
    background: none;
    border: none;
    color: #dc3545;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
    transition: all 0.2s;
}

.btn-delete:hover {
    background: #dc3545;
    color: white;
}

.component-content {
    padding: 15px;
}

.component-content canvas {
    max-height: 200px;
}

.component-ghost {
    opacity: 0.4;
}

.template-library {
    display: grid;
    grid-template-columns: 1fr;
    gap: 15px;
}

.template-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
}

.template-item:hover {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.05);
}

.template-preview {
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f8f9fa;
    border-radius: 8px;
}

.template-info h6 {
    margin: 0;
    font-size: 14px;
    font-weight: 600;
}

.properties-panel,
.data-panel,
.code-panel {
    max-height: 600px;
    overflow-y: auto;
}
</style>
{% endblock %}
