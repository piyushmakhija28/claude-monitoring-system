{% extends "base.html" %}

{% block title %}Skill Registry - Claude Insight{% endblock %}

{% block extra_css %}
<style>
.skill-card {
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 14px;
    transition: box-shadow .15s, border-color .15s;
    cursor: default;
}
.skill-card:hover {
    box-shadow: 0 4px 16px rgba(99,102,241,.12);
    border-color: #6366f1;
}
.skill-cat-badge {
    font-size: 11px;
    padding: 3px 9px;
    border-radius: 20px;
}
.usage-bar { height: 4px; border-radius: 2px; background: #e5e7eb; margin-top: 6px; }
.usage-bar-fill { height: 100%; border-radius: 2px; background: #6366f1; transition: width .4s; }
.keyword-tag {
    display: inline-block;
    font-size: 11px;
    background: #f1f5f9;
    color: #475569;
    padding: 2px 7px;
    border-radius: 12px;
    margin: 2px 2px 2px 0;
}
.cat-header {
    font-size: 13px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .05em;
    color: #64748b;
    margin: 20px 0 10px;
}
#searchInput { max-width: 320px; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">

    <!-- Page header -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
        <div>
            <h4 class="mb-0"><i class="fas fa-toolbox me-2 text-primary"></i>Skill Registry</h4>
            <small class="text-muted">All available Claude skills with usage stats from recent sessions</small>
        </div>
        <div class="d-flex gap-2 align-items-center">
            <input type="text" id="searchInput" class="form-control form-control-sm"
                   placeholder="Search skills..." oninput="filterSkills(this.value)">
            <select id="catFilter" class="form-select form-select-sm" style="min-width:140px;"
                    onchange="filterSkills(document.getElementById('searchInput').value)">
                <option value="">All Categories</option>
            </select>
            <button class="btn btn-sm btn-outline-secondary" onclick="loadSkills()">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>

    <!-- Stats row -->
    <div class="row g-3 mb-4">
        <div class="col-sm-4 col-md-3">
            <div class="card border-0 shadow-sm text-center py-3">
                <div class="fs-3 fw-bold text-primary" id="totalSkills">-</div>
                <small class="text-muted">Total Skills</small>
            </div>
        </div>
        <div class="col-sm-4 col-md-3">
            <div class="card border-0 shadow-sm text-center py-3">
                <div class="fs-3 fw-bold text-success" id="totalCategories">-</div>
                <small class="text-muted">Categories</small>
            </div>
        </div>
        <div class="col-sm-4 col-md-3">
            <div class="card border-0 shadow-sm text-center py-3">
                <div class="fs-3 fw-bold text-warning" id="mostUsed">-</div>
                <small class="text-muted">Most Used (50 sessions)</small>
            </div>
        </div>
        <div class="col-sm-12 col-md-3">
            <div class="card border-0 shadow-sm text-center py-3">
                <div class="fs-3 fw-bold text-info" id="indexStatus">-</div>
                <small class="text-muted">INDEX.md</small>
            </div>
        </div>
    </div>

    <!-- Skills grid (grouped by category) -->
    <div id="skillsContainer">
        <div class="text-center py-5 text-muted">
            <i class="fas fa-spinner fa-spin fa-2x mb-3 d-block"></i>
            Loading skills...
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
let _allSkills = [];
let _categories = {};
let _maxUsage = 1;

function loadSkills() {
    document.getElementById('skillsContainer').innerHTML =
        '<div class="text-center py-5 text-muted"><i class="fas fa-spinner fa-spin fa-2x mb-3 d-block"></i>Loading...</div>';

    fetch('/api/skill-registry')
        .then(r => r.json())
        .then(data => {
            if (!data.success) return;
            _allSkills = data.skills || [];
            _categories = data.categories || {};
            _maxUsage = Math.max(1, ...(_allSkills.map(s => s.usage_count)));

            // Stats
            document.getElementById('totalSkills').textContent = data.total;
            document.getElementById('totalCategories').textContent = Object.keys(_categories).length;
            const top = _allSkills[0];
            document.getElementById('mostUsed').textContent = top ? top.id + ' (' + top.usage_count + ')' : 'N/A';
            document.getElementById('indexStatus').textContent = data.index_found ? 'Found' : 'Not found';
            document.getElementById('indexStatus').className = 'fs-3 fw-bold ' + (data.index_found ? 'text-success' : 'text-warning');

            // Populate category filter
            const catSel = document.getElementById('catFilter');
            catSel.innerHTML = '<option value="">All Categories</option>';
            Object.keys(_categories).sort().forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = capitalize(c) + ' (' + _categories[c].length + ')';
                catSel.appendChild(opt);
            });

            renderSkills(_allSkills);
        })
        .catch(e => {
            document.getElementById('skillsContainer').innerHTML =
                '<div class="alert alert-danger">Failed to load skills: ' + e + '</div>';
        });
}

function renderSkills(skills) {
    const container = document.getElementById('skillsContainer');
    if (!skills.length) {
        container.innerHTML = '<div class="text-center text-muted py-4">No skills found.</div>';
        return;
    }

    // Group by category
    const grouped = {};
    skills.forEach(s => {
        const cat = s.category || 'general';
        grouped[cat] = grouped[cat] || [];
        grouped[cat].push(s);
    });

    let html = '';
    Object.keys(grouped).sort().forEach(cat => {
        const catSkills = grouped[cat];
        html += `<div class="cat-header"><i class="fas fa-folder me-2"></i>${capitalize(cat)} (${catSkills.length})</div>`;
        html += '<div class="row g-3 mb-2">';
        catSkills.forEach(s => {
            const pct = Math.round((s.usage_count / _maxUsage) * 100);
            const kwHtml = (s.keywords || []).slice(0, 5)
                .map(k => `<span class="keyword-tag">${k}</span>`).join('');
            html += `
            <div class="col-xl-3 col-lg-4 col-md-6 skill-item" data-id="${s.id}" data-cat="${s.category}" data-name="${s.name.toLowerCase()}" data-kw="${(s.keywords||[]).join(' ').toLowerCase()}">
              <div class="skill-card h-100">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <div>
                    <code class="fs-6 text-primary">${s.id}</code>
                    ${s.version ? `<span class="badge bg-light text-muted ms-1 small">v${s.version}</span>` : ''}
                  </div>
                  <span class="badge skill-cat-badge bg-light text-dark">${capitalize(s.category)}</span>
                </div>
                <div class="fw-semibold small mb-1">${s.name}</div>
                <div class="text-muted small mb-2" style="min-height:2em;">${s.description ? s.description.substring(0, 80) + (s.description.length > 80 ? '...' : '') : ''}</div>
                <div class="mb-2">${kwHtml}</div>
                <div class="d-flex justify-content-between align-items-center small">
                  <span class="text-muted">${s.size || ''}</span>
                  <span class="${s.usage_count > 0 ? 'text-success fw-bold' : 'text-muted'}">${s.usage_count > 0 ? s.usage_count + ' uses' : 'Unused'}</span>
                </div>
                <div class="usage-bar mt-1"><div class="usage-bar-fill" style="width:${pct}%"></div></div>
              </div>
            </div>`;
        });
        html += '</div>';
    });

    container.innerHTML = html;
}

function filterSkills(query) {
    const cat = document.getElementById('catFilter').value;
    const q = (query || '').toLowerCase().trim();

    const filtered = _allSkills.filter(s => {
        const matchCat = !cat || s.category === cat;
        const matchQ = !q
            || s.id.includes(q)
            || s.name.toLowerCase().includes(q)
            || (s.description || '').toLowerCase().includes(q)
            || (s.keywords || []).some(k => k.includes(q));
        return matchCat && matchQ;
    });

    renderSkills(filtered);
}

function capitalize(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
}

document.addEventListener('DOMContentLoaded', loadSkills);
</script>
{% endblock %}
