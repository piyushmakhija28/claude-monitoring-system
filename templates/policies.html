{% extends "base.html" %}

{% block title %}Policies - Claude Insight{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-0">
                    <i class="fas fa-shield-alt me-2"></i>Policy Management
                </h2>
                <p class="text-muted mt-2">Monitor and manage system policies across all phases</p>
            </div>
            <div>
                <button class="btn btn-primary" onclick="refreshPolicies()">
                    <i class="fas fa-sync-alt me-2"></i>Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Policy Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
                <div class="display-5 mb-2" id="totalPolicies">
                    <i class="fas fa-spinner fa-spin text-primary"></i>
                </div>
                <h6 class="card-title text-muted mb-0">Total Policies</h6>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
                <div class="display-5 mb-2" id="activePolicies">
                    <i class="fas fa-spinner fa-spin text-success"></i>
                </div>
                <h6 class="card-title text-muted mb-0">Active Policies</h6>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
                <div class="display-5 mb-2" id="totalHits">
                    <i class="fas fa-spinner fa-spin text-info"></i>
                </div>
                <h6 class="card-title text-muted mb-0">Total Hits</h6>
                <small class="text-muted">All time</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
                <div class="display-5 mb-2" id="currentPhase">
                    <i class="fas fa-spinner fa-spin text-warning"></i>
                </div>
                <h6 class="card-title text-muted mb-0">Current Phase</h6>
            </div>
        </div>
    </div>
</div>

<!-- Phase Progress -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0">
                    <i class="fas fa-layer-group me-2"></i>Implementation Phases
                </h5>
            </div>
            <div class="card-body">
                <div id="phaseProgress">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                        <p>Loading phase information...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Policy Cards by Phase -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list-check me-2"></i>All Policies
                    </h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-primary active" data-filter="all" onclick="filterPolicies('all')">
                            All
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-success" data-filter="active" onclick="filterPolicies('active')">
                            Active
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" data-filter="inactive" onclick="filterPolicies('inactive')">
                            Inactive
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="policiesList">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                        <p>Loading policies...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Policy Execution History -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>Execution History
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <canvas id="executionChart" height="100"></canvas>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover" id="executionTable">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Policy</th>
                                <th>Action</th>
                                <th>Context</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">
                                    <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                    <p>Loading execution history...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Policy Details Modal -->
<div class="modal fade" id="policyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="policyModalTitle">
                    <i class="fas fa-shield-alt me-2"></i>Policy Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="policyModalBody">
                <div class="text-center text-muted py-4">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
let executionChart;
let allPolicies = [];
let currentFilter = 'all';

document.addEventListener('DOMContentLoaded', function() {
    loadPoliciesData();
});

function loadPoliciesData() {
    Promise.all([
        fetch('/api/policies').then(r => r.json()),
        fetch('/api/policy-history').then(r => r.json())
    ]).then(([policiesData, historyData]) => {
        updateSummaryCards(policiesData);
        updatePhaseProgress(policiesData);
        updatePoliciesList(policiesData);
        updateExecutionHistory(historyData);
        updateExecutionChart(historyData);
    }).catch(error => {
        console.error('Error loading policies data:', error);
        showError('Failed to load policies data');
    });
}

function updateSummaryCards(data) {
    // Total Policies
    const total = data.policies ? data.policies.length : 6;
    document.getElementById('totalPolicies').innerHTML = `
        <span class="text-primary">${total}</span>
    `;

    // Active Policies
    const active = data.policies ? data.policies.filter(p => p.status === 'active').length : 0;
    document.getElementById('activePolicies').innerHTML = `
        <span class="text-success">${active}</span>
    `;

    // Total Hits
    const hits = data.total_hits || 0;
    document.getElementById('totalHits').innerHTML = `
        <span class="text-info">${formatNumber(hits)}</span>
    `;

    // Current Phase
    const phase = data.current_phase || 'N/A';
    document.getElementById('currentPhase').innerHTML = `
        <span class="text-warning">${phase}</span>
    `;
}

function updatePhaseProgress(data) {
    const phases = [
        {
            number: 1,
            name: 'Core Infrastructure',
            status: data.current_phase >= 1 ? 'completed' : 'pending',
            policies: ['Session Memory', 'Context Monitoring']
        },
        {
            number: 2,
            name: 'Proactive Systems',
            status: data.current_phase >= 2 ? 'completed' : data.current_phase === 1.5 ? 'in-progress' : 'pending',
            policies: ['Proactive Consultation', 'Skill Detection']
        },
        {
            number: 3,
            name: 'Optimization',
            status: data.current_phase >= 3 ? 'completed' : data.current_phase === 2.5 ? 'in-progress' : 'pending',
            policies: ['Model Selection', 'Git Auto-Commit']
        }
    ];

    const container = document.getElementById('phaseProgress');
    container.innerHTML = phases.map((phase, index) => `
        <div class="phase-item mb-4 ${index < phases.length - 1 ? 'pb-4 border-bottom' : ''}">
            <div class="d-flex align-items-start">
                <div class="flex-shrink-0">
                    <div class="phase-number bg-${getPhaseColor(phase.status)} text-white rounded-circle d-flex align-items-center justify-content-center"
                         style="width: 60px; height: 60px; font-size: 24px; font-weight: bold;">
                        ${phase.status === 'completed' ? '<i class="fas fa-check"></i>' : phase.number}
                    </div>
                </div>
                <div class="flex-grow-1 ms-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="mb-0">Phase ${phase.number}: ${phase.name}</h5>
                        <span class="badge bg-${getPhaseColor(phase.status)}">
                            ${phase.status.replace('-', ' ').toUpperCase()}
                        </span>
                    </div>
                    <div class="mb-2">
                        ${phase.policies.map(policy => `
                            <span class="badge bg-light text-dark me-2 mb-1">
                                <i class="fas fa-shield-alt me-1"></i>${policy}
                            </span>
                        `).join('')}
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-${getPhaseColor(phase.status)}"
                             role="progressbar"
                             style="width: ${getPhaseProgress(phase.status)}%">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function updatePoliciesList(data) {
    allPolicies = data.policies || [];
    renderPoliciesList();
}

function renderPoliciesList() {
    const container = document.getElementById('policiesList');
    const filteredPolicies = filterPoliciesByStatus(allPolicies, currentFilter);

    if (filteredPolicies.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-info-circle fa-2x mb-3"></i>
                <p>No policies found for current filter</p>
            </div>
        `;
        return;
    }

    container.innerHTML = `
        <div class="row">
            ${filteredPolicies.map(policy => `
                <div class="col-md-6 mb-4">
                    <div class="card border-0 bg-light h-100 policy-card" data-policy-id="${policy.id}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h5 class="mb-1">${policy.name}</h5>
                                    <small class="text-muted">
                                        <i class="fas fa-layer-group me-1"></i>Phase ${policy.phase || 'N/A'}
                                    </small>
                                </div>
                                <span class="badge bg-${policy.status === 'active' ? 'success' : 'secondary'} fs-6">
                                    ${policy.status}
                                </span>
                            </div>
                            <p class="card-text text-muted mb-3">${policy.description || 'No description available'}</p>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <div class="text-center p-2 bg-white rounded">
                                        <div class="h4 mb-0 text-primary">${formatNumber(policy.hits || 0)}</div>
                                        <small class="text-muted">Total Hits</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="text-center p-2 bg-white rounded">
                                        <div class="h4 mb-0 text-success">${policy.success_rate || 0}%</div>
                                        <small class="text-muted">Success Rate</small>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    <i class="far fa-clock me-1"></i>
                                    Last triggered: ${policy.last_triggered || 'Never'}
                                </small>
                                <button class="btn btn-sm btn-outline-primary" onclick="viewPolicyDetails('${policy.id}')">
                                    <i class="fas fa-info-circle me-1"></i>Details
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

function updateExecutionHistory(data) {
    const executions = data.executions || [];
    const tbody = document.querySelector('#executionTable tbody');

    if (executions.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted py-4">
                    <i class="fas fa-info-circle fa-2x mb-3"></i>
                    <p>No execution history available</p>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = executions.slice(0, 20).map(exec => `
        <tr>
            <td>
                <small>${exec.timestamp}</small>
            </td>
            <td>
                <span class="badge bg-light text-dark">
                    <i class="fas fa-shield-alt me-1"></i>${exec.policy}
                </span>
            </td>
            <td>${exec.action}</td>
            <td>
                <small class="text-muted">${truncate(exec.context, 50)}</small>
            </td>
            <td>
                <span class="badge bg-${exec.status === 'success' ? 'success' : 'danger'}">
                    ${exec.status}
                </span>
            </td>
        </tr>
    `).join('');
}

function updateExecutionChart(data) {
    const chartData = data.chart_data || {};
    const ctx = document.getElementById('executionChart').getContext('2d');

    executionChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: chartData.labels || [],
            datasets: [{
                label: 'Policy Executions',
                data: chartData.values || [],
                backgroundColor: 'rgba(102, 126, 234, 0.8)',
                borderColor: 'rgb(102, 126, 234)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Executions: ' + context.parsed.y;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

function viewPolicyDetails(policyId) {
    const policy = allPolicies.find(p => p.id === policyId);
    if (!policy) return;

    const modal = new bootstrap.Modal(document.getElementById('policyModal'));
    const modalBody = document.getElementById('policyModalBody');

    modalBody.innerHTML = `
        <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">${policy.name}</h5>
                <span class="badge bg-${policy.status === 'active' ? 'success' : 'secondary'} fs-6">
                    ${policy.status}
                </span>
            </div>
            <p class="text-muted">${policy.description || 'No description available'}</p>
        </div>

        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card bg-light border-0 text-center">
                    <div class="card-body">
                        <div class="h3 text-primary mb-2">${formatNumber(policy.hits || 0)}</div>
                        <small class="text-muted">Total Hits</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-light border-0 text-center">
                    <div class="card-body">
                        <div class="h3 text-success mb-2">${policy.success_rate || 0}%</div>
                        <small class="text-muted">Success Rate</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-light border-0 text-center">
                    <div class="card-body">
                        <div class="h3 text-info mb-2">Phase ${policy.phase || 'N/A'}</div>
                        <small class="text-muted">Implementation Phase</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-4">
            <h6 class="mb-3">Policy Information</h6>
            <table class="table table-borderless">
                <tbody>
                    <tr>
                        <td class="text-muted" style="width: 40%;">File Path:</td>
                        <td><code>${policy.file_path || 'N/A'}</code></td>
                    </tr>
                    <tr>
                        <td class="text-muted">Last Triggered:</td>
                        <td>${policy.last_triggered || 'Never'}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Created:</td>
                        <td>${policy.created || 'Unknown'}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Modified:</td>
                        <td>${policy.modified || 'Unknown'}</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="mb-4">
            <h6 class="mb-3">Recent Activity</h6>
            <div class="list-group">
                ${(policy.recent_activity || []).map(activity => `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${activity.action}</strong>
                                <br>
                                <small class="text-muted">${activity.context}</small>
                            </div>
                            <small class="text-muted">${activity.timestamp}</small>
                        </div>
                    </div>
                `).join('') || '<p class="text-muted text-center py-3">No recent activity</p>'}
            </div>
        </div>
    `;

    modal.show();
}

function filterPolicies(filter) {
    currentFilter = filter;

    // Update button states
    document.querySelectorAll('[data-filter]').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-filter="${filter}"]`).classList.add('active');

    renderPoliciesList();
}

function filterPoliciesByStatus(policies, filter) {
    if (filter === 'all') return policies;
    if (filter === 'active') return policies.filter(p => p.status === 'active');
    if (filter === 'inactive') return policies.filter(p => p.status !== 'active');
    return policies;
}

function refreshPolicies() {
    const btn = event.target.closest('button');
    const icon = btn.querySelector('i');
    icon.classList.add('fa-spin');

    loadPoliciesData();

    setTimeout(() => {
        icon.classList.remove('fa-spin');
    }, 1000);
}

function getPhaseColor(status) {
    const colors = {
        'completed': 'success',
        'in-progress': 'primary',
        'pending': 'secondary'
    };
    return colors[status] || 'secondary';
}

function getPhaseProgress(status) {
    const progress = {
        'completed': 100,
        'in-progress': 50,
        'pending': 0
    };
    return progress[status] || 0;
}

function formatNumber(num) {
    return new Intl.NumberFormat().format(num);
}

function truncate(str, length) {
    if (!str) return '';
    return str.length > length ? str.substring(0, length) + '...' : str;
}

function showError(message) {
    console.error(message);
}
</script>

<style>
.policy-card {
    transition: transform 0.2s, box-shadow 0.2s;
    cursor: pointer;
}

.policy-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}

.phase-number {
    transition: all 0.3s ease;
}

.phase-item:hover .phase-number {
    transform: scale(1.1);
}

.btn-group .btn {
    transition: all 0.2s ease;
}

.modal-body code {
    word-break: break-all;
}
</style>
{% endblock %}
