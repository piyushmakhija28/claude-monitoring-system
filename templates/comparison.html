{% extends "base.html" %}

{% block title %}Cost Comparison - Claude Insight{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
            <div>
                <h2 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Cost Comparison Analysis
                </h2>
                <p class="text-muted mt-2">Compare system performance before and after optimization</p>
            </div>
            <div>
                <!-- Time Range Filter -->
                <div class="btn-group" role="group" aria-label="Time range filter">
                    <a href="?days=1" class="btn btn-sm btn-outline-primary {{ 'active' if selected_days == 1 else '' }}">
                        Today
                    </a>
                    <a href="?days=7" class="btn btn-sm btn-outline-primary {{ 'active' if selected_days == 7 else '' }}">
                        7 Days
                    </a>
                    <a href="?days=30" class="btn btn-sm btn-outline-primary {{ 'active' if selected_days == 30 else '' }}">
                        30 Days
                    </a>
                    <a href="?days=60" class="btn btn-sm btn-outline-primary {{ 'active' if selected_days == 60 else '' }}">
                        60 Days
                    </a>
                    <a href="?days=90" class="btn btn-sm btn-outline-primary {{ 'active' if selected_days == 90 else '' }}">
                        90 Days
                    </a>
                </div>
                <span class="badge bg-info ms-2">
                    <i class="fas fa-calendar-alt me-1"></i>Last {{ selected_days }} Days
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stat-card h-100">
            <div class="card-body text-center position-relative">
                <i class="fas fa-dollar-sign stat-icon text-success"></i>
                <div class="stat-value text-success" id="totalSavings">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <div class="stat-label">Total Savings</div>
                <small class="text-muted mt-2 d-block">per month</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card h-100">
            <div class="card-body text-center position-relative">
                <i class="fas fa-percentage stat-icon text-primary"></i>
                <div class="stat-value text-primary" id="tokenReduction">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <div class="stat-label">Token Reduction</div>
                <small class="text-muted mt-2 d-block">average per request</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card h-100">
            <div class="card-body text-center position-relative">
                <i class="fas fa-rocket stat-icon text-info"></i>
                <div class="stat-value text-info" id="responseTime">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <div class="stat-label">Total Optimizations</div>
                <small class="text-muted mt-2 d-block">applied count</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card h-100">
            <div class="card-body text-center position-relative">
                <i class="fas fa-star stat-icon text-warning"></i>
                <div class="stat-value text-warning" id="efficiencyScore">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <div class="stat-label">Efficiency Score</div>
                <small class="text-muted mt-2 d-block">overall improvement</small>
            </div>
        </div>
    </div>
</div>

<!-- Before vs After Comparison -->
<div class="row mb-4">
    <div class="col-md-6 mb-4">
        <div class="card border h-100">
            <div class="card-body">
                <div class="text-center mb-3">
                    <h6 class="mb-1">
                        <i class="fas fa-history text-danger me-2"></i>
                        Before Optimization
                    </h6>
                    <small class="text-muted">
                        Token usage before implementing optimizations
                    </small>
                </div>
                <canvas id="beforeChart" height="200"></canvas>
                <div class="list-group list-group-flush mt-3" id="beforeMetrics">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                        <p>Loading metrics...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card border h-100">
            <div class="card-body">
                <div class="text-center mb-3">
                    <h6 class="mb-1">
                        <i class="fas fa-rocket text-success me-2"></i>
                        After Optimization
                    </h6>
                    <small class="text-muted">
                        Token usage after implementing optimizations
                    </small>
                </div>
                <canvas id="afterChart" height="200"></canvas>
                <div class="list-group list-group-flush mt-3" id="afterMetrics">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                        <p>Loading metrics...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cost Savings Visualization -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>
                    <i class="fas fa-chart-line"></i>
                    Cost Savings Over Time
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="position: relative; height: 400px; max-height: 400px;">
                    <canvas id="savingsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Token Usage Breakdown -->
<div class="row mb-4">
    <div class="col-md-6 mb-4">
        <div class="card border h-100">
            <div class="card-body">
                <div class="text-center mb-3">
                    <h6 class="mb-1">
                        <i class="fas fa-coins text-warning me-2"></i>
                        Token Usage Breakdown
                    </h6>
                    <small class="text-muted">
                        Comparison of token usage before and after
                    </small>
                </div>
                <canvas id="tokenBreakdownChart" height="250"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card border h-100">
            <div class="card-body">
                <div class="text-center mb-3">
                    <h6 class="mb-1">
                        <i class="fas fa-tasks text-primary me-2"></i>
                        Optimization Impact
                    </h6>
                    <small class="text-muted">
                        Performance improvement by optimization type
                    </small>
                </div>
                <div id="optimizationImpact">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                        <p>Loading impact analysis...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Comparison Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>
                    <i class="fas fa-table"></i>
                    Detailed Metrics Comparison
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="comparisonTable">
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th>Before</th>
                                <th>After</th>
                                <th>Change</th>
                                <th>Impact</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">
                                    <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                    <p>Loading comparison data...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
let beforeChart, afterChart, savingsChart, tokenBreakdownChart;

// Use server-side data (no AJAX needed - page reloads on filter change)
document.addEventListener('DOMContentLoaded', function() {
    // Server provides comparison and impact data
    const serverComparison = {{ comparison | tojson }};
    const serverImpact = {{ impact | tojson }};

    // Combine data for update functions
    const combinedData = {
        ...serverComparison,
        ...serverImpact,
        comparison: serverComparison,
        impact: serverImpact
    };

    // Initialize all charts and cards with server data
    updateSummaryCards(combinedData);
    updateBeforeAfterCharts(combinedData);
    updateSavingsChart(combinedData);
    updateTokenBreakdown(combinedData);
    updateOptimizationImpact(combinedData);
    updateComparisonTable(combinedData);
});

function updateSummaryCards(data) {
    try {
        const savings = data.savings || {};
        const impact = data.impact || {};

        // Total Savings
        const totalSavings = savings.cost || 0;
        const savingsEl = document.getElementById('totalSavings');
        if (savingsEl) {
            savingsEl.innerHTML = `$${totalSavings.toFixed(2)}`;
        }

        // Token Reduction
        const tokenReduction = savings.percent || 0;
        const tokenEl = document.getElementById('tokenReduction');
        if (tokenEl) {
            tokenEl.innerHTML = `${tokenReduction.toFixed(1)}%`;
        }

        // Total Optimizations (use as response time metric)
        const totalOpts = impact.total_optimizations || 0;
        const responseEl = document.getElementById('responseTime');
        if (responseEl) {
            responseEl.innerHTML = `${totalOpts}`;
        }

        // Efficiency Score
        const efficiency = data.comparison.efficiency_score || data.efficiency_score || 0;
        const efficiencyEl = document.getElementById('efficiencyScore');
        if (efficiencyEl) {
            efficiencyEl.innerHTML = `${efficiency.toFixed(0)}/100`;
        }
    } catch (error) {
        console.error('Error updating summary cards:', error);
    }
}

function updateBeforeAfterCharts(data) {
    const beforeData = data.before || {};
    const afterData = data.after || {};

    // Before Chart
    const beforeCtx = document.getElementById('beforeChart').getContext('2d');
    if (beforeChart) {
        beforeChart.destroy();
    }
    beforeChart = new Chart(beforeCtx, {
        type: 'doughnut',
        data: {
            labels: ['Input Tokens', 'Output Tokens', 'Cache Tokens'],
            datasets: [{
                data: [
                    beforeData.input_tokens || 0,
                    beforeData.output_tokens || 0,
                    beforeData.cache_tokens || 0
                ],
                backgroundColor: [
                    'rgba(220, 53, 69, 0.8)',
                    'rgba(255, 193, 7, 0.8)',
                    'rgba(13, 110, 253, 0.8)'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // After Chart
    const afterCtx = document.getElementById('afterChart').getContext('2d');
    if (afterChart) {
        afterChart.destroy();
    }
    afterChart = new Chart(afterCtx, {
        type: 'doughnut',
        data: {
            labels: ['Input Tokens', 'Output Tokens', 'Cache Tokens'],
            datasets: [{
                data: [
                    afterData.input_tokens || 0,
                    afterData.output_tokens || 0,
                    afterData.cache_tokens || 0
                ],
                backgroundColor: [
                    'rgba(25, 135, 84, 0.8)',
                    'rgba(102, 126, 234, 0.8)',
                    'rgba(13, 202, 240, 0.8)'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Update metrics lists
    updateMetricsList('beforeMetrics', beforeData);
    updateMetricsList('afterMetrics', afterData);
}

function updateMetricsList(containerId, data) {
    const container = document.getElementById(containerId);
    container.innerHTML = `
        <div class="list-group-item d-flex justify-content-between align-items-center">
            <span><i class="fas fa-arrow-right me-2 text-primary"></i>Input Tokens</span>
            <strong>${formatNumber(data.input_tokens || 0)}</strong>
        </div>
        <div class="list-group-item d-flex justify-content-between align-items-center">
            <span><i class="fas fa-arrow-left me-2 text-success"></i>Output Tokens</span>
            <strong>${formatNumber(data.output_tokens || 0)}</strong>
        </div>
        <div class="list-group-item d-flex justify-content-between align-items-center">
            <span><i class="fas fa-database me-2 text-info"></i>Cache Tokens</span>
            <strong>${formatNumber(data.cache_tokens || 0)}</strong>
        </div>
        <div class="list-group-item d-flex justify-content-between align-items-center">
            <span><i class="fas fa-dollar-sign me-2 text-warning"></i>Total Cost</span>
            <strong>$${(data.total_cost || 0).toFixed(4)}</strong>
        </div>
        <div class="list-group-item d-flex justify-content-between align-items-center">
            <span><i class="fas fa-clock me-2 text-secondary"></i>Avg Response</span>
            <strong>${(data.avg_response_time || 0).toFixed(2)}s</strong>
        </div>
    `;
}

function updateSavingsChart(data) {
    const savingsHistory = data.savings_history || [];
    const ctx = document.getElementById('savingsChart').getContext('2d');

    if (savingsChart) {
        savingsChart.destroy();
    }
    savingsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: savingsHistory.map(item => item.date),
            datasets: [{
                label: 'Daily Savings ($)',
                data: savingsHistory.map(item => item.savings),
                borderColor: 'rgb(25, 135, 84)',
                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Cumulative Savings ($)',
                data: savingsHistory.map(item => item.cumulative),
                borderColor: 'rgb(102, 126, 234)',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toFixed(2);
                        }
                    }
                }
            }
        }
    });
}

function updateTokenBreakdown(data) {
    const breakdown = data.token_breakdown || {};
    const ctx = document.getElementById('tokenBreakdownChart').getContext('2d');

    if (tokenBreakdownChart) {
        tokenBreakdownChart.destroy();
    }
    tokenBreakdownChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Input', 'Output', 'Cache', 'Total'],
            datasets: [{
                label: 'Before',
                data: [
                    breakdown.before_input || 0,
                    breakdown.before_output || 0,
                    breakdown.before_cache || 0,
                    breakdown.before_total || 0
                ],
                backgroundColor: 'rgba(220, 53, 69, 0.7)'
            }, {
                label: 'After',
                data: [
                    breakdown.after_input || 0,
                    breakdown.after_output || 0,
                    breakdown.after_cache || 0,
                    breakdown.after_total || 0
                ],
                backgroundColor: 'rgba(25, 135, 84, 0.7)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return formatNumber(value);
                        }
                    }
                }
            }
        }
    });
}

function updateOptimizationImpact(data) {
    const impacts = data.optimization_impacts || [];
    const container = document.getElementById('optimizationImpact');

    if (impacts.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-info-circle fa-2x mb-3"></i>
                <p>No optimization data available</p>
            </div>
        `;
        return;
    }

    container.innerHTML = impacts.map(impact => `
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <strong>${impact.name}</strong>
                <span class="badge bg-${getImpactColor(impact.improvement)}">
                    ${impact.improvement > 0 ? '+' : ''}${impact.improvement.toFixed(1)}%
                </span>
            </div>
            <div class="progress" style="height: 8px;">
                <div class="progress-bar bg-${getImpactColor(impact.improvement)}"
                     role="progressbar"
                     style="width: ${Math.min(Math.abs(impact.improvement), 100)}%">
                </div>
            </div>
            <small class="text-muted">${impact.description}</small>
        </div>
    `).join('');
}

function updateComparisonTable(data) {
    const metrics = data.detailed_metrics || [];
    const tbody = document.querySelector('#comparisonTable tbody');

    if (metrics.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted py-4">
                    <i class="fas fa-info-circle fa-2x mb-3"></i>
                    <p>No comparison data available</p>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = metrics.map(metric => {
        const change = metric.after - metric.before;
        const changePercent = metric.before !== 0 ? ((change / metric.before) * 100) : 0;
        const isImprovement = metric.inverse ? change < 0 : change > 0;

        return `
            <tr>
                <td><strong>${metric.name}</strong></td>
                <td>${formatMetricValue(metric.before, metric.unit)}</td>
                <td>${formatMetricValue(metric.after, metric.unit)}</td>
                <td>
                    <span class="badge bg-${isImprovement ? 'success' : 'danger'}">
                        ${change > 0 ? '+' : ''}${changePercent.toFixed(1)}%
                    </span>
                </td>
                <td>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar bg-${isImprovement ? 'success' : 'danger'}"
                             role="progressbar"
                             style="width: ${Math.min(Math.abs(changePercent), 100)}%">
                            ${Math.abs(changePercent).toFixed(1)}%
                        </div>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function formatNumber(num) {
    return new Intl.NumberFormat().format(num);
}

function formatMetricValue(value, unit) {
    if (unit === '$') {
        return '$' + value.toFixed(4);
    } else if (unit === 's') {
        return value.toFixed(2) + 's';
    } else if (unit === '%') {
        return value.toFixed(1) + '%';
    } else {
        return formatNumber(value);
    }
}

function getImpactColor(value) {
    if (value >= 20) return 'success';
    if (value >= 10) return 'info';
    if (value >= 0) return 'warning';
    return 'danger';
}

function showError(message) {
    console.error(message);
    // Could add a toast notification here
}
</script>

<style>
.card {
    transition: transform 0.2s, box-shadow 0.2s;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}

.list-group-item {
    border-left: none;
    border-right: none;
}

.list-group-item:first-child {
    border-top: none;
}

.list-group-item:last-child {
    border-bottom: none;
}

.progress {
    transition: width 0.6s ease;
}
</style>
{% endblock %}
