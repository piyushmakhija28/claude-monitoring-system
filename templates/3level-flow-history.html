{% extends "base.html" %}

{% block title %}3-Level Flow History - Claude Insight{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div>
                <h2 class="mb-0">
                    <i class="fas fa-layer-group me-2 text-primary"></i>3-Level Flow History
                </h2>
                <p class="text-muted mt-1">Complete history of all 3-level architecture executions across sessions</p>
            </div>
            <div class="d-flex gap-2">
                <select class="form-select form-select-sm" id="limitSelect" onchange="loadSessions()" style="width:120px;">
                    <option value="20">Last 20</option>
                    <option value="50" selected>Last 50</option>
                    <option value="100">Last 100</option>
                </select>
                <button class="btn btn-outline-primary btn-sm" onclick="loadSessions()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Stats Row -->
<div class="row mb-4" id="statsRow">
    <div class="col-md-2 col-sm-4 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-history stat-icon text-primary"></i>
                <div class="stat-value text-primary" id="statTotalSessions">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <div class="stat-label">Total Sessions</div>
            </div>
        </div>
    </div>
    <div class="col-md-2 col-sm-4 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-check-circle stat-icon text-success"></i>
                <div class="stat-value text-success" id="statSuccessRate">--</div>
                <div class="stat-label">Success Rate</div>
            </div>
        </div>
    </div>
    <div class="col-md-2 col-sm-4 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-brain stat-icon text-warning"></i>
                <div class="stat-value text-warning" id="statAvgComplexity">--</div>
                <div class="stat-label">Avg Complexity</div>
            </div>
        </div>
    </div>
    <div class="col-md-2 col-sm-4 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-map stat-icon text-info"></i>
                <div class="stat-value text-info" id="statPlanModeRate">--</div>
                <div class="stat-label">Plan Mode Rate</div>
            </div>
        </div>
    </div>
    <div class="col-md-2 col-sm-4 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-percentage stat-icon text-secondary"></i>
                <div class="stat-value text-secondary" id="statAvgContext">--</div>
                <div class="stat-label">Avg Context</div>
            </div>
        </div>
    </div>
    <div class="col-md-2 col-sm-4 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body position-relative">
                <i class="fas fa-robot stat-icon text-danger"></i>
                <div class="stat-value text-danger" id="statTopModel">--</div>
                <div class="stat-label">Top Model</div>
            </div>
        </div>
    </div>
</div>

<!-- Filter Row -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body py-2">
                <div class="d-flex gap-3 align-items-center flex-wrap">
                    <span class="text-muted small fw-bold">Filter:</span>
                    <div class="d-flex gap-2 flex-wrap">
                        <select class="form-select form-select-sm" id="filterModel" style="width:130px;" onchange="filterSessions()">
                            <option value="">All Models</option>
                            <option value="HAIKU">Haiku</option>
                            <option value="SONNET">Sonnet</option>
                            <option value="OPUS">Opus</option>
                        </select>
                        <select class="form-select form-select-sm" id="filterStatus" style="width:130px;" onchange="filterSessions()">
                            <option value="">All Statuses</option>
                            <option value="PASS">Pass</option>
                            <option value="FAIL">Fail</option>
                        </select>
                        <select class="form-select form-select-sm" id="filterExecMode" style="width:140px;" onchange="filterSessions()">
                            <option value="">All Exec Modes</option>
                            <option value="parallel">Parallel</option>
                            <option value="sequential">Sequential</option>
                        </select>
                        <input type="text" class="form-control form-control-sm" id="filterSearch" placeholder="Search prompt..." style="width:200px;" oninput="filterSessions()">
                    </div>
                    <button class="btn btn-sm btn-outline-secondary ms-auto" onclick="clearFilters()">
                        <i class="fas fa-times me-1"></i>Clear
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sessions Table -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list text-primary me-2"></i>Execution Sessions
                    </h5>
                    <span class="badge bg-secondary" id="filteredCountBadge">Loading...</span>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="sessionsTable">
                        <thead class="table-light">
                            <tr>
                                <th style="width:160px;">Session ID</th>
                                <th style="width:130px;">Time</th>
                                <th style="width:70px;">Status</th>
                                <th style="width:80px;">Model</th>
                                <th style="width:80px;">Complexity</th>
                                <th style="width:80px;">Context</th>
                                <th style="width:90px;">Exec Mode</th>
                                <th>Prompt</th>
                                <th style="width:100px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sessionsBody">
                            <tr>
                                <td colspan="9" class="text-center py-4 text-muted">
                                    <i class="fas fa-spinner fa-spin fa-2x mb-3 d-block"></i>
                                    Loading sessions...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Model Distribution Charts -->
<div class="row mb-4">
    <div class="col-md-4 mb-4 mb-md-0">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-robot me-2 text-warning"></i>Model Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="modelDistChart" height="220"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-4 mb-md-0">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-code-branch me-2 text-info"></i>Execution Mode</h5>
            </div>
            <div class="card-body">
                <canvas id="execModeChart" height="220"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-layer-group me-2 text-success"></i>Tech Stack</h5>
            </div>
            <div class="card-body">
                <canvas id="techStackChart" height="220"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Pipeline Modal -->
<div class="modal fade" id="pipelineModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-project-diagram me-2 text-primary"></i>
                    Session Pipeline: <code id="pipelineSessionId"></code>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="pipelineBody">
                <div class="text-center py-4 text-muted">
                    <i class="fas fa-spinner fa-spin fa-2x mb-3 d-block"></i>
                    Loading pipeline...
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
let allSessions = [];
let modelDistChart, execModeChart, techStackChart;

document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    loadSessions();
});

function loadStats() {
    fetch('/api/3level-flow/stats')
        .then(r => r.json())
        .then(data => {
            const s = data.stats || {};
            document.getElementById('statTotalSessions').textContent = s.total_sessions || 0;
            document.getElementById('statSuccessRate').textContent = (s.success_rate || 0) + '%';
            document.getElementById('statAvgComplexity').textContent = s.avg_complexity || '--';
            document.getElementById('statPlanModeRate').textContent = (s.plan_mode_rate || 0) + '%';
            document.getElementById('statAvgContext').textContent = (s.avg_context_usage || 0) + '%';

            // Top model
            const modelDist = s.model_distribution || {};
            const topModel = Object.entries(modelDist).sort((a, b) => b[1] - a[1])[0];
            document.getElementById('statTopModel').textContent = topModel ? topModel[0] : '--';

            // Charts
            buildModelDistChart(modelDist);
            buildExecModeChart(s.execution_mode_distribution || {});
            buildTechStackChart(s.tech_stack_distribution || {});
        })
        .catch(e => console.error('Stats error:', e));
}

function loadSessions() {
    const limit = document.getElementById('limitSelect').value;
    fetch('/api/3level-flow/sessions?limit=' + limit)
        .then(r => r.json())
        .then(data => {
            allSessions = data.sessions || [];
            filterSessions();
        })
        .catch(e => {
            console.error('Sessions error:', e);
            document.getElementById('sessionsBody').innerHTML = `
                <tr><td colspan="9" class="text-center text-danger py-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>Failed to load sessions
                </td></tr>`;
        });
}

function filterSessions() {
    const modelF = document.getElementById('filterModel').value.toUpperCase();
    const statusF = document.getElementById('filterStatus').value.toUpperCase();
    const execF = document.getElementById('filterExecMode').value.toLowerCase();
    const searchF = document.getElementById('filterSearch').value.toLowerCase();

    const filtered = allSessions.filter(s => {
        if (modelF && (s.level_3?.model || '').toUpperCase() !== modelF) return false;
        if (statusF && (s.overall_status || '').toUpperCase() !== statusF) return false;
        if (execF && (s.execution_mode || '').toLowerCase() !== execF) return false;
        if (searchF && !(s.user_prompt || '').toLowerCase().includes(searchF)) return false;
        return true;
    });

    document.getElementById('filteredCountBadge').textContent = filtered.length + ' sessions';
    renderTable(filtered);
}

function clearFilters() {
    document.getElementById('filterModel').value = '';
    document.getElementById('filterStatus').value = '';
    document.getElementById('filterExecMode').value = '';
    document.getElementById('filterSearch').value = '';
    filterSessions();
}

function renderTable(sessions) {
    const tbody = document.getElementById('sessionsBody');
    if (!sessions.length) {
        tbody.innerHTML = `<tr><td colspan="9" class="text-center text-muted py-4">
            <i class="fas fa-inbox fa-2x mb-2 d-block"></i>No sessions match filters</td></tr>`;
        return;
    }

    tbody.innerHTML = sessions.map(s => {
        const status = s.overall_status || 'UNKNOWN';
        const statusClass = status === 'PASS' ? 'success' : (status === 'FAIL' ? 'danger' : 'secondary');
        const model = (s.level_3?.model || '--').toUpperCase();
        const modelClass = model === 'HAIKU' ? 'info' : (model === 'SONNET' ? 'primary' : (model === 'OPUS' ? 'warning' : 'secondary'));
        const complexity = s.level_3?.complexity || '--';
        const context = s.level_1?.context_usage ? s.level_1.context_usage + '%' : '--';
        const execMode = s.execution_mode || '--';
        const execIcon = execMode === 'parallel' ? 'fa-bolt text-info' : 'fa-stream text-secondary';
        const prompt = (s.user_prompt || 'N/A').substring(0, 55) + (s.user_prompt && s.user_prompt.length > 55 ? '...' : '');
        const started = s.started ? new Date(s.started).toLocaleString() : '--';
        const sessionId = s.session_id || '';
        const hasPipeline = s.has_flow_trace ? 'true' : 'false';

        return `<tr>
            <td><code style="font-size:0.75rem;">${sessionId.substring(0, 22)}</code></td>
            <td><small class="text-muted">${started}</small></td>
            <td><span class="badge bg-${statusClass}">${status}</span></td>
            <td><span class="badge bg-${modelClass}">${model}</span></td>
            <td><span class="fw-bold">${complexity}</span></td>
            <td><small>${context}</small></td>
            <td><small><i class="fas ${execIcon} me-1"></i>${execMode}</small></td>
            <td><small title="${s.user_prompt || ''}">${prompt}</small></td>
            <td>
                <button class="btn btn-xs btn-outline-primary" style="font-size:0.7rem; padding:2px 7px;"
                    onclick="viewPipeline('${sessionId}', ${hasPipeline})" title="View pipeline">
                    <i class="fas fa-project-diagram"></i>
                </button>
            </td>
        </tr>`;
    }).join('');
}

function viewPipeline(sessionId, hasPipeline) {
    document.getElementById('pipelineSessionId').textContent = sessionId;
    const modal = new bootstrap.Modal(document.getElementById('pipelineModal'));
    modal.show();

    const body = document.getElementById('pipelineBody');
    body.innerHTML = `<div class="text-center py-4 text-muted">
        <i class="fas fa-spinner fa-spin fa-2x mb-3 d-block"></i>Loading pipeline...</div>`;

    if (!hasPipeline) {
        // Show parsed session data
        const s = allSessions.find(x => x.session_id === sessionId);
        if (s) renderParsedSession(s);
        else body.innerHTML = `<div class="alert alert-warning">No pipeline data found for this session.</div>`;
        return;
    }

    fetch('/api/3level-flow/pipeline/' + sessionId)
        .then(r => r.json())
        .then(data => {
            if (!data.success || !data.available) {
                const s = allSessions.find(x => x.session_id === sessionId);
                if (s) renderParsedSession(s);
                else body.innerHTML = `<div class="alert alert-warning">${data.message || 'No pipeline data'}</div>`;
                return;
            }
            renderPipeline(data.trace);
        })
        .catch(e => {
            body.innerHTML = `<div class="alert alert-danger">Failed to load pipeline: ${e.message}</div>`;
        });
}

function renderParsedSession(s) {
    const body = document.getElementById('pipelineBody');
    const levels = [
        { key: 'level_minus_1', label: 'LEVEL -1', title: 'Auto-Fix Enforcement', color: 'danger', icon: 'fa-shield-alt' },
        { key: 'level_1', label: 'LEVEL 1', title: 'Sync System', color: 'primary', icon: 'fa-sync-alt' },
        { key: 'level_2', label: 'LEVEL 2', title: 'Standards System', color: 'info', icon: 'fa-book' },
        { key: 'level_3', label: 'LEVEL 3', title: 'Execution System', color: 'success', icon: 'fa-cogs' },
    ];

    let html = `<div class="row g-3 mb-4">`;
    levels.forEach(l => {
        const data = s[l.key] || {};
        const st = data.status || 'UNKNOWN';
        const stClass = st === 'PASS' ? 'success' : (st === 'FAIL' ? 'danger' : 'secondary');
        html += `<div class="col-md-3">
            <div class="card border-${l.color} h-100">
                <div class="card-body text-center p-3">
                    <div class="fs-4 mb-1"><i class="fas ${l.icon} text-${l.color}"></i></div>
                    <div class="fw-bold small">${l.label}</div>
                    <div class="text-muted small mb-2">${l.title}</div>
                    <span class="badge bg-${stClass}">${st}</span>
                </div>
            </div>
        </div>`;
    });
    html += `</div>`;

    // Details
    html += `<div class="card"><div class="card-body"><div class="row g-3">
        <div class="col-md-4"><strong>Model:</strong> ${s.level_3?.model || '--'}</div>
        <div class="col-md-4"><strong>Complexity:</strong> ${s.level_3?.complexity || '--'}</div>
        <div class="col-md-4"><strong>Task Type:</strong> ${s.level_3?.task_type || '--'}</div>
        <div class="col-md-4"><strong>Skill/Agent:</strong> ${s.level_3?.skill_agent || '--'}</div>
        <div class="col-md-4"><strong>Exec Mode:</strong> ${s.execution_mode || '--'}</div>
        <div class="col-md-4"><strong>Context:</strong> ${s.level_1?.context_usage || '--'}%</div>
        <div class="col-12"><strong>Prompt:</strong> <span class="text-muted">${s.user_prompt || 'N/A'}</span></div>
    </div></div></div>`;

    body.innerHTML = html;
}

function renderPipeline(trace) {
    const body = document.getElementById('pipelineBody');
    if (!trace) {
        body.innerHTML = `<div class="alert alert-warning">Empty pipeline trace</div>`;
        return;
    }

    let html = `<pre class="bg-light p-3 rounded" style="font-size:0.8rem; max-height:600px; overflow-y:auto;">${
        JSON.stringify(trace, null, 2)
    }</pre>`;
    body.innerHTML = html;
}

function buildModelDistChart(dist) {
    const ctx = document.getElementById('modelDistChart').getContext('2d');
    const labels = Object.keys(dist);
    const values = Object.values(dist);
    const colors = { 'HAIKU': '#06b6d4', 'SONNET': '#6366f1', 'OPUS': '#f59e0b' };

    if (modelDistChart) modelDistChart.destroy();
    modelDistChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{ data: values, backgroundColor: labels.map(l => colors[l.toUpperCase()] || '#94a3b8'), borderWidth: 2 }]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });
}

function buildExecModeChart(dist) {
    const ctx = document.getElementById('execModeChart').getContext('2d');
    const labels = Object.keys(dist);
    const values = Object.values(dist);

    if (execModeChart) execModeChart.destroy();
    execModeChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels.map(l => l.charAt(0).toUpperCase() + l.slice(1)),
            datasets: [{ data: values, backgroundColor: ['#06b6d4', '#64748b'], borderWidth: 2 }]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });
}

function buildTechStackChart(dist) {
    const ctx = document.getElementById('techStackChart').getContext('2d');
    const entries = Object.entries(dist).sort((a, b) => b[1] - a[1]).slice(0, 6);
    const labels = entries.map(e => e[0]);
    const values = entries.map(e => e[1]);

    if (techStackChart) techStackChart.destroy();
    techStackChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{ label: 'Sessions', data: values, backgroundColor: '#6366f1' }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
        }
    });
}
</script>
{% endblock %}
