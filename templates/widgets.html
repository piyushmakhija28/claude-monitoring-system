{% extends "base.html" %}

{% block title %}Widget Marketplace - Claude Insight{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
            <div>
                <h2 class="mb-0">
                    <i class="fas fa-puzzle-piece me-2"></i>Widget Marketplace
                </h2>
                <p class="text-muted mt-2">Browse, install, and customize dashboard widgets</p>
            </div>

            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary" onclick="showInstalledWidgets()">
                    <i class="fas fa-check-circle me-2"></i>My Widgets
                </button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createWidgetModal">
                    <i class="fas fa-plus me-2"></i>Create Custom Widget
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Widget Categories -->
<div class="row mb-4">
    <div class="col-12">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-secondary active" onclick="filterWidgets('all')">
                <i class="fas fa-th me-2"></i>All
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="filterWidgets('metrics')">
                <i class="fas fa-chart-line me-2"></i>Metrics
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="filterWidgets('charts')">
                <i class="fas fa-chart-bar me-2"></i>Charts
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="filterWidgets('alerts')">
                <i class="fas fa-bell me-2"></i>Alerts
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="filterWidgets('tools')">
                <i class="fas fa-tools me-2"></i>Tools
            </button>
        </div>
    </div>
</div>

<!-- Widget Grid -->
<div class="row" id="widgetGrid">
    <!-- Health Score Widget -->
    <div class="col-md-6 col-lg-4 mb-4 widget-item" data-category="metrics">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="widget-icon">
                        <i class="fas fa-heartbeat fa-2x text-danger"></i>
                    </div>
                    <span class="badge bg-success">Featured</span>
                </div>
                <h5 class="card-title">Health Score Meter</h5>
                <p class="card-text text-muted">Real-time health score with visual gauge indicator</p>
                <div class="mb-3">
                    <span class="badge bg-light text-dark me-1">
                        <i class="fas fa-download me-1"></i>1.2k installs
                    </span>
                    <span class="badge bg-light text-dark">
                        <i class="fas fa-star text-warning me-1"></i>4.8
                    </span>
                </div>
                <button class="btn btn-primary btn-sm w-100" id="btn-health-score-meter" onclick="installWidget('health-score-meter')">
                    <i class="fas fa-download me-2"></i>Install Widget
                </button>
            </div>
        </div>
    </div>

    <!-- Error Trends Chart -->
    <div class="col-md-6 col-lg-4 mb-4 widget-item" data-category="charts">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="widget-icon">
                        <i class="fas fa-chart-line fa-2x text-warning"></i>
                    </div>
                    <span class="badge bg-info">Popular</span>
                </div>
                <h5 class="card-title">Error Trends</h5>
                <p class="card-text text-muted">Visualize error patterns over time with line chart</p>
                <div class="mb-3">
                    <span class="badge bg-light text-dark me-1">
                        <i class="fas fa-download me-1"></i>890 installs
                    </span>
                    <span class="badge bg-light text-dark">
                        <i class="fas fa-star text-warning me-1"></i>4.6
                    </span>
                </div>
                <button class="btn btn-primary btn-sm w-100" id="btn-error-trends-chart" onclick="installWidget('error-trends-chart')">
                    <i class="fas fa-download me-2"></i>Install Widget
                </button>
            </div>
        </div>
    </div>

    <!-- Cost Comparison Widget -->
    <div class="col-md-6 col-lg-4 mb-4 widget-item" data-category="metrics">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="widget-icon">
                        <i class="fas fa-dollar-sign fa-2x text-success"></i>
                    </div>
                </div>
                <h5 class="card-title">Cost Tracker</h5>
                <p class="card-text text-muted">Monitor API costs and compare models in real-time</p>
                <div class="mb-3">
                    <span class="badge bg-light text-dark me-1">
                        <i class="fas fa-download me-1"></i>756 installs
                    </span>
                    <span class="badge bg-light text-dark">
                        <i class="fas fa-star text-warning me-1"></i>4.7
                    </span>
                </div>
                <button class="btn btn-primary btn-sm w-100" id="btn-cost-tracker" onclick="installWidget('cost-tracker')">
                    <i class="fas fa-download me-2"></i>Install Widget
                </button>
            </div>
        </div>
    </div>

    <!-- Policy Compliance Widget -->
    <div class="col-md-6 col-lg-4 mb-4 widget-item" data-category="metrics">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="widget-icon">
                        <i class="fas fa-shield-alt fa-2x text-primary"></i>
                    </div>
                    <span class="badge bg-success">Featured</span>
                </div>
                <h5 class="card-title">Policy Monitor</h5>
                <p class="card-text text-muted">Track policy compliance and violations in one view</p>
                <div class="mb-3">
                    <span class="badge bg-light text-dark me-1">
                        <i class="fas fa-download me-1"></i>945 installs
                    </span>
                    <span class="badge bg-light text-dark">
                        <i class="fas fa-star text-warning me-1"></i>4.9
                    </span>
                </div>
                <button class="btn btn-primary btn-sm w-100" id="btn-policy-monitor" onclick="installWidget('policy-monitor')">
                    <i class="fas fa-download me-2"></i>Install Widget
                </button>
            </div>
        </div>
    </div>

    <!-- Alert Feed Widget -->
    <div class="col-md-6 col-lg-4 mb-4 widget-item" data-category="alerts">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="widget-icon">
                        <i class="fas fa-bell fa-2x text-danger"></i>
                    </div>
                </div>
                <h5 class="card-title">Live Alert Feed</h5>
                <p class="card-text text-muted">Real-time alert stream with priority filtering</p>
                <div class="mb-3">
                    <span class="badge bg-light text-dark me-1">
                        <i class="fas fa-download me-1"></i>1.1k installs
                    </span>
                    <span class="badge bg-light text-dark">
                        <i class="fas fa-star text-warning me-1"></i>4.5
                    </span>
                </div>
                <button class="btn btn-primary btn-sm w-100" id="btn-alert-feed" onclick="installWidget('alert-feed')">
                    <i class="fas fa-download me-2"></i>Install Widget
                </button>
            </div>
        </div>
    </div>

    <!-- Context Usage Widget -->
    <div class="col-md-6 col-lg-4 mb-4 widget-item" data-category="tools">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="widget-icon">
                        <i class="fas fa-database fa-2x text-info"></i>
                    </div>
                    <span class="badge bg-info">Popular</span>
                </div>
                <h5 class="card-title">Context Monitor</h5>
                <p class="card-text text-muted">Track context window usage with optimization tips</p>
                <div class="mb-3">
                    <span class="badge bg-light text-dark me-1">
                        <i class="fas fa-download me-1"></i>823 installs
                    </span>
                    <span class="badge bg-light text-dark">
                        <i class="fas fa-star text-warning me-1"></i>4.7
                    </span>
                </div>
                <button class="btn btn-primary btn-sm w-100" id="btn-context-monitor" onclick="installWidget('context-monitor')">
                    <i class="fas fa-download me-2"></i>Install Widget
                </button>
            </div>
        </div>
    </div>

    <!-- Session Timeline Widget -->
    <div class="col-md-6 col-lg-4 mb-4 widget-item" data-category="tools">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="widget-icon">
                        <i class="fas fa-clock fa-2x text-secondary"></i>
                    </div>
                </div>
                <h5 class="card-title">Session Timeline</h5>
                <p class="card-text text-muted">Visual timeline of session activity and events</p>
                <div class="mb-3">
                    <span class="badge bg-light text-dark me-1">
                        <i class="fas fa-download me-1"></i>654 installs
                    </span>
                    <span class="badge bg-light text-dark">
                        <i class="fas fa-star text-warning me-1"></i>4.4
                    </span>
                </div>
                <button class="btn btn-primary btn-sm w-100" id="btn-session-timeline" onclick="installWidget('session-timeline')">
                    <i class="fas fa-download me-2"></i>Install Widget
                </button>
            </div>
        </div>
    </div>

    <!-- Model Usage Pie Chart -->
    <div class="col-md-6 col-lg-4 mb-4 widget-item" data-category="charts">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="widget-icon">
                        <i class="fas fa-chart-pie fa-2x text-purple"></i>
                    </div>
                </div>
                <h5 class="card-title">Model Distribution</h5>
                <p class="card-text text-muted">Pie chart showing model usage breakdown</p>
                <div class="mb-3">
                    <span class="badge bg-light text-dark me-1">
                        <i class="fas fa-download me-1"></i>712 installs
                    </span>
                    <span class="badge bg-light text-dark">
                        <i class="fas fa-star text-warning me-1"></i>4.6
                    </span>
                </div>
                <button class="btn btn-primary btn-sm w-100" id="btn-model-distribution" onclick="installWidget('model-distribution')">
                    <i class="fas fa-download me-2"></i>Install Widget
                </button>
            </div>
        </div>
    </div>

    <!-- Quick Actions Widget -->
    <div class="col-md-6 col-lg-4 mb-4 widget-item" data-category="tools">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="widget-icon">
                        <i class="fas fa-bolt fa-2x text-warning"></i>
                    </div>
                </div>
                <h5 class="card-title">Quick Actions</h5>
                <p class="card-text text-muted">Shortcuts to common monitoring tasks and tools</p>
                <div class="mb-3">
                    <span class="badge bg-light text-dark me-1">
                        <i class="fas fa-download me-1"></i>589 installs
                    </span>
                    <span class="badge bg-light text-dark">
                        <i class="fas fa-star text-warning me-1"></i>4.3
                    </span>
                </div>
                <button class="btn btn-primary btn-sm w-100" id="btn-quick-actions" onclick="installWidget('quick-actions')">
                    <i class="fas fa-download me-2"></i>Install Widget
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Create Custom Widget Modal -->
<div class="modal fade" id="createWidgetModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Create Custom Widget
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createWidgetForm" onsubmit="createWidget(event)">
                    <!-- Widget Name -->
                    <div class="mb-3">
                        <label for="widgetName" class="form-label fw-bold">Widget Name</label>
                        <input type="text" class="form-control" id="widgetName" required
                               placeholder="e.g., Custom Health Monitor">
                    </div>

                    <!-- Widget Description -->
                    <div class="mb-3">
                        <label for="widgetDescription" class="form-label fw-bold">Description</label>
                        <textarea class="form-control" id="widgetDescription" rows="3" required
                                  placeholder="Describe what your widget does..."></textarea>
                    </div>

                    <!-- Widget Category -->
                    <div class="mb-3">
                        <label for="widgetCategory" class="form-label fw-bold">Category</label>
                        <select class="form-select" id="widgetCategory" required>
                            <option value="">Choose a category...</option>
                            <option value="metrics">Metrics</option>
                            <option value="charts">Charts</option>
                            <option value="alerts">Alerts</option>
                            <option value="tools">Tools</option>
                        </select>
                    </div>

                    <!-- Widget Icon -->
                    <div class="mb-3">
                        <label for="widgetIcon" class="form-label fw-bold">Icon (Font Awesome class)</label>
                        <input type="text" class="form-control" id="widgetIcon" required
                               placeholder="e.g., fas fa-chart-bar">
                        <small class="text-muted">
                            Find icons at <a href="https://fontawesome.com/icons" target="_blank">fontawesome.com/icons</a>
                        </small>
                    </div>

                    <!-- Widget Color -->
                    <div class="mb-3">
                        <label for="widgetColor" class="form-label fw-bold">Color</label>
                        <select class="form-select" id="widgetColor" required>
                            <option value="primary">Primary (Blue)</option>
                            <option value="danger">Danger (Red)</option>
                            <option value="warning">Warning (Yellow)</option>
                            <option value="success">Success (Green)</option>
                            <option value="info">Info (Cyan)</option>
                            <option value="secondary">Secondary (Gray)</option>
                        </select>
                    </div>

                    <!-- Data Source -->
                    <div class="mb-3">
                        <label for="widgetDataSource" class="form-label fw-bold">Data Source (API Endpoint)</label>
                        <input type="text" class="form-control" id="widgetDataSource"
                               placeholder="e.g., /api/custom-data">
                        <small class="text-muted">Optional: Leave blank for static widget</small>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Create Widget
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Mark a widget button as installed
function markInstalled(widgetId) {
    const btn = document.getElementById('btn-' + widgetId);
    if (btn) {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-check me-2"></i>Already Installed';
        btn.onclick = null;
    }
}

// Load installed status on page load
document.addEventListener('DOMContentLoaded', function() {
    fetch('/api/widgets/installed')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.widgets) {
                data.widgets.forEach(function(widget) {
                    markInstalled(widget.id);
                });
            }
        })
        .catch(error => console.error('Error loading installed widgets:', error));
});

// Filter widgets by category
function filterWidgets(category) {
    const items = document.querySelectorAll('.widget-item');
    const buttons = document.querySelectorAll('.btn-group button');

    // Update active button
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');

    // Filter widgets
    items.forEach(item => {
        if (category === 'all' || item.dataset.category === category) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

// Install widget
function installWidget(widgetId) {
    fetch('/api/widgets/install', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ widget_id: widgetId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            markInstalled(widgetId);
            alert('Widget installed successfully! Go to Dashboard to see it.');
        } else {
            alert('Failed to install widget: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error installing widget:', error);
        alert('An error occurred while installing the widget');
    });
}

// Create custom widget
function createWidget(event) {
    event.preventDefault();

    const widget = {
        name: document.getElementById('widgetName').value,
        description: document.getElementById('widgetDescription').value,
        category: document.getElementById('widgetCategory').value,
        icon: document.getElementById('widgetIcon').value,
        color: document.getElementById('widgetColor').value,
        data_source: document.getElementById('widgetDataSource').value
    };

    fetch('/api/widgets/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(widget)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Custom widget created successfully!');
            document.getElementById('createWidgetForm').reset();
            bootstrap.Modal.getInstance(document.getElementById('createWidgetModal')).hide();
        } else {
            alert('Failed to create widget: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error creating widget:', error);
        alert('An error occurred while creating the widget');
    });
}

// Show installed widgets
function showInstalledWidgets() {
    fetch('/api/widgets/installed')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let message = 'Installed Widgets:\n\n';
                if (data.widgets.length === 0) {
                    message += 'No widgets installed yet.';
                } else {
                    data.widgets.forEach((widget, index) => {
                        message += `${index + 1}. ${widget.name}\n`;
                    });
                }
                alert(message);
            }
        })
        .catch(error => {
            console.error('Error fetching installed widgets:', error);
        });
}
</script>

<style>
.widget-icon {
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(102, 126, 234, 0.1);
    border-radius: 12px;
}

.widget-item .card {
    transition: all 0.3s ease;
}

.widget-item .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15) !important;
}

.text-purple {
    color: #764ba2;
}
</style>
{% endblock %}
