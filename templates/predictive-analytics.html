{% extends "base.html" %}

{% block title %}Predictive Analytics - Claude Insight{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-0"><i class="fas fa-chart-line me-2"></i>Predictive Analytics & Forecasting</h2>
                <p class="text-muted mt-2">AI-powered predictions and capacity planning</p>
            </div>
            <div>
                <div class="btn-group">
                    <button class="btn btn-outline-primary" onclick="setForecastHorizon(24)">
                        <i class="fas fa-clock me-2"></i>24 Hours
                    </button>
                    <button class="btn btn-outline-primary active" onclick="setForecastHorizon(72)">
                        <i class="fas fa-clock me-2"></i>72 Hours
                    </button>
                    <button class="btn btn-outline-primary" onclick="setForecastHorizon(168)">
                        <i class="fas fa-clock me-2"></i>7 Days
                    </button>
                </div>
                <button class="btn btn-primary ms-2" onclick="refreshForecasts()">
                    <i class="fas fa-sync me-2"></i>Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Forecast Summary Cards -->
<div class="row mb-4" id="summaryRow">
    <!-- Summary cards will be loaded here -->
</div>

<!-- Predictive Insights -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i>Predictive Insights & Recommendations
                </h5>
            </div>
            <div class="card-body" id="insightsContainer">
                <p class="text-muted">Loading insights...</p>
            </div>
        </div>
    </div>
</div>

<!-- Forecast Charts -->
<div class="row mb-4">
    <div class="col-md-6 mb-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0">
                    <i class="fas fa-heartbeat me-2"></i>Health Score Forecast
                </h5>
            </div>
            <div class="card-body">
                <canvas id="healthForecastChart"></canvas>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        <span id="healthConfidence">Confidence: --</span> |
                        <span id="healthTrend">Trend: --</span>
                    </small>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0">
                    <i class="fas fa-brain me-2"></i>Context Usage Forecast
                </h5>
            </div>
            <div class="card-body">
                <canvas id="contextForecastChart"></canvas>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        <span id="contextConfidence">Confidence: --</span> |
                        <span id="contextTrend">Trend: --</span>
                    </small>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>Error Count Forecast
                </h5>
            </div>
            <div class="card-body">
                <canvas id="errorForecastChart"></canvas>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        <span id="errorConfidence">Confidence: --</span> |
                        <span id="errorTrend">Trend: --</span>
                    </small>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0">
                    <i class="fas fa-dollar-sign me-2"></i>Cost Forecast
                </h5>
            </div>
            <div class="card-body">
                <canvas id="costForecastChart"></canvas>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        <span id="costConfidence">Confidence: --</span> |
                        <span id="costTrend">Trend: --</span>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Capacity Planning -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0">
                    <i class="fas fa-server me-2"></i>Capacity Planning & Breach Predictions
                </h5>
            </div>
            <div class="card-body">
                <div id="capacityContainer">
                    <p class="text-muted">Loading capacity predictions...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Forecasting Methods -->
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0">
                    <i class="fas fa-cogs me-2"></i>Forecasting Methods
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="p-3 bg-light rounded">
                            <h6><i class="fas fa-chart-line text-primary me-2"></i>Linear Regression</h6>
                            <small class="text-muted">Trend-based prediction using least squares</small>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="p-3 bg-light rounded">
                            <h6><i class="fas fa-wave-square text-success me-2"></i>Exponential Smoothing</h6>
                            <small class="text-muted">Weighted historical data prediction</small>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="p-3 bg-light rounded">
                            <h6><i class="fas fa-chart-area text-info me-2"></i>Moving Average</h6>
                            <small class="text-muted">Sliding window trend analysis</small>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="p-3 bg-light rounded">
                            <h6><i class="fas fa-calendar-alt text-warning me-2"></i>Seasonal Patterns</h6>
                            <small class="text-muted">Hourly/daily pattern detection</small>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="p-3 bg-light rounded">
                            <h6><i class="fas fa-layer-group text-danger me-2"></i>Ensemble Method</h6>
                            <small class="text-muted">Combines all methods (weighted average)</small>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="p-3 bg-light rounded">
                            <h6><i class="fas fa-percentage text-secondary me-2"></i>Confidence Intervals</h6>
                            <small class="text-muted">Prediction uncertainty ranges</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentHorizon = 72;
let forecastCharts = {};

document.addEventListener('DOMContentLoaded', function() {
    loadSummary();
    loadInsights();
    loadForecasts();
    loadCapacityPredictions();

    // Auto-refresh every 5 minutes
    setInterval(() => {
        loadSummary();
        loadInsights();
        loadForecasts();
        loadCapacityPredictions();
    }, 300000);
});

function setForecastHorizon(hours) {
    currentHorizon = hours;

    // Update active button
    document.querySelectorAll('.btn-group button').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');

    loadForecasts();
}

function refreshForecasts() {
    loadSummary();
    loadInsights();
    loadForecasts();
    loadCapacityPredictions();
}

function loadSummary() {
    fetch('/api/forecast/summary')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const summary = data.summary;
                const metrics = summary.metrics;

                let html = '';
                const metricIcons = {
                    'health_score': { icon: 'heartbeat', color: 'success' },
                    'context_usage': { icon: 'brain', color: 'warning' },
                    'error_count': { icon: 'exclamation-triangle', color: 'danger' },
                    'cost': { icon: 'dollar-sign', color: 'info' },
                    'response_time': { icon: 'clock', color: 'primary' }
                };

                Object.keys(metrics).forEach(key => {
                    const metric = metrics[key];
                    const config = metricIcons[key] || { icon: 'chart-line', color: 'secondary' };
                    const trendIcon = metric.trend === 'increasing' ? 'arrow-up' :
                                    metric.trend === 'decreasing' ? 'arrow-down' : 'arrows-alt-h';
                    const trendColor = metric.trend === 'increasing' ? 'danger' :
                                      metric.trend === 'decreasing' ? 'success' : 'secondary';

                    html += `
                        <div class="col-md-4 col-lg-2 mb-3">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-${config.icon} fa-2x text-${config.color} mb-2"></i>
                                    <h6 class="text-muted small mb-1">${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</h6>
                                    <h4 class="mb-1">${metric.current.toFixed(1)}</h4>
                                    <div class="d-flex justify-content-center align-items-center">
                                        <i class="fas fa-${trendIcon} text-${trendColor} me-1"></i>
                                        <small class="text-${trendColor}">${metric.predicted_24h.toFixed(1)}</small>
                                    </div>
                                    <small class="text-muted">${(metric.confidence * 100).toFixed(0)}% confident</small>
                                </div>
                            </div>
                        </div>
                    `;
                });

                document.getElementById('summaryRow').innerHTML = html;
            }
        })
        .catch(error => console.error('Error loading summary:', error));
}

function loadInsights() {
    fetch('/api/forecast/insights')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const insights = data.insights;

                if (insights.insights.length === 0) {
                    document.getElementById('insightsContainer').innerHTML = `
                        <div class="alert alert-success mb-0">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>All Clear!</strong> No critical predictions. System metrics look healthy for the forecasted period.
                        </div>
                    `;
                    return;
                }

                const html = insights.insights.map(insight => {
                    const alertClass = insight.priority === 'critical' ? 'danger' :
                                     insight.priority === 'high' ? 'warning' : 'info';
                    const icon = insight.type === 'capacity_warning' ? 'exclamation-triangle' : 'chart-line';

                    return `
                        <div class="alert alert-${alertClass} mb-2">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-${icon} fa-lg me-3 mt-1"></i>
                                <div class="flex-grow-1">
                                    <strong>${insight.message}</strong>
                                    <p class="mb-0 mt-1"><small>${insight.recommendation}</small></p>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                document.getElementById('insightsContainer').innerHTML = html;
            }
        })
        .catch(error => console.error('Error loading insights:', error));
}

function loadForecasts() {
    const metrics = [
        { name: 'health_score', chart: 'healthForecastChart', color: '75, 192, 192' },
        { name: 'context_usage', chart: 'contextForecastChart', color: '255, 159, 64' },
        { name: 'error_count', chart: 'errorForecastChart', color: '255, 99, 132' },
        { name: 'cost', chart: 'costForecastChart', color: '54, 162, 235' }
    ];

    metrics.forEach(metric => {
        fetch(`/api/forecast/metric/${metric.name}?periods=${currentHorizon}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    createForecastChart(data, metric.chart, metric.color, metric.name);
                }
            })
            .catch(error => console.error(`Error loading ${metric.name} forecast:`, error));
    });
}

function createForecastChart(data, chartId, color, metricName) {
    const ctx = document.getElementById(chartId);

    if (!ctx) return;

    // Destroy existing chart
    if (forecastCharts[chartId]) {
        forecastCharts[chartId].destroy();
    }

    const historical = data.historical.values;
    const forecasts = data.forecasts;
    const confidence = data.confidence_intervals;

    // Combine historical and forecast timestamps
    const allTimestamps = [
        ...data.historical.timestamps.map(ts => new Date(ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })),
        ...data.timestamps.map(ts => new Date(ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }))
    ];

    // Combine values (historical + forecasts)
    const historicalData = [...historical, ...Array(forecasts.length).fill(null)];
    const forecastData = [...Array(historical.length).fill(null), historical[historical.length - 1], ...forecasts];
    const upperBound = [...Array(historical.length).fill(null), historical[historical.length - 1], ...confidence.map(c => c.upper)];
    const lowerBound = [...Array(historical.length).fill(null), historical[historical.length - 1], ...confidence.map(c => c.lower)];

    forecastCharts[chartId] = new Chart(ctx, {
        type: 'line',
        data: {
            labels: allTimestamps,
            datasets: [
                {
                    label: 'Historical',
                    data: historicalData,
                    borderColor: `rgb(${color})`,
                    backgroundColor: `rgba(${color}, 0.1)`,
                    borderWidth: 2,
                    pointRadius: 2,
                    tension: 0.4
                },
                {
                    label: 'Forecast',
                    data: forecastData,
                    borderColor: `rgb(${color})`,
                    backgroundColor: `rgba(${color}, 0.1)`,
                    borderWidth: 2,
                    borderDash: [5, 5],
                    pointRadius: 2,
                    tension: 0.4
                },
                {
                    label: 'Upper Bound',
                    data: upperBound,
                    borderColor: `rgba(${color}, 0.3)`,
                    backgroundColor: 'transparent',
                    borderWidth: 1,
                    borderDash: [2, 2],
                    pointRadius: 0,
                    fill: false
                },
                {
                    label: 'Lower Bound',
                    data: lowerBound,
                    borderColor: `rgba(${color}, 0.3)`,
                    backgroundColor: 'transparent',
                    borderWidth: 1,
                    borderDash: [2, 2],
                    pointRadius: 0,
                    fill: '-1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    enabled: true
                }
            },
            scales: {
                y: {
                    beginAtZero: false
                }
            }
        }
    });

    // Update confidence and trend info
    const confidence_pct = (data.details.confidence * 100).toFixed(0);
    const trend = forecasts[forecasts.length - 1] > forecasts[0] ? 'Increasing' :
                  forecasts[forecasts.length - 1] < forecasts[0] ? 'Decreasing' : 'Stable';

    const prefix = metricName.split('_')[0];
    document.getElementById(`${prefix}Confidence`).textContent = `Confidence: ${confidence_pct}%`;
    document.getElementById(`${prefix}Trend`).textContent = `Trend: ${trend}`;
}

function loadCapacityPredictions() {
    fetch('/api/forecast/capacity-predictions')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const predictions = data.predictions;

                if (predictions.length === 0) {
                    document.getElementById('capacityContainer').innerHTML = `
                        <div class="alert alert-success mb-0">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>No Capacity Issues Predicted</strong> - All metrics are expected to stay within healthy ranges.
                        </div>
                    `;
                    return;
                }

                const html = predictions.map(pred => {
                    const urgencyClass = pred.urgency === 'critical' ? 'danger' :
                                       pred.urgency === 'high' ? 'warning' : 'info';
                    const urgencyIcon = pred.urgency === 'critical' ? 'exclamation-circle' :
                                       pred.urgency === 'high' ? 'exclamation-triangle' : 'info-circle';

                    return `
                        <div class="alert alert-${urgencyClass} mb-2">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-${urgencyIcon} fa-2x me-3"></i>
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">${pred.metric.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())} Breach Predicted</h6>
                                    <p class="mb-1">
                                        <strong>Threshold:</strong> ${pred.threshold} |
                                        <strong>Predicted Value:</strong> ${pred.breach_value.toFixed(1)} |
                                        <strong>Time:</strong> ${pred.hours_until_breach} hours
                                    </p>
                                    <p class="mb-0"><small><i class="fas fa-lightbulb me-1"></i>${pred.recommendation}</small></p>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                document.getElementById('capacityContainer').innerHTML = html;
            }
        })
        .catch(error => console.error('Error loading capacity predictions:', error));
}
</script>
{% endblock %}
