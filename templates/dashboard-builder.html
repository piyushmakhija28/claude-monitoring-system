{% extends "base.html" %}

{% block title %}Dashboard Builder - Claude Insight{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@8.4.0/dist/gridstack.min.css" />
<style>
    .grid-stack {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 10px;
        min-height: 600px;
    }

    .grid-stack-item-content {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        border: 2px solid #e9ecef;
        display: flex;
        flex-direction: column;
    }

    .widget-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 10px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: move;
    }

    .widget-body {
        padding: 15px;
        flex-grow: 1;
        overflow: auto;
    }

    .widget-library {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }

    .widget-item {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 8px;
        cursor: grab;
        margin-bottom: 10px;
        transition: transform 0.2s;
        text-align: center;
    }

    .widget-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .widget-item:active {
        cursor: grabbing;
    }

    .dashboard-card {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition: all 0.3s;
        border-left: 4px solid #667eea;
    }

    .dashboard-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .dashboard-card.active {
        border-left-color: #28a745;
        background: #f0f8f4;
    }

    .toolbar {
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }

    .metric-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
    }

    .chart-container {
        position: relative;
        height: 200px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">
                <i class="fas fa-th-large text-primary"></i> Dashboard Builder
            </h1>
            <p class="text-muted mb-0">Create custom dashboards with drag-and-drop widgets</p>
        </div>
        <div>
            <button class="btn btn-outline-secondary me-2" onclick="toggleWidgetLibrary()">
                <i class="fas fa-layer-group"></i> Widget Library
            </button>
            <button class="btn btn-outline-primary me-2" onclick="saveDashboard()">
                <i class="fas fa-save"></i> Save
            </button>
            <button class="btn btn-primary" onclick="showDashboardManager()">
                <i class="fas fa-folder"></i> My Dashboards
            </button>
        </div>
    </div>

    <!-- Alert Container -->
    <div id="alertContainer"></div>

    <!-- Toolbar -->
    <div class="toolbar">
        <div class="row align-items-center">
            <div class="col-md-4">
                <label class="form-label mb-0"><strong>Dashboard Name:</strong></label>
                <input type="text" class="form-control" id="dashboardName" placeholder="My Custom Dashboard" value="My Dashboard">
            </div>
            <div class="col-md-2">
                <label class="form-label mb-0"><strong>Grid Columns:</strong></label>
                <select class="form-select" id="gridColumns" onchange="changeGridColumns()">
                    <option value="12" selected>12 Columns</option>
                    <option value="6">6 Columns</option>
                    <option value="4">4 Columns</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label mb-0"><strong>Spacing:</strong></label>
                <select class="form-select" id="gridSpacing" onchange="changeGridSpacing()">
                    <option value="10" selected>Normal</option>
                    <option value="5">Tight</option>
                    <option value="15">Loose</option>
                    <option value="0">No Gap</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label mb-0"><strong>Actions:</strong></label>
                <div class="btn-group w-100" role="group">
                    <button class="btn btn-outline-danger" onclick="clearGrid()">
                        <i class="fas fa-trash"></i> Clear All
                    </button>
                    <button class="btn btn-outline-warning" onclick="exportDashboard()">
                        <i class="fas fa-download"></i> Export
                    </button>
                    <button class="btn btn-outline-info" onclick="importDashboard()">
                        <i class="fas fa-upload"></i> Import
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Widget Library Sidebar -->
        <div class="col-md-3" id="widgetLibrarySidebar">
            <div class="widget-library">
                <h5 class="mb-3">
                    <i class="fas fa-puzzle-piece"></i> Available Widgets
                </h5>

                <div class="accordion" id="widgetAccordion">
                    <!-- Metrics Widgets -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#metricsWidgets">
                                <i class="fas fa-chart-line me-2"></i> Metrics
                            </button>
                        </h2>
                        <div id="metricsWidgets" class="accordion-collapse collapse show" data-bs-parent="#widgetAccordion">
                            <div class="accordion-body">
                                <div class="widget-item" data-widget-type="metric-card" data-widget-name="Context Usage">
                                    <i class="fas fa-memory"></i><br>Context Usage
                                </div>
                                <div class="widget-item" data-widget-type="metric-card" data-widget-name="Hooks Active">
                                    <i class="fas fa-plug"></i><br>Hooks Active
                                </div>
                                <div class="widget-item" data-widget-type="metric-card" data-widget-name="Policy Hits">
                                    <i class="fas fa-clipboard-check"></i><br>Policy Hits
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Chart Widgets -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#chartWidgets">
                                <i class="fas fa-chart-bar me-2"></i> Charts
                            </button>
                        </h2>
                        <div id="chartWidgets" class="accordion-collapse collapse" data-bs-parent="#widgetAccordion">
                            <div class="accordion-body">
                                <div class="widget-item" data-widget-type="line-chart" data-widget-name="Context Trend">
                                    <i class="fas fa-chart-line"></i><br>Line Chart
                                </div>
                                <div class="widget-item" data-widget-type="bar-chart" data-widget-name="Policy Distribution">
                                    <i class="fas fa-chart-bar"></i><br>Bar Chart
                                </div>
                                <div class="widget-item" data-widget-type="pie-chart" data-widget-name="Policy Status">
                                    <i class="fas fa-chart-pie"></i><br>Pie Chart
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Activity Widgets -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#activityWidgets">
                                <i class="fas fa-history me-2"></i> Activity
                            </button>
                        </h2>
                        <div id="activityWidgets" class="accordion-collapse collapse" data-bs-parent="#widgetAccordion">
                            <div class="accordion-body">
                                <div class="widget-item" data-widget-type="activity-feed" data-widget-name="Recent Activity">
                                    <i class="fas fa-stream"></i><br>Activity Feed
                                </div>
                                <div class="widget-item" data-widget-type="error-log" data-widget-name="Error Log">
                                    <i class="fas fa-exclamation-triangle"></i><br>Error Log
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Alert Widgets -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#alertWidgets">
                                <i class="fas fa-bell me-2"></i> Alerts
                            </button>
                        </h2>
                        <div id="alertWidgets" class="accordion-collapse collapse" data-bs-parent="#widgetAccordion">
                            <div class="accordion-body">
                                <div class="widget-item" data-widget-type="alert-list" data-widget-name="Active Alerts">
                                    <i class="fas fa-bell"></i><br>Alert List
                                </div>
                                <div class="widget-item" data-widget-type="alert-chart" data-widget-name="Alert Timeline">
                                    <i class="fas fa-chart-area"></i><br>Alert Timeline
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="col-md-9" id="dashboardGridContainer">
            <div class="grid-stack" id="dashboardGrid">
                <!-- Widgets will be added here -->
            </div>
        </div>
    </div>
</div>

<!-- Dashboard Manager Modal -->
<div class="modal fade" id="dashboardManagerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-folder"></i> Dashboard Manager
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between mb-3">
                    <h6>Saved Dashboards</h6>
                    <button class="btn btn-sm btn-primary" onclick="createNewDashboard()">
                        <i class="fas fa-plus"></i> New Dashboard
                    </button>
                </div>
                <div id="dashboardList">
                    <!-- Dashboard list will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Import Dashboard Modal -->
<div class="modal fade" id="importDashboardModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Import Dashboard</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label class="form-label">Upload Dashboard JSON:</label>
                <input type="file" class="form-control" id="importFileInput" accept=".json">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="processImport()">Import</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/gridstack@8.4.0/dist/gridstack-all.js"></script>
<script>
    let grid;
    let widgetCounter = 0;
    let currentDashboardId = null;

    // Initialize GridStack
    document.addEventListener('DOMContentLoaded', function() {
        grid = GridStack.init({
            column: 12,
            cellHeight: 70,
            margin: 10,
            float: true,
            resizable: {
                handles: 'e, se, s, sw, w'
            }
        });

        // Make widgets draggable from library
        initializeWidgetDragging();

        // Load saved dashboards
        loadDashboards();

        // Load current dashboard if exists
        loadCurrentDashboard();
    });

    // Initialize widget dragging from library
    function initializeWidgetDragging() {
        const widgetItems = document.querySelectorAll('.widget-item');
        widgetItems.forEach(item => {
            item.addEventListener('click', function() {
                const widgetType = this.getAttribute('data-widget-type');
                const widgetName = this.getAttribute('data-widget-name');
                addWidget(widgetType, widgetName);
            });
        });
    }

    // Add widget to grid
    function addWidget(type, name) {
        widgetCounter++;
        const widgetId = `widget-${widgetCounter}`;

        const widgetContent = generateWidgetContent(type, name, widgetId);

        grid.addWidget({
            w: 4,
            h: 3,
            content: widgetContent,
            id: widgetId
        });

        // Initialize charts if needed
        if (type.includes('chart')) {
            setTimeout(() => initializeChart(widgetId, type), 100);
        }
    }

    // Generate widget content based on type
    function generateWidgetContent(type, name, id) {
        let body = '';

        switch(type) {
            case 'metric-card':
                body = `
                    <div class="metric-card">
                        <h3>${Math.floor(Math.random() * 100)}%</h3>
                        <p class="mb-0">${name}</p>
                    </div>
                `;
                break;
            case 'line-chart':
            case 'bar-chart':
            case 'pie-chart':
                body = `
                    <div class="chart-container">
                        <canvas id="chart-${id}"></canvas>
                    </div>
                `;
                break;
            case 'activity-feed':
                body = `
                    <div class="list-group list-group-flush">
                        <div class="list-group-item"><i class="fas fa-check text-success"></i> Task completed</div>
                        <div class="list-group-item"><i class="fas fa-info text-info"></i> System update</div>
                        <div class="list-group-item"><i class="fas fa-warning text-warning"></i> Warning detected</div>
                    </div>
                `;
                break;
            case 'error-log':
                body = `
                    <div class="list-group list-group-flush">
                        <div class="list-group-item text-danger"><i class="fas fa-times"></i> Error in module A</div>
                        <div class="list-group-item text-warning"><i class="fas fa-exclamation"></i> Warning in module B</div>
                    </div>
                `;
                break;
            case 'alert-list':
                body = `
                    <div class="list-group list-group-flush">
                        <div class="list-group-item"><span class="badge bg-danger">Critical</span> High CPU usage</div>
                        <div class="list-group-item"><span class="badge bg-warning">Warning</span> Memory threshold</div>
                    </div>
                `;
                break;
            default:
                body = `<p>${name}</p>`;
        }

        return `
            <div class="widget-header">
                <span>${name}</span>
                <button class="btn btn-sm text-white" onclick="removeWidget('${id}')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="widget-body">
                ${body}
            </div>
        `;
    }

    // Initialize chart
    function initializeChart(widgetId, type) {
        const canvas = document.getElementById(`chart-${widgetId}`);
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        const chartType = type.replace('-chart', '');

        new Chart(ctx, {
            type: chartType,
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'],
                datasets: [{
                    label: 'Data',
                    data: [65, 59, 80, 81, 56],
                    backgroundColor: 'rgba(102, 126, 234, 0.2)',
                    borderColor: 'rgba(102, 126, 234, 1)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }

    // Remove widget
    function removeWidget(widgetId) {
        const element = document.getElementById(widgetId);
        if (element) {
            grid.removeWidget(element);
        }
    }

    // Save dashboard
    function saveDashboard() {
        const name = document.getElementById('dashboardName').value || 'Untitled Dashboard';
        const serializedData = grid.save();

        const dashboard = {
            id: currentDashboardId || Date.now().toString(),
            name: name,
            widgets: serializedData,
            columns: parseInt(document.getElementById('gridColumns').value),
            spacing: parseInt(document.getElementById('gridSpacing').value),
            created_at: currentDashboardId ? undefined : new Date().toISOString(),
            updated_at: new Date().toISOString()
        };

        fetch('/api/dashboards/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dashboard)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentDashboardId = dashboard.id;
                    showAlert('success', 'Dashboard saved successfully!');
                }
            })
            .catch(error => {
                console.error('Error saving dashboard:', error);
                showAlert('danger', 'Failed to save dashboard.');
            });
    }

    // Load dashboards
    function loadDashboards() {
        fetch('/api/dashboards/list')
            .then(response => response.json())
            .then(data => {
                const dashboardList = document.getElementById('dashboardList');
                if (data.dashboards && data.dashboards.length > 0) {
                    let html = '';
                    data.dashboards.forEach(dashboard => {
                        html += `
                            <div class="dashboard-card ${dashboard.id === currentDashboardId ? 'active' : ''}" onclick="loadDashboard('${dashboard.id}')">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">${dashboard.name}</h6>
                                        <small class="text-muted">
                                            Updated: ${new Date(dashboard.updated_at).toLocaleDateString()}
                                        </small>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteDashboard('${dashboard.id}', event)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    dashboardList.innerHTML = html;
                } else {
                    dashboardList.innerHTML = '<p class="text-muted text-center">No saved dashboards</p>';
                }
            });
    }

    // Load dashboard
    function loadDashboard(dashboardId) {
        fetch(`/api/dashboards/${dashboardId}`)
            .then(response => response.json())
            .then(data => {
                if (data.dashboard) {
                    currentDashboardId = dashboardId;
                    document.getElementById('dashboardName').value = data.dashboard.name;
                    document.getElementById('gridColumns').value = data.dashboard.columns || 12;
                    document.getElementById('gridSpacing').value = data.dashboard.spacing || 10;

                    // Clear and load widgets
                    grid.removeAll();
                    grid.load(data.dashboard.widgets);

                    // Reinitialize charts
                    setTimeout(() => {
                        data.dashboard.widgets.forEach(widget => {
                            const type = widget.content.includes('line-chart') ? 'line-chart' :
                                        widget.content.includes('bar-chart') ? 'bar-chart' :
                                        widget.content.includes('pie-chart') ? 'pie-chart' : null;
                            if (type) {
                                initializeChart(widget.id, type);
                            }
                        });
                    }, 200);

                    // Close modal
                    bootstrap.Modal.getInstance(document.getElementById('dashboardManagerModal')).hide();
                    showAlert('success', `Dashboard "${data.dashboard.name}" loaded successfully!`);
                }
            });
    }

    // Delete dashboard
    function deleteDashboard(dashboardId, event) {
        event.stopPropagation();
        if (!confirm('Are you sure you want to delete this dashboard?')) return;

        fetch(`/api/dashboards/${dashboardId}`, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadDashboards();
                    showAlert('success', 'Dashboard deleted successfully!');
                }
            });
    }

    // Clear grid
    function clearGrid() {
        if (confirm('Are you sure you want to clear all widgets?')) {
            grid.removeAll();
        }
    }

    // Export dashboard
    function exportDashboard() {
        const name = document.getElementById('dashboardName').value || 'dashboard';
        const serializedData = grid.save();
        const dashboard = {
            name: name,
            widgets: serializedData,
            columns: parseInt(document.getElementById('gridColumns').value),
            spacing: parseInt(document.getElementById('gridSpacing').value),
            exported_at: new Date().toISOString()
        };

        const blob = new Blob([JSON.stringify(dashboard, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${name.replace(/\s+/g, '-').toLowerCase()}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    // Import dashboard
    function importDashboard() {
        new bootstrap.Modal(document.getElementById('importDashboardModal')).show();
    }

    function processImport() {
        const fileInput = document.getElementById('importFileInput');
        const file = fileInput.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const dashboard = JSON.parse(e.target.result);
                document.getElementById('dashboardName').value = dashboard.name;
                document.getElementById('gridColumns').value = dashboard.columns || 12;
                document.getElementById('gridSpacing').value = dashboard.spacing || 10;
                grid.removeAll();
                grid.load(dashboard.widgets);
                bootstrap.Modal.getInstance(document.getElementById('importDashboardModal')).hide();
                showAlert('success', 'Dashboard imported successfully!');
            } catch (error) {
                showAlert('danger', 'Invalid dashboard file.');
            }
        };
        reader.readAsText(file);
    }

    // Change grid columns
    function changeGridColumns() {
        const columns = parseInt(document.getElementById('gridColumns').value);
        grid.column(columns);
    }

    // Change grid spacing
    function changeGridSpacing() {
        const spacing = parseInt(document.getElementById('gridSpacing').value);
        grid.margin(spacing);
    }

    // Toggle widget library
    function toggleWidgetLibrary() {
        const sidebar = document.getElementById('widgetLibrarySidebar');
        const container = document.getElementById('dashboardGridContainer');

        if (sidebar.classList.contains('d-none')) {
            sidebar.classList.remove('d-none');
            container.classList.remove('col-md-12');
            container.classList.add('col-md-9');
        } else {
            sidebar.classList.add('d-none');
            container.classList.remove('col-md-9');
            container.classList.add('col-md-12');
        }
    }

    // Show dashboard manager
    function showDashboardManager() {
        loadDashboards();
        new bootstrap.Modal(document.getElementById('dashboardManagerModal')).show();
    }

    // Create new dashboard
    function createNewDashboard() {
        currentDashboardId = null;
        document.getElementById('dashboardName').value = 'New Dashboard';
        grid.removeAll();
        bootstrap.Modal.getInstance(document.getElementById('dashboardManagerModal')).hide();
        showAlert('success', 'New dashboard created!');
    }

    // Load current dashboard on page load
    function loadCurrentDashboard() {
        fetch('/api/dashboards/current')
            .then(response => response.json())
            .then(data => {
                if (data.dashboard) {
                    loadDashboard(data.dashboard.id);
                }
            });
    }

    // Show alert
    function showAlert(type, message) {
        const alertContainer = document.getElementById('alertContainer');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        alertContainer.appendChild(alert);
        setTimeout(() => alert.remove(), 5000);
    }
</script>
{% endblock %}
