{% extends "base.html" %}

{% block title %}Analytics - Claude Insight{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>Advanced Analytics Dashboard
                </h2>
                <p class="text-muted mt-2">Deep insights into system performance and trends</p>
            </div>

            <!-- Time Range Filter -->
            <div class="btn-group" role="group">
                <a href="?days=7" class="btn btn-sm btn-outline-primary {{ 'active' if selected_days == 7 else '' }}">
                    7 Days
                </a>
                <a href="?days=30" class="btn btn-sm btn-outline-primary {{ 'active' if selected_days == 30 else '' }}">
                    30 Days
                </a>
                <a href="?days=60" class="btn btn-sm btn-outline-primary {{ 'active' if selected_days == 60 else '' }}">
                    60 Days
                </a>
                <a href="?days=90" class="btn btn-sm btn-outline-primary {{ 'active' if selected_days == 90 else '' }}">
                    90 Days
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Key Metrics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1 small">Avg Health Score</p>
                        <h3 class="mb-0 text-success">{{ summary_stats.avg_health_score }}%</h3>
                        <small class="text-{{ 'success' if analytics_data.health_trend.direction == 'up' else ('danger' if analytics_data.health_trend.direction == 'down' else 'muted') }}">
                            <i class="fas fa-arrow-{{ 'up' if analytics_data.health_trend.direction == 'up' else ('down' if analytics_data.health_trend.direction == 'down' else 'right') }} me-1"></i>
                            {{ analytics_data.health_trend.percentage }}% vs previous period
                        </small>
                    </div>
                    <div class="text-success">
                        <i class="fas fa-heartbeat fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1 small">Total Errors</p>
                        <h3 class="mb-0 text-danger">{{ summary_stats.total_errors }}</h3>
                        <small class="text-{{ 'danger' if analytics_data.error_trend.direction == 'up' else ('success' if analytics_data.error_trend.direction == 'down' else 'muted') }}">
                            <i class="fas fa-arrow-{{ 'up' if analytics_data.error_trend.direction == 'up' else ('down' if analytics_data.error_trend.direction == 'down' else 'right') }} me-1"></i>
                            {{ analytics_data.error_trend.percentage }}% vs previous period
                        </small>
                    </div>
                    <div class="text-danger">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1 small">Daemon Uptime</p>
                        <h3 class="mb-0 text-info">{{ analytics_data.daemon_uptime }}%</h3>
                        <small class="text-muted">
                            <i class="fas fa-server me-1"></i>
                            All systems operational
                        </small>
                    </div>
                    <div class="text-info">
                        <i class="fas fa-server fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1 small">Policy Effectiveness</p>
                        <h3 class="mb-0 text-primary">{{ analytics_data.policy_effectiveness.effectiveness }}%</h3>
                        <small class="text-muted">
                            <i class="fas fa-shield-alt me-1"></i>
                            {{ analytics_data.policy_effectiveness.total_interventions }} interventions
                        </small>
                    </div>
                    <div class="text-primary">
                        <i class="fas fa-shield-alt fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Trend Analysis Charts -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0">
                    <i class="fas fa-chart-area me-2"></i>Health Score Trend
                </h5>
            </div>
            <div class="card-body">
                <canvas id="healthTrendChart" height="250"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Error Distribution
                </h5>
            </div>
            <div class="card-body">
                <canvas id="errorDistributionChart" height="250"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Cost Analysis & Policy Impact -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0">
                    <i class="fas fa-dollar-sign me-2"></i>Cost Analysis
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center mb-4">
                    <div class="col-4">
                        <div class="p-3 bg-light rounded">
                            <h4 class="text-danger mb-1">${{ analytics_data.cost_analysis.before.cost }}</h4>
                            <small class="text-muted">Before</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="p-3 bg-success bg-opacity-10 rounded">
                            <h4 class="text-success mb-1">${{ analytics_data.cost_analysis.after.cost }}</h4>
                            <small class="text-muted">After</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="p-3 bg-primary bg-opacity-10 rounded">
                            <h4 class="text-primary mb-1">${{ analytics_data.cost_analysis.savings.cost }}</h4>
                            <small class="text-muted">Saved</small>
                        </div>
                    </div>
                </div>

                <div class="progress mb-3" style="height: 30px;">
                    <div class="progress-bar bg-success" role="progressbar"
                         style="width: {{ analytics_data.cost_analysis.savings.percent }}%">
                        {{ analytics_data.cost_analysis.savings.percent }}% Reduction
                    </div>
                </div>

                <canvas id="costComparisonChart" height="200"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0">
                    <i class="fas fa-shield-alt me-2"></i>Policy Impact Analysis
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Context Optimizations</span>
                        <strong>{{ analytics_data.optimization_impact.context_optimizations }}</strong>
                    </div>
                    <div class="progress mb-3" style="height: 10px;">
                        <div class="progress-bar bg-warning" role="progressbar"
                             style="width: {{ (analytics_data.optimization_impact.context_optimizations / (analytics_data.optimization_impact.total_optimizations or 1) * 100) }}%"></div>
                    </div>

                    <div class="d-flex justify-content-between mb-2">
                        <span>Failures Prevented</span>
                        <strong>{{ analytics_data.optimization_impact.failures_prevented }}</strong>
                    </div>
                    <div class="progress mb-3" style="height: 10px;">
                        <div class="progress-bar bg-success" role="progressbar"
                             style="width: {{ (analytics_data.optimization_impact.failures_prevented / (analytics_data.optimization_impact.total_optimizations or 1) * 100) }}%"></div>
                    </div>

                    <div class="d-flex justify-content-between mb-2">
                        <span>Model Selections</span>
                        <strong>{{ analytics_data.optimization_impact.model_selections }}</strong>
                    </div>
                    <div class="progress mb-3" style="height: 10px;">
                        <div class="progress-bar bg-info" role="progressbar"
                             style="width: {{ (analytics_data.optimization_impact.model_selections / (analytics_data.optimization_impact.total_optimizations or 1) * 100) }}%"></div>
                    </div>
                </div>

                <canvas id="policyImpactChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Usage Patterns -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0">
                    <i class="fas fa-clock me-2"></i>Usage Patterns
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-4">
                        <div class="p-4 bg-light rounded">
                            <i class="fas fa-sun fa-3x text-warning mb-3"></i>
                            <h5>Peak Hour</h5>
                            <p class="text-muted mb-0">{{ analytics_data.peak_hours.peak_hour }}</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-4 bg-light rounded">
                            <i class="fas fa-calendar-day fa-3x text-primary mb-3"></i>
                            <h5>Busiest Day</h5>
                            <p class="text-muted mb-0">{{ analytics_data.peak_hours.peak_day }}</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-4 bg-light rounded">
                            <i class="fas fa-chart-line fa-3x text-success mb-3"></i>
                            <h5>Peak Period</h5>
                            <p class="text-muted mb-0">{{ analytics_data.peak_hours.busiest_period }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export Options -->
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4 pb-3">
                <h5 class="mb-0">
                    <i class="fas fa-download me-2"></i>Export Analytics Report
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex gap-3 flex-wrap">
                    <a href="/api/export/excel/analytics" class="btn btn-success">
                        <i class="fas fa-file-excel me-2"></i>Export to Excel
                    </a>
                    <a href="/api/export/pdf/analytics" class="btn btn-danger">
                        <i class="fas fa-file-pdf me-2"></i>Export to PDF
                    </a>
                    <a href="/api/export/sessions" class="btn btn-primary">
                        <i class="fas fa-file-csv me-2"></i>Export Sessions (CSV)
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
const chartData = {{ chart_data | tojson | safe }};

// Health Trend Chart
const healthCtx = document.getElementById('healthTrendChart').getContext('2d');
new Chart(healthCtx, {
    type: 'line',
    data: {
        labels: chartData.dates.map(date => {
            const d = new Date(date);
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }),
        datasets: [{
            label: 'Health Score',
            data: chartData.health_scores,
            borderColor: 'rgb(16, 185, 129)',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } }
    }
});

// Error Distribution Chart
const errorCtx = document.getElementById('errorDistributionChart').getContext('2d');
new Chart(errorCtx, {
    type: 'bar',
    data: {
        labels: chartData.dates.map(date => {
            const d = new Date(date);
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }),
        datasets: [{
            label: 'Errors',
            data: chartData.errors,
            backgroundColor: 'rgba(239, 68, 68, 0.7)',
            borderColor: 'rgb(239, 68, 68)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } }
    }
});

// Cost Comparison Chart
const costCtx = document.getElementById('costComparisonChart').getContext('2d');
new Chart(costCtx, {
    type: 'doughnut',
    data: {
        labels: ['Saved', 'Current Cost'],
        datasets: [{
            data: [{{ analytics_data.cost_analysis.savings.cost }}, {{ analytics_data.cost_analysis.after.cost }}],
            backgroundColor: ['rgb(16, 185, 129)', 'rgb(102, 126, 234)'],
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false
    }
});

// Policy Impact Chart
const policyCtx = document.getElementById('policyImpactChart').getContext('2d');
new Chart(policyCtx, {
    type: 'pie',
    data: {
        labels: ['Context Optimizations', 'Failures Prevented', 'Model Selections'],
        datasets: [{
            data: [
                {{ analytics_data.optimization_impact.context_optimizations }},
                {{ analytics_data.optimization_impact.failures_prevented }},
                {{ analytics_data.optimization_impact.model_selections }}
            ],
            backgroundColor: ['rgb(245, 158, 11)', 'rgb(16, 185, 129)', 'rgb(59, 130, 246)'],
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false
    }
});
</script>

<style>
.card {
    transition: transform 0.2s;
}

.card:hover {
    transform: translateY(-5px);
}

.progress {
    border-radius: 10px;
}

.progress-bar {
    border-radius: 10px;
}

.bg-opacity-10 {
    --bs-bg-opacity: 0.1;
}
</style>
{% endblock %}
